<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lecture 13: Tournament Simulation – STAT479</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-4bfb630b09c0e164834af1bb3207dbff.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">STAT479</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../syllabus.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-lecture-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Lecture Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-lecture-notes">    
        <li>
    <a class="dropdown-item" href="../lectures/lecture00.html">
 <span class="dropdown-text">Lecture 0: Boxscore Metrics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture02.html">
 <span class="dropdown-text">Lecture 2: Expected Goals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture03.html">
 <span class="dropdown-text">Lecture 3: Estimating XG</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture04.html">
 <span class="dropdown-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture05.html">
 <span class="dropdown-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture06.html">
 <span class="dropdown-text">Lecture 6: Run Expectancy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture07.html">
 <span class="dropdown-text">Lecture 7: Offensive Credit Allocation in Baseball</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture08.html">
 <span class="dropdown-text">Lecture 8: Defensive Credit Allocation in Baseball</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture09.html">
 <span class="dropdown-text">Lecture 9: Multilevel Modeling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture10.html">
 <span class="dropdown-text">Lecture 10: NFl WAR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture11.html">
 <span class="dropdown-text">Lecture 11: Pitch Framing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture12.html">
 <span class="dropdown-text">Lecture 12: Bradley-Terry Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture13.html">
 <span class="dropdown-text">Lecture 13: Tournament Simulation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture14.html">
 <span class="dropdown-text">Lecture 14: Markov Chains I</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture15.html">
 <span class="dropdown-text">Lecture 15: Markov Chains II</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture16.html">
 <span class="dropdown-text">Lecture 16: Plackett-Luce Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture17.html">
 <span class="dropdown-text">Lecture 17: NFL Drive Simulation</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-lecture-slides" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Lecture Slides</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-lecture-slides">    
        <li>
    <a class="dropdown-item" href="../slides/lecture01.html">
 <span class="dropdown-text">Lecture 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture02.html">
 <span class="dropdown-text">Lecture 2: Expected Goals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture03.html">
 <span class="dropdown-text">Lecture 3: Estimating XG</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture04.html">
 <span class="dropdown-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture05.html">
 <span class="dropdown-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture06.html">
 <span class="dropdown-text">Lecture 6: Expected Runs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture07.html">
 <span class="dropdown-text">Lecture 7: Offensive Credit</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture08.html">
 <span class="dropdown-text">Lecture 8: Defensive Credit Allocation &amp; WAR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture09.html">
 <span class="dropdown-text">Lecture 9: Multilevel Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture10.html">
 <span class="dropdown-text">Lecture 10: NFL WAR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture11.html">
 <span class="dropdown-text">Lecture 11: Pitch Framing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture12.html">
 <span class="dropdown-text">Lecture 12: Bradley-Terry Models I</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture13.html">
 <span class="dropdown-text">Lecture 13: Bradley-Terry Models II</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture14.html">
 <span class="dropdown-text">Lecture 14: Markov Chains I</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture15.html">
 <span class="dropdown-text">Lecture 15: Markov Chains II</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture16.html">
 <span class="dropdown-text">Lecture 16: Plackett-Luce Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture17.html">
 <span class="dropdown-text">Lecture 17</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../project1.html"> 
<span class="menu-text">Project 1 Information</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../project2.html"> 
<span class="menu-text">Project 2 Information</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../project3.html"> 
<span class="menu-text">Project 3 Information</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../lectures/lecture13.html">Lecture 13: Tournament Simulation</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 0: Boxscore Metrics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 2: Expected Goals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 3: Estimating XG</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 6: Run Expectancy</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 7: Offensive Credit Allocation in Baseball</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 8: Defensive Credit Allocation in Baseball</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 9: Multilevel Modeling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 10: NFl WAR</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 11: Pitch Framing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 12: Bradley-Terry Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture13.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Lecture 13: Tournament Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 14: Markov Chains I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 15: Markov Chains II</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 16: Plackett-Luce Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture17.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 17: NFL Drive Simulation</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#sec-bt-home" id="toc-sec-bt-home" class="nav-link" data-scroll-target="#sec-bt-home">Bradley-Terry Models with Home-Court Advantage</a></li>
  <li><a href="#sec-data-prep" id="toc-sec-data-prep" class="nav-link" data-scroll-target="#sec-data-prep">Data Preparation</a>
  <ul class="collapse">
  <li><a href="#determining-location" id="toc-determining-location" class="nav-link" data-scroll-target="#determining-location">Determining Location</a></li>
  </ul></li>
  <li><a href="#sec-fit" id="toc-sec-fit" class="nav-link" data-scroll-target="#sec-fit">Fitting Our Model</a></li>
  <li><a href="#sec-frozen4" id="toc-sec-frozen4" class="nav-link" data-scroll-target="#sec-frozen4">Frozen 4 Simulation</a>
  <ul class="collapse">
  <li><a href="#sec-simulation-orig" id="toc-sec-simulation-orig" class="nav-link" data-scroll-target="#sec-simulation-orig">Simulating the Original Tournament</a></li>
  <li><a href="#sec-simulation-alt" id="toc-sec-simulation-alt" class="nav-link" data-scroll-target="#sec-simulation-alt">Simulating an Alternative Tournament</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lecture 13: Tournament Simulation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>In <a href="../lectures/lecture12.html">Lecture 12</a>, we used a Bradley-Terry model to estimate the latent strength of each Division I women’s ice hockey team. The model posits that the log-odds of one team beating the other is simply the difference in these latent strengths. According to our model estimates, the Wisconsin Badgers and Ohio State Buckeyes were ranked 1st and 2nd among all teams. Using the estimated model parameters, we simulated a “best-of-5” series between the two teams, finding that Wisconsin was predicted to win such a series about 91% of the time.</p>
<p>One major drawback of our initial model is that it fails to account for any potential home-court advantage. In other words, it assumes that the probability that Wisconsin beats Ohio State is the same whether the game was played at <a href="https://uwbadgers.com/sports/2015/8/21/GEN_2014010136.aspx">La Bahn Arena</a> (the home of the Wisconin Badgers), the <a href="https://en.wikipedia.org/wiki/Ohio_State_University_Ice_Rink">Ohio State University Ice Rink</a>, or at a neutral site.</p>
<p>In this lecture, we fit a refined version of the Bradley-Terry model that accounts for location. We introduce this model in <a href="#sec-bt-home" class="quarto-xref">Section&nbsp;2</a> and perform the necessary pre-processing in <a href="#sec-data-prep" class="quarto-xref">Section&nbsp;3</a>. Then, in <a href="#sec-fit" class="quarto-xref">Section&nbsp;4</a>, we fit the model using the <strong>BradleyTerry2</strong> package and examine the resulting power rankings. Finally, in <a href="#sec-frozen4" class="quarto-xref">Section&nbsp;5</a> we simulate the semi-finals and finals of the 2025 NCAA Tournament under several different scenarios.</p>
<p>Before proceeding, we load in the data table containing all regular season Division I women’s ice hockey games from the 2024-25 season that did not end in ties.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"wd1hockey_regseason_2024_2025.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-bt-home" class="level2">
<h2 class="anchored" data-anchor-id="sec-bt-home">Bradley-Terry Models with Home-Court Advantage</h2>
<p>Like the <a href="../lectures/lecture12.html#sec-bt-def">basic model from Lecture 12</a>, we will associate a latent parameter <span class="math inline">\(\lambda_{j}\)</span> to each team <span class="math inline">\(j = 1, \ldots, p.\)</span> We will also fix one <span class="math inline">\(\lambda_{j} = 0\)</span>, corresponding to a pre-specified reference team<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. In addition to the latent team strengths <span class="math inline">\(\lambda_{1}, \ldots, \lambda_{p},\)</span> we will introduce an additional parameter <span class="math inline">\(\lambda_{0}\)</span> that accounts for a systematic home advantage.</p>
<p>Now suppose that the home team <span class="math inline">\(H\)</span> plays an away team <span class="math inline">\(A\)</span> at team <span class="math inline">\(H\)</span>’s home. Our augmented Bradley-Terry model asserts that the log-odds that <span class="math inline">\(H\)</span> beats <span class="math inline">\(A\)</span> is <span class="math inline">\(\lambda_{0} + \lambda_{H} - \lambda_{A}.\)</span> Equivalently, our augmented model asserts that <span class="math display">\[
\mathbb{P}(\textrm{team H beats team A at H's home}) = \frac{e^{\lambda_{H} + \lambda_{0}}}{e^{\lambda_{H} + \lambda_{0}} + e^{\lambda_{A}}}.
\]</span> Compared to the original Bradley-Terry model we considered in <a href="../lectures/lecture12.html#sec-bt-def">Lecture 12</a>, our new model gives a systematic advantage to the home team. For any two teams <span class="math inline">\(i\)</span> and <span class="math inline">\(j,\)</span> our original Bradley-Terry model assumes that the probability of team <span class="math inline">\(i\)</span> beating team <span class="math inline">\(j\)</span> is the same across all locations. Under our new model, the model makes a different prediction depending on location: the log-odds of <span class="math inline">\(i\)</span> beating <span class="math inline">\(j\)</span> are</p>
<ul>
<li><span class="math inline">\(\lambda_{0} + \lambda_{i} - \lambda_{j}\)</span>: if the game is played at <span class="math inline">\(i\)</span>’s home arena</li>
<li><span class="math inline">\(-\lambda_{0} + \lambda_{i} - \lambda_{j}\)</span>: if the game is played at <span class="math inline">\(j\)</span>’s home arena</li>
<li><span class="math inline">\(\lambda_{i} - \lambda_{j}\)</span>: if the game is played at a neutral site (i.e., not at <span class="math inline">\(i\)</span>’s or <span class="math inline">\(j\)</span>’s home arena)</li>
</ul>
<p>To derive the log-odds of <span class="math inline">\(i\)</span> beating <span class="math inline">\(j\)</span> at <span class="math inline">\(j\)</span>’s home arena, note that according to our model <span class="math display">\[
\mathbb{P}(\textrm{team j beats i at j's home}) = \frac{e^{\lambda_{j} + \lambda_{0}}}{e^{\lambda_{j} + \lambda_{0}} + e^{\lambda_{i}}}.
\]</span> Thus <span class="math display">\[
\begin{align}
\mathbb{P}(\textrm{team i beats j at j's home}) &amp;= \frac{e^{\lambda_{i}}}{e^{\lambda_{j} + \lambda_{0}} + e^{\lambda_{i}}} \\
&amp;= \frac{1}{e^{\lambda_{j} + \lambda_{0} - \lambda_{i}} + 1} \\
&amp;= \frac{1}{1 + e^{-1 \times (-\lambda_{0} + \lambda_{i} - \lambda_{j})}}.
\end{align}
\]</span></p>
</section>
<section id="sec-data-prep" class="level2">
<h2 class="anchored" data-anchor-id="sec-data-prep">Data Preparation</h2>
<p>Unfortunately, the data table we scraped from USCHO does not record the location of the game. USCHO publishes box scores for individual games on separate webpages with highly structured URLs. For instance, the URL for the webpage with the box score from the championship game between the Badgers and Buckeyes is</p>
<pre><code>https://www.uscho.com/gameday/division-i-women/2024-2025/2025-03-23/game-7949/</code></pre>
<p>Notice that after the date there is a unique game identifier (7949 in this case). Based on this, it is tempting to write a function that visits each individual site (e.g., by looping over the unique game ID’s). Unfortunately, this strategy requires us to determine the unique game identifiers, which is not entirely straightforward. We instead manually impute the location information with some heuristics.</p>
<section id="determining-location" class="level3">
<h3 class="anchored" data-anchor-id="determining-location">Determining Location</h3>
<p>We will assume all non-tournament conference games and most tournament games are played at the home arena of the listed home team and not at a neutral site. For instance, there were four games in <a href="https://hockeycommissioners.com/ice-breaker/womens-ice-breaker.php">Icebreaker</a> tournament featured four games:</p>
<ul>
<li>Penn State vs Cornell (<a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2024-10-25/game-6337/">boxscore</a>)</li>
<li>Stonehill vs Ohio State (<a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2024-10-25/game-6338/">boxscore</a>)</li>
<li>Cornell vs Ohio State (<a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2024-10-26/game-6342/">boxscore</a>)</li>
<li>Stonehill vs Penn State (<a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2024-10-26/game-6340/">boxscore</a>)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>no_ties <span class="sc">|&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"IceBreaker"</span>, Notes)) <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Date, Opponent, Home, Notes, Type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  Date       Opponent   Home       Notes      Type 
  &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;
1 10/25/2024 Penn State Cornell    IceBreaker NC   
2 10/25/2024 Stonehill  Ohio State IceBreaker NC   
3 10/26/2024 Cornell    Ohio State IceBreaker NC   
4 10/26/2024 Stonehill  Penn State IceBreaker NC   </code></pre>
</div>
</div>
<p>Inspecting the box scores pages for all four games, we see that they were all played at <a href="https://en.wikipedia.org/wiki/Value_City_Arena">Value City Arena</a>. Although this is located at the Ohio State University — and is the home arena of their men’s ice hockey team — it is not the home arena of the women’s ice hockey team. For the purposes of our analysis, we will assume that the games in this tournament are played at a neutral site.</p>
<p>To record whether the game was played at the home arena of <code>Home</code> or at a neutral site, we will first identify all tournaments by pulling out the unique values in <code>Notes</code> that do not include the string <code>"SO"</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>unik_notes <span class="ot">&lt;-</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  no_ties <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Notes) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">grepl</span>(<span class="st">"SO"</span>, Notes)) <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(Notes) <span class="sc">|&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>unik_notes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "IceBreaker"          "Nutmeg Classic"      "Smashville Showcase"
 [4] "Mayor's Cup"         "East/West Classic"   "Beanpot"            
 [7] "ECAC Tournament"     "AHA Tournament"      "HEA Tournament"     
[10] "WCHA Tournament"     "NEWHA Tournament"   </code></pre>
</div>
</div>
<p>We then manually inspect the box scores for each of the tournaments to determine whether they were played at any of the team’s home arena. We find * The East/West Classic was played at <a href="https://en.wikipedia.org/wiki/Ridder_Arena">Ridder Arena</a>, which is the home arena of Minnesota. So, we will treat the the games between <a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2025-01-03/game-6120/">Penn State and Bemidji State</a> and between <a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2025-01-04/game-6122/">Brown and Bemidji State</a> as being played at a neutral site. But we will treat the games involving Minneosta as being played at their home arena. * The Nutmeg Classic was played at <a href="https://www.sacredheart.edu/sacred-heart-life/fitness-recreation--sports/martire-family-arena/">Martire Family Arena</a>, which is the home arena of Sacred Heart. So, we will treat games from this tournament that do not involve Sacred Heart can be considered a neutral site game. * The <a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2024-11-30/game-6116/">Mayor’s Cup game between Brown and Providence</a> was played at <a href="https://friars.com/facilities/schneider-arena/6">Schneider Arena</a>, which is the home arena of Providence. * The <a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2025-01-25/game-6207/">Mayor’s Cup game between Union and RPI</a> was played at <a href="https://en.wikipedia.org/wiki/MVP_Arena">MVP Arena</a>, which is a neutral site * All games in the Smashville Showcase were played at a neutral site: they were played at the Ford Ice Center, which is not the home arena of any of St.&nbsp;Thomas, Merrimack, Clarkson, or Penn State. * The Beanpot games between <a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2025-01-14/game-6170/">Boston University and Harvard</a> and <a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2025-01-14/game-6169/">Boston College and Northeastern</a> were played at <a href="https://en.wikipedia.org/wiki/Matthews_Arena">Matthews Arena</a>, which is the home arena of Northeastern. The games between <a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2025-01-21/game-6173/">Boston College and Harvard</a> and <a href="https://www.uscho.com/gameday/division-i-women/2024-2025/2025-01-21/game-6172/">Boston University and Northeastern</a> were played at the T.D. Garden, which is a neutral site.</p>
<p>Generally speaking, most conference tournament games were played at the home arena of the listed home team. We find that:</p>
<ul>
<li>All games in the <a href="https://www.newhaonline.com/Tournament/2025_NEWHA_Tournament">NEWHA</a>, and <a href="https://atlantichockeyamerica.com/tournaments/?id=42&amp;sport=whockey">AHA</a>, and <a href="https://hockeyeastonline.com/women/hockey-east-tournament/index.php">HEA</a> tournaments were played at the higher-ranked seeds home arena. So, none of these tournament games were played at a neutral site.</li>
<li>All but the last three games of the ECAC tournament were held at the listed home team’s home arena. The last three games (St.&nbsp;Lawrence vs Colgate, Clarkson vs Cornell, and Colgate vs Cornell) were held at Cornell’s home arena. So only the March 7, 2025 game between St.&nbsp;Lawrence and Colgate was held at a neutral site.</li>
<li>All the but last three games of the WHCA tournament were held at the listed home team’s home arena. The last three (Minnesota vs Ohio State State, Minnesota Duluth vs Wisconsin, and Minnesota vs Wisconsin) were held at Minneosta Duluth’s home arena. So, the March 7, 2025 game between Minnesota and Ohio State and the March 8, 2025 game between Minnesota and Wisconsin were held at a neutral site.</li>
</ul>
<p>Based on these findings, we create a new variable in <code>no_ties</code>, which records whether the game was played at a neutral site.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>no_ties <span class="ot">&lt;-</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  no_ties <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">neutral =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"IceBreaker"</span>, Notes) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"East/West"</span>, Notes) <span class="sc">&amp;</span> Home <span class="sc">!=</span> <span class="st">"Minnesota"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"Nutmeg"</span>, Notes) <span class="sc">&amp;</span> Home <span class="sc">!=</span> <span class="st">"Sacred Heart"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"Mayor"</span>, Notes) <span class="sc">&amp;</span> Home <span class="sc">==</span> <span class="st">"Rensselaer"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"Smashville"</span>, Notes) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">grepl</span>(<span class="st">"Beanpot"</span>, Notes) <span class="sc">&amp;</span> Home <span class="sc">!=</span> <span class="st">"Northeastern"</span> <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>      Date <span class="sc">==</span> <span class="st">"3/7/2025"</span> <span class="sc">&amp;</span> Home <span class="sc">==</span> <span class="st">"St. Lawrence"</span> <span class="sc">&amp;</span> Opponent <span class="sc">==</span> <span class="st">"Colgate"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>      Date <span class="sc">==</span> <span class="st">"3/7/2025"</span> <span class="sc">&amp;</span> Home <span class="sc">==</span> <span class="st">"Minnesota"</span> <span class="sc">&amp;</span> Opponent <span class="sc">==</span> <span class="st">"Ohio State"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      Date <span class="sc">==</span> <span class="st">"3/8/2025"</span> <span class="sc">&amp;</span> Home <span class="sc">==</span> <span class="st">"Minnesota"</span> <span class="sc">&amp;</span> Opponent <span class="sc">==</span> <span class="st">"Wisconsin"</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="sec-fit" class="level2">
<h2 class="anchored" data-anchor-id="sec-fit">Fitting Our Model</h2>
<p>Recall from <a href="../lectures/lecture12.html#sec-bt-est">Lecture 12</a> that we counted up the number of home and away team wins for every unique combination of home and away teams. Because we now wish to account for potential home advantages, we need to separate these counts based on the game location. To do this, we will subdivide the games in <code>no_ties</code> based on the combination of <code>Home</code>, <code>Opponent</code>, and <code>neutral</code> and count up the numbers of home and away team wins. In the code below, we also rename <code>Home</code> and <code>Opponent</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-6"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a>unik_teams <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">c</span>(no_ties<span class="sc">$</span>Home, no_ties<span class="sc">$</span>Opponent)))</span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-6-3"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span></span>
<span id="annotated-cell-6-4"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a>  no_ties <span class="sc">|&gt;</span></span>
<span id="annotated-cell-6-5"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">home.team =</span> Home, <span class="at">away.team =</span> Opponent) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-6-6"><a href="#annotated-cell-6-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(home.team, away.team, neutral) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-6-7"><a href="#annotated-cell-6-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="annotated-cell-6-8"><a href="#annotated-cell-6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">home.win =</span> <span class="fu">sum</span>(Home_Winner), </span>
<span id="annotated-cell-6-9"><a href="#annotated-cell-6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">away.win =</span> <span class="fu">sum</span>(Opp_Winner), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-6-10"><a href="#annotated-cell-6-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="annotated-cell-6-11"><a href="#annotated-cell-6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">home.team =</span> <span class="fu">factor</span>(home.team, <span class="at">levels =</span> unik_teams), </span>
<span id="annotated-cell-6-12"><a href="#annotated-cell-6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">away.team =</span> <span class="fu">factor</span>(away.team,<span class="at">levels =</span> unik_teams),</span>
<span id="annotated-cell-6-13"><a href="#annotated-cell-6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">home.athome =</span> <span class="fu">ifelse</span>(neutral <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1">1</button><span id="annotated-cell-6-14" class="code-annotation-target"><a href="#annotated-cell-6-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">away.athome =</span> <span class="dv">0</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="14" data-code-annotation="1">This is a bit redundant but is necessary to set up the call to <code>BTm()</code>.</span>
</dd>
</dl>
</div>
</div>
<p>Fitting our more elaborate Bradley-Terry model requires somewhat more complicated syntax. Following the example from <a href="https://cran.r-project.org/web/packages/BradleyTerry2/vignettes/BradleyTerry.html#sec:order">Section 3.3</a> of the package vignette “Bradley-Terry Models in R”, we create a temporary data frame <code>tmp_df</code> containing the numbers of home and away team wins for every combination of <code>home.team</code>, <code>away.team</code>, and <code>neutral</code>. We then add two more columns to this data frame, one for the home team (<code>home.team</code>) and one for the away team (<code>away.team</code>). These columns are themselves data frames<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> with columns recording team identity and whether the team was playing at home.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-7"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-7-1"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a>tmp_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">home.win =</span> results<span class="sc">$</span>home.win, <span class="at">away.win =</span> results<span class="sc">$</span>away.win)</span>
<span id="annotated-cell-7-2"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a>tmp_df<span class="sc">$</span>home.team <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">team =</span> results<span class="sc">$</span>home.team, <span class="at">at.home =</span> results<span class="sc">$</span>home.athome)</span>
<span id="annotated-cell-7-3"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a>tmp_df<span class="sc">$</span>away.team <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">team =</span> results<span class="sc">$</span>away.team, <span class="at">at.home =</span> results<span class="sc">$</span>away.athome)</span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-5"><a href="#annotated-cell-7-5" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span></span>
<span id="annotated-cell-7-6"><a href="#annotated-cell-7-6" aria-hidden="true" tabindex="-1"></a>  BradleyTerry2<span class="sc">::</span><span class="fu">BTm</span>(</span>
<span id="annotated-cell-7-7"><a href="#annotated-cell-7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">cbind</span>(home.win, away.win),</span>
<span id="annotated-cell-7-8"><a href="#annotated-cell-7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">player1 =</span> home.team, <span class="at">player2 =</span> away.team,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1">1</button><span id="annotated-cell-7-9" class="code-annotation-target"><a href="#annotated-cell-7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="sc">~</span> team <span class="sc">+</span> at.home,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="2">2</button><span id="annotated-cell-7-10" class="code-annotation-target"><a href="#annotated-cell-7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">refcat =</span> <span class="st">"New Hampshire"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="3">3</button><span id="annotated-cell-7-11" class="code-annotation-target"><a href="#annotated-cell-7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="st">"team"</span>,</span>
<span id="annotated-cell-7-12"><a href="#annotated-cell-7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> tmp_df) </span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="9" data-code-annotation="1"><code>BTm</code> uses a somewhat non-standard <code>formula</code> interface. This specification tells <code>BTm()</code> to estimate a separate latent strength for each team and a parameter for the home advantage.</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="10" data-code-annotation="2">Manually specify the reference team (whose <span class="math inline">\(\lambda\)</span> is set to 0)</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="11" data-code-annotation="3">The <code>id</code> argument specifies that “team” is the name of the factor used to identity teams</span>
</dd>
</dl>
</div>
</div>
<p>Inspecting the model parameters, we see <span class="math inline">\(\hat{\lambda}_{0} \approx 0.311.\)</span> A change of this magnitude on the log-odds scale corresponds to a change of</p>
<ul>
<li>26% (log-odds of -1) to 33% (log-odds of -0.689)</li>
<li>46% (log-odds of -0.156) to 54% (log-odds of 0.156)</li>
<li>73% (log-odds of 1) to 79% (log-odds of 1.311)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">coef</span>(fit), <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       teamAssumption     teamBemidji State    teamBoston College 
               -4.746                -0.753                 0.885 
teamBoston University             teamBrown          teamClarkson 
                1.135                 0.150                 1.225 
          teamColgate       teamConnecticut           teamCornell 
                2.075                 1.118                 2.636 
        teamDartmouth   teamFranklin Pierce           teamHarvard 
               -0.794                -3.949                -2.171 
       teamHoly Cross        teamLindenwood               teamLIU 
               -0.509                -1.474                -3.077 
            teamMaine        teamMercyhurst         teamMerrimack 
               -0.384                 0.511                -0.781 
        teamMinnesota  teamMinnesota Duluth   teamMinnesota State 
                2.766                 2.180                 0.782 
     teamNortheastern        teamOhio State        teamPenn State 
                1.026                 3.274                 2.026 
             teamPost         teamPrinceton        teamProvidence 
               -4.422                 0.907                 0.660 
       teamQuinnipiac        teamRensselaer               teamRIT 
                1.071                -0.300                -0.220 
    teamRobert Morris      teamSacred Heart        teamSt. Anselm 
               -1.614                -3.339                -4.023 
  teamSt. Cloud State      teamSt. Lawrence     teamSt. Michael's 
                1.288                 1.316                -5.913 
       teamSt. Thomas         teamStonehill          teamSyracuse 
                0.084                -4.174                -0.394 
            teamUnion           teamVermont         teamWisconsin 
               -0.057                -0.565                 4.774 
             teamYale               at.home 
                0.822                 0.311 </code></pre>
</div>
</div>
<p>We can extract the latent team strengths using the <code>BradelyTerry::BTabilities</code> function</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-9"><pre class="sourceCode r code-annotation-code code-with-copy"><code class="sourceCode r"><span id="annotated-cell-9-1"><a href="#annotated-cell-9-1" aria-hidden="true" tabindex="-1"></a>lambda0_hat <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit)[<span class="st">"at.home"</span>]</span>
<span id="annotated-cell-9-2"><a href="#annotated-cell-9-2" aria-hidden="true" tabindex="-1"></a>lambda_hat <span class="ot">&lt;-</span> BradleyTerry2<span class="sc">::</span><span class="fu">BTabilities</span>(fit)</span>
<span id="annotated-cell-9-3"><a href="#annotated-cell-9-3" aria-hidden="true" tabindex="-1"></a>lambda_hat[<span class="fu">c</span>(<span class="st">"Wisconsin"</span>, <span class="st">"Ohio State"</span>),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            ability      s.e.
Wisconsin  4.773946 0.9995582
Ohio State 3.273501 0.7936477</code></pre>
</div>
</div>
<p>According to our model, if <span class="math inline">\(\lambda_{WIS}\)</span> and <span class="math inline">\(\lambda_{OSU}\)</span> are Wisconsin’s and Ohio States’ latent strength, then the log-odds of Wisconsin beating Ohio State are</p>
<ul>
<li>If Wisconsin is at home: <span class="math inline">\(\lambda_{WIS} - \lambda_{OSU} + \lambda_{0}\)</span></li>
<li>If Ohio State is at home: <span class="math inline">\(\lambda_{WIS} - \lambda_{OSU} - \lambda_{0}\)</span></li>
<li>If the game is at a neutral site: <span class="math inline">\(\lambda_{WIS} - \lambda_{OSU}.\)</span></li>
</ul>
<p>Using the estimates <span class="math inline">\(\hat{\lambda}_{0} \approx 0.311, \hat{\lambda}_{WIS} \approx 4.774,\)</span> and <span class="math inline">\(\hat{\lambda}_{OSU} \approx 3.274,\)</span> the probabilities that Wisconsin beats Ohio State are</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>At WIS: 85.95 %</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>AT OSU: 76.67 %</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>AT neutral site: 81.76 %</code></pre>
</div>
</div>
<p><a href="#fig-lambda-hat" class="quarto-xref">Figure&nbsp;1</a> shows the estimated latent strengths of all teams along with approximate 95% confidence intervals. The high degree of overlap between these marginal intervals suggests that there may be considerable uncertainty in the relative rankings of some teams. Precisely quantifying this uncertainty in rankings (e.g., with the bootstrap) is left as an <a href="../lectures/lecture13.html#sec-exercises">Exercise</a>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-lambda-hat" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lambda-hat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="lecture13_files/figure-html/fig-lambda-hat-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Power Rankings"><img src="lecture13_files/figure-html/fig-lambda-hat-1.png" class="img-fluid figure-img" width="768"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lambda-hat-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Power Rankings
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-frozen4" class="level2">
<h2 class="anchored" data-anchor-id="sec-frozen4">Frozen 4 Simulation</h2>
<p>Wisconsin, Ohio State, Cornell, and Minnesota qualified for the semi-finals of the 2025 NCAA Tournament (known as the Frozen 4). The teams were seeded as: (1) Wisconsin; (2) Ohio State; (3) Cornell; and (4) Minnesota. Following a standard bracket construction, the first semi-final game (which we will label <code>SF1</code>) was played between the 1st and 4th seed (Wisconsin vs Minnesota) and the second semi-final game (which we will label <code>SF2</code>) was played between the 2nd and 3rd seed (Ohio State vs Cornell).</p>
<section id="sec-simulation-orig" class="level3">
<h3 class="anchored" data-anchor-id="sec-simulation-orig">Simulating the Original Tournament</h3>
<p>To power our simulation, we will first enumerate all possible matchups between the four teams and compute the probability that the higher-seeded team wins. In computing these probabilities, we will account for the fact that all games were played at Ridder Arena, which is the home arena of Minnesota.</p>
<p>In the following code block, we first create a table containing the team names and their seeds. Then, we enumerate all possible combinations of teams using <code>expand.grid()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>seeds <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Team =</span> <span class="fu">c</span>(<span class="st">"Wisconsin"</span>, <span class="st">"Ohio State"</span>, <span class="st">"Cornell"</span>, <span class="st">"Minnesota"</span>),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Seed =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>possible_matchups <span class="ot">&lt;-</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand.grid</span>(<span class="at">Hi =</span> seeds<span class="sc">$</span>Team, <span class="at">Lo =</span> seeds<span class="sc">$</span>Team) <span class="sc">|&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> seeds <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Hi =</span> Team, <span class="at">Hi.Seed=</span>Seed), <span class="at">by =</span> <span class="st">"Hi"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> seeds <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Lo =</span> Team, <span class="at">Lo.Seed=</span>Seed), <span class="at">by =</span> <span class="st">"Lo"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(Hi.Seed <span class="sc">&lt;</span> Lo.Seed) <span class="sc">|&gt;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">neutral =</span> <span class="fu">ifelse</span>(Hi <span class="sc">==</span> <span class="st">"Minnesota"</span> <span class="sc">|</span> Lo <span class="sc">==</span> <span class="st">"Minnesota"</span>, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff =</span> lambda_hat[Hi, <span class="st">"ability"</span>] <span class="sc">-</span> lambda_hat[Lo, <span class="st">"ability"</span>],</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>      neutral <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> diff)),</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>      neutral <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Hi <span class="sc">==</span> <span class="st">"Minnesota"</span> <span class="sc">~</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> (diff <span class="sc">+</span> lambda0_hat))),</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>      neutral <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> Lo <span class="sc">==</span> <span class="st">"Minnesota"</span> <span class="sc">~</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> (diff <span class="sc">-</span> lambda0_hat)))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-11"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-11-1"><a href="#annotated-cell-11-1" aria-hidden="true" tabindex="-1"></a>semis <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-11-2"><a href="#annotated-cell-11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Hi =</span> <span class="fu">c</span>(<span class="st">"Wisconsin"</span>, <span class="st">"Ohio State"</span>), <span class="at">Lo =</span> <span class="fu">c</span>(<span class="st">"Minnesota"</span>, <span class="st">"Cornell"</span>)) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-11-3"><a href="#annotated-cell-11-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(possible_matchups <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(Hi, Lo, prob), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Hi"</span>, <span class="st">"Lo"</span>))</span>
<span id="annotated-cell-11-4"><a href="#annotated-cell-11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-5"><a href="#annotated-cell-11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">479</span>)</span>
<span id="annotated-cell-11-6"><a href="#annotated-cell-11-6" aria-hidden="true" tabindex="-1"></a>sf_winners <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="annotated-cell-11-7"><a href="#annotated-cell-11-7" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1">1</button><span id="annotated-cell-11-8" class="code-annotation-target"><a href="#annotated-cell-11-8" aria-hidden="true" tabindex="-1"></a>sf_outcomes <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">nrow</span>(semis), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> semis<span class="sc">$</span>prob)</span>
<span id="annotated-cell-11-9"><a href="#annotated-cell-11-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(semis)){</span>
<span id="annotated-cell-11-10"><a href="#annotated-cell-11-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(sf_outcomes[i] <span class="sc">==</span> <span class="dv">1</span>) sf_winners[i] <span class="ot">&lt;-</span> semis<span class="sc">$</span>Hi[i]</span>
<span id="annotated-cell-11-11"><a href="#annotated-cell-11-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> sf_winners[i] <span class="ot">&lt;-</span> semis<span class="sc">$</span>Lo[i]</span>
<span id="annotated-cell-11-12"><a href="#annotated-cell-11-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-11-13"><a href="#annotated-cell-11-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Semi-final outcomes:"</span>, sf_outcomes, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="annotated-cell-11-14"><a href="#annotated-cell-11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Semi-final winners:"</span>, sf_winners, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="8,10,11" data-code-annotation="1">The <span class="math inline">\(i\)</span>-th entry of <code>sf_outcomes</code> is 1 if the higher-seed in game <span class="math inline">\(i\)</span> wins and 0 if the lower-seed in game <span class="math inline">\(i\)</span> wins</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Semi-final outcomes: 0 1 
Semi-final winners: Minnesota Ohio State </code></pre>
</div>
</div>
<p>The winners of both semi-final matches play each other in the finals. In the code below, we create a data frame containing the team names and then determine which is the higher seed. We then join the corresponding probability of the higher-seeded team winning the game. Finally, we simulate the outcome of the match and record the winner.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>finals <span class="ot">&lt;-</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Team1 =</span> sf_winners[<span class="dv">1</span>], <span class="at">Team2 =</span> sf_winners[<span class="dv">2</span>]) <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(<span class="at">y =</span> seeds <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Team1 =</span> Team, <span class="at">Team1.Seed =</span> Seed), <span class="at">by =</span> <span class="st">"Team1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(<span class="at">y =</span> seeds <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Team2 =</span> Team, <span class="at">Team2.Seed =</span> Seed), <span class="at">by =</span> <span class="st">"Team2"</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Hi =</span> <span class="fu">ifelse</span>(Team1.Seed <span class="sc">&lt;</span> Team2.Seed, Team1, Team2),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lo =</span> <span class="fu">ifelse</span>(Team1.Seed <span class="sc">&lt;</span> Team2.Seed, Team2, Team1)) <span class="sc">|&gt;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Hi, Lo) <span class="sc">|&gt;</span> </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> possible_matchups <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(Hi, Lo, prob), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Hi"</span>, <span class="st">"Lo"</span>))</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>final_outcome <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> finals<span class="sc">$</span>prob)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(final_outcome <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  final_winner <span class="ot">&lt;-</span> finals<span class="sc">$</span>Hi[<span class="dv">1</span>]</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span>{</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  final_winner <span class="ot">&lt;-</span> finals<span class="sc">$</span>Lo[<span class="dv">1</span>]</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Finals outcome:"</span>, final_outcome, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finals outcome: 1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Finals winner:"</span>, final_winner, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Finals winner: Ohio State </code></pre>
</div>
</div>
<p>In this simulation, Minnesota upset Wisconsin the first semi-finals; Ohio State beat Cornell in the second semi-finals; and Ohio State defeated Minnesota in the finals. Of course, if we run the simulation again with a different randomization seed, we might observe a different result. The code below runs simulates the Frozen 4 10,000 times. In each simulation iteration, we will save the winners of the two semi-final games (<code>SF1_winner</code> and <code>SF2_winner</code>); the two teams playing in the finals (<code>Finals_Hi</code> for the higher-seeded team and <code>Finals_Lo</code> for the lower-seeded team); and the eventual champion (<code>Champion</code>). By saving all these results, we can estimate the probabilities of not only simple events (e.g.&nbsp;<span class="math inline">\(\mathbb{P}(\textrm{Wisconsin wins the finals})\)</span>) but also joint probabilities like <span class="math display">\[\mathbb{P}(\textrm{Wisconsin makes it to and wins the finals})\]</span> and conditional probabilities like <span class="math display">\[
\mathbb{P}(\textrm{Wisconsin wins the finals} \vert \textrm{Wisconsin makes it to the finals}).
\]</span> by dividing the number of simulations in which Wisconsin wins the championship by beating Ohio State in the finals by the number of simulations in which Wisconsin plays Ohio State in the finals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-14"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-14-1"><a href="#annotated-cell-14-1" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="annotated-cell-14-2"><a href="#annotated-cell-14-2" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="1">1</button><span id="annotated-cell-14-3" class="code-annotation-target"><a href="#annotated-cell-14-3" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="annotated-cell-14-4"><a href="#annotated-cell-14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">SF1_Winner =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_sims),</span>
<span id="annotated-cell-14-5"><a href="#annotated-cell-14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">SF2_Winner =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_sims),</span>
<span id="annotated-cell-14-6"><a href="#annotated-cell-14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Finals_Hi =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_sims),</span>
<span id="annotated-cell-14-7"><a href="#annotated-cell-14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Finals_Lo =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_sims),</span>
<span id="annotated-cell-14-8"><a href="#annotated-cell-14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Champion =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_sims))</span>
<span id="annotated-cell-14-9"><a href="#annotated-cell-14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-10"><a href="#annotated-cell-14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-11"><a href="#annotated-cell-14-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sims){</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="2">2</button><span id="annotated-cell-14-12" class="code-annotation-target"><a href="#annotated-cell-14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">479</span><span class="sc">+</span>r)</span>
<span id="annotated-cell-14-13"><a href="#annotated-cell-14-13" aria-hidden="true" tabindex="-1"></a>  sf_winners <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="annotated-cell-14-14"><a href="#annotated-cell-14-14" aria-hidden="true" tabindex="-1"></a>  sf_outcomes <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">nrow</span>(semis), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> semis<span class="sc">$</span>prob)</span>
<span id="annotated-cell-14-15"><a href="#annotated-cell-14-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(semis)){</span>
<span id="annotated-cell-14-16"><a href="#annotated-cell-14-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(sf_outcomes[i] <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="annotated-cell-14-17"><a href="#annotated-cell-14-17" aria-hidden="true" tabindex="-1"></a>      sf_winners[i] <span class="ot">&lt;-</span> semis<span class="sc">$</span>Hi[i]</span>
<span id="annotated-cell-14-18"><a href="#annotated-cell-14-18" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="annotated-cell-14-19"><a href="#annotated-cell-14-19" aria-hidden="true" tabindex="-1"></a>      sf_winners[i] <span class="ot">&lt;-</span> semis<span class="sc">$</span>Lo[i]</span>
<span id="annotated-cell-14-20"><a href="#annotated-cell-14-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="3">3</button><span id="annotated-cell-14-21" class="code-annotation-target"><a href="#annotated-cell-14-21" aria-hidden="true" tabindex="-1"></a>    results[r, <span class="fu">c</span>(<span class="st">"SF1_Winner"</span>, <span class="st">"SF2_Winner"</span>)] <span class="ot">&lt;-</span> sf_winners</span>
<span id="annotated-cell-14-22"><a href="#annotated-cell-14-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="annotated-cell-14-23"><a href="#annotated-cell-14-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-14-24"><a href="#annotated-cell-14-24" aria-hidden="true" tabindex="-1"></a>  finals <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-14-25"><a href="#annotated-cell-14-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">Team1 =</span> sf_winners[<span class="dv">1</span>], <span class="at">Team2 =</span> sf_winners[<span class="dv">2</span>]) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-14-26"><a href="#annotated-cell-14-26" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="annotated-cell-14-27"><a href="#annotated-cell-14-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> seeds <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Team1 =</span> Team, <span class="at">Team1.Seed =</span> Seed), </span>
<span id="annotated-cell-14-28"><a href="#annotated-cell-14-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"Team1"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-14-29"><a href="#annotated-cell-14-29" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="annotated-cell-14-30"><a href="#annotated-cell-14-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> seeds <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Team2 =</span> Team, <span class="at">Team2.Seed =</span> Seed), </span>
<span id="annotated-cell-14-31"><a href="#annotated-cell-14-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"Team2"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-14-32"><a href="#annotated-cell-14-32" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="annotated-cell-14-33"><a href="#annotated-cell-14-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">Hi =</span> <span class="fu">ifelse</span>(Team1.Seed <span class="sc">&lt;</span> Team2.Seed, Team1, Team2),</span>
<span id="annotated-cell-14-34"><a href="#annotated-cell-14-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">Lo =</span> <span class="fu">ifelse</span>(Team1.Seed <span class="sc">&lt;</span> Team2.Seed, Team2, Team1)) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-14-35"><a href="#annotated-cell-14-35" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(Hi, Lo) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-14-36"><a href="#annotated-cell-14-36" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="annotated-cell-14-37"><a href="#annotated-cell-14-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> possible_matchups <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(Hi, Lo, prob), </span>
<span id="annotated-cell-14-38"><a href="#annotated-cell-14-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Hi"</span>, <span class="st">"Lo"</span>))</span>
<span id="annotated-cell-14-39"><a href="#annotated-cell-14-39" aria-hidden="true" tabindex="-1"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="4">4</button><span id="annotated-cell-14-40" class="code-annotation-target"><a href="#annotated-cell-14-40" aria-hidden="true" tabindex="-1"></a>  results[r, <span class="st">"Finals_Hi"</span>] <span class="ot">&lt;-</span> finals<span class="sc">$</span>Hi[<span class="dv">1</span>]</span>
<span id="annotated-cell-14-41"><a href="#annotated-cell-14-41" aria-hidden="true" tabindex="-1"></a>  results[r, <span class="st">"Finals_Lo"</span>] <span class="ot">&lt;-</span> finals<span class="sc">$</span>Lo[<span class="dv">1</span>]</span>
<span id="annotated-cell-14-42"><a href="#annotated-cell-14-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-14-43"><a href="#annotated-cell-14-43" aria-hidden="true" tabindex="-1"></a>  final_outcome <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> finals<span class="sc">$</span>prob)</span>
<span id="annotated-cell-14-44"><a href="#annotated-cell-14-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-14-45"><a href="#annotated-cell-14-45" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(final_outcome <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="annotated-cell-14-46"><a href="#annotated-cell-14-46" aria-hidden="true" tabindex="-1"></a>    results[r, <span class="st">"Champion"</span>] <span class="ot">&lt;-</span> finals<span class="sc">$</span>Hi[<span class="dv">1</span>]</span>
<span id="annotated-cell-14-47"><a href="#annotated-cell-14-47" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="annotated-cell-14-48"><a href="#annotated-cell-14-48" aria-hidden="true" tabindex="-1"></a>    results[r, <span class="st">"Champion"</span>] <span class="ot">&lt;-</span> finals<span class="sc">$</span>Lo[<span class="dv">1</span>]</span>
<span id="annotated-cell-14-49"><a href="#annotated-cell-14-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="annotated-cell-14-50"><a href="#annotated-cell-14-50" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-14" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="3,4,5,6,7,8" data-code-annotation="1">Data frame to hold the simulation results</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="12" data-code-annotation="2">Manually setting our randomization seed ensures reproducibility. But we need to use a different seed in every simulation iteration. Otherwise, we will get identical results across replications and that can bias our final probability estimates.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="21" data-code-annotation="3">Save the winners of the semi-finals</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="40,41" data-code-annotation="4">Save the high and low seeds of the finals</span>
</dd>
</dl>
</div>
</div>
<p>Looking at the first several rows in <code>results</code>, we find that Wisconsin won the championship in most of the simulations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   SF1_Winner SF2_Winner  Finals_Hi  Finals_Lo   Champion
1   Wisconsin Ohio State  Wisconsin Ohio State  Wisconsin
2   Wisconsin Ohio State  Wisconsin Ohio State Ohio State
3   Wisconsin    Cornell  Wisconsin    Cornell  Wisconsin
4   Wisconsin Ohio State  Wisconsin Ohio State  Wisconsin
5   Wisconsin    Cornell  Wisconsin    Cornell  Wisconsin
6   Wisconsin Ohio State  Wisconsin Ohio State  Wisconsin
7   Wisconsin Ohio State  Wisconsin Ohio State  Wisconsin
8   Wisconsin Ohio State  Wisconsin Ohio State  Wisconsin
9   Wisconsin    Cornell  Wisconsin    Cornell  Wisconsin
10  Minnesota Ohio State Ohio State  Minnesota  Minnesota</code></pre>
</div>
</div>
<p>In total, we find that Wisconsin won the championship in 7189 of the 10,000 simulation runs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(results<span class="sc">$</span>Champion)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   Cornell  Minnesota Ohio State  Wisconsin 
       502        765       1544       7189 </code></pre>
</div>
</div>
<p>Across the 10,000 simulations, we find that</p>
<ul>
<li>Wisconsin made the finals in 8496 simulations</li>
<li>Wisconsin made and won the finals in 7189 simulations</li>
</ul>
<p>Based on these numbers, we conclude that the conditional probability of Wisconsin winning the finals given that it made it to the finals is about 84.6%</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(results<span class="sc">$</span>SF1_Winner <span class="sc">==</span> <span class="st">"Wisconsin"</span> <span class="sc">&amp;</span> results<span class="sc">$</span>Champion <span class="sc">==</span> <span class="st">"Wisconsin"</span>)<span class="sc">/</span><span class="fu">sum</span>(results<span class="sc">$</span>SF1_Winner <span class="sc">==</span> <span class="st">"Wisconsin"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8461629</code></pre>
</div>
</div>
</section>
<section id="sec-simulation-alt" class="level3">
<h3 class="anchored" data-anchor-id="sec-simulation-alt">Simulating an Alternative Tournament</h3>
<p>What if, instead of playing the semi-finals and finals at Ridder Arena, each game was held at the home arena of the higher-seeded team? Intuitively, we might expect Wisconsin’s chances of winning the championship to be much higher if they played all their matches at La Bahn Arena. To verify this, we will re-run our simulation. The only change is in the individual matchup probabilities: whereas in our original simulation, we only added the home advantage for Minnesota’s games, in our new simulation, we will add the advantage to all games.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-18"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-18-1"><a href="#annotated-cell-18-1" aria-hidden="true" tabindex="-1"></a>alt_matchups <span class="ot">&lt;-</span></span>
<span id="annotated-cell-18-2"><a href="#annotated-cell-18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">expand.grid</span>(<span class="at">Hi =</span> seeds<span class="sc">$</span>Team, <span class="at">Lo =</span> seeds<span class="sc">$</span>Team) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-18-3"><a href="#annotated-cell-18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">|&gt;</span></span>
<span id="annotated-cell-18-4"><a href="#annotated-cell-18-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> seeds <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Hi =</span> Team, <span class="at">Hi.Seed=</span>Seed), <span class="at">by =</span> <span class="st">"Hi"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-18-5"><a href="#annotated-cell-18-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> seeds <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Lo =</span> Team, <span class="at">Lo.Seed=</span>Seed), <span class="at">by =</span> <span class="st">"Lo"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-18-6"><a href="#annotated-cell-18-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(Hi.Seed <span class="sc">&lt;</span> Lo.Seed) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-18-7"><a href="#annotated-cell-18-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="1">1</button><span id="annotated-cell-18-8" class="code-annotation-target"><a href="#annotated-cell-18-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff =</span> lambda_hat[Hi, <span class="st">"ability"</span>] <span class="sc">-</span> lambda_hat[Lo, <span class="st">"ability"</span>],</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="2">2</button><span id="annotated-cell-18-9" class="code-annotation-target"><a href="#annotated-cell-18-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">log_odds =</span> diff <span class="sc">+</span> lambda0_hat,</span>
<span id="annotated-cell-18-10"><a href="#annotated-cell-18-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">prob =</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> (log_odds))))</span>
<span id="annotated-cell-18-11"><a href="#annotated-cell-18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-18-12"><a href="#annotated-cell-18-12" aria-hidden="true" tabindex="-1"></a>semis <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-18-13"><a href="#annotated-cell-18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">Hi =</span> <span class="fu">c</span>(<span class="st">"Wisconsin"</span>, <span class="st">"Ohio State"</span>), <span class="at">Lo =</span> <span class="fu">c</span>(<span class="st">"Minnesota"</span>, <span class="st">"Cornell"</span>)) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="3">3</button><span id="annotated-cell-18-14" class="code-annotation-target"><a href="#annotated-cell-18-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(alt_matchups <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(Hi, Lo, prob), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Hi"</span>, <span class="st">"Lo"</span>))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-18" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="8" data-code-annotation="1">This is the log-odds of the higher seed winning if the game were played at a neutral site</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="9" data-code-annotation="2">In this alternative, the higher seed always plays at a home, hence the additional <code>lambda0_hat</code> factor.</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="14" data-code-annotation="3">Recreate <code>semis</code> but include the new matchup probabilities for the alternative scenario</span>
</dd>
</dl>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-19"><pre class="sourceCode r code-annotation-code code-with-copy"><code class="sourceCode r"><span id="annotated-cell-19-1"><a href="#annotated-cell-19-1" aria-hidden="true" tabindex="-1"></a>n_sims <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="annotated-cell-19-2"><a href="#annotated-cell-19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-19-3"><a href="#annotated-cell-19-3" aria-hidden="true" tabindex="-1"></a>alt_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="annotated-cell-19-4"><a href="#annotated-cell-19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">SF1_Winner =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_sims),</span>
<span id="annotated-cell-19-5"><a href="#annotated-cell-19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">SF2_Winner =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_sims),</span>
<span id="annotated-cell-19-6"><a href="#annotated-cell-19-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">Finals_Hi =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_sims),</span>
<span id="annotated-cell-19-7"><a href="#annotated-cell-19-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Finals_Lo =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_sims),</span>
<span id="annotated-cell-19-8"><a href="#annotated-cell-19-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Champion =</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_sims))</span>
<span id="annotated-cell-19-9"><a href="#annotated-cell-19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-19-10"><a href="#annotated-cell-19-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sims){</span>
<span id="annotated-cell-19-11"><a href="#annotated-cell-19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">479</span><span class="sc">+</span>r)</span>
<span id="annotated-cell-19-12"><a href="#annotated-cell-19-12" aria-hidden="true" tabindex="-1"></a>  sf_winners <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>)</span>
<span id="annotated-cell-19-13"><a href="#annotated-cell-19-13" aria-hidden="true" tabindex="-1"></a>  sf_outcomes <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="fu">nrow</span>(semis), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> semis<span class="sc">$</span>prob)</span>
<span id="annotated-cell-19-14"><a href="#annotated-cell-19-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(semis)){</span>
<span id="annotated-cell-19-15"><a href="#annotated-cell-19-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(sf_outcomes[i] <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="annotated-cell-19-16"><a href="#annotated-cell-19-16" aria-hidden="true" tabindex="-1"></a>      sf_winners[i] <span class="ot">&lt;-</span> semis<span class="sc">$</span>Hi[i]</span>
<span id="annotated-cell-19-17"><a href="#annotated-cell-19-17" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span>{</span>
<span id="annotated-cell-19-18"><a href="#annotated-cell-19-18" aria-hidden="true" tabindex="-1"></a>      sf_winners[i] <span class="ot">&lt;-</span> semis<span class="sc">$</span>Lo[i]</span>
<span id="annotated-cell-19-19"><a href="#annotated-cell-19-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="annotated-cell-19-20"><a href="#annotated-cell-19-20" aria-hidden="true" tabindex="-1"></a>    alt_results[r, <span class="fu">c</span>(<span class="st">"SF1_Winner"</span>, <span class="st">"SF2_Winner"</span>)] <span class="ot">&lt;-</span> sf_winners</span>
<span id="annotated-cell-19-21"><a href="#annotated-cell-19-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="annotated-cell-19-22"><a href="#annotated-cell-19-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-19-23"><a href="#annotated-cell-19-23" aria-hidden="true" tabindex="-1"></a>  finals <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-19-24"><a href="#annotated-cell-19-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">Team1 =</span> sf_winners[<span class="dv">1</span>], <span class="at">Team2 =</span> sf_winners[<span class="dv">2</span>]) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-19-25"><a href="#annotated-cell-19-25" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="annotated-cell-19-26"><a href="#annotated-cell-19-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> seeds <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Team1 =</span> Team, <span class="at">Team1.Seed =</span> Seed), </span>
<span id="annotated-cell-19-27"><a href="#annotated-cell-19-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"Team1"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-19-28"><a href="#annotated-cell-19-28" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="annotated-cell-19-29"><a href="#annotated-cell-19-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> seeds <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Team2 =</span> Team, <span class="at">Team2.Seed =</span> Seed), </span>
<span id="annotated-cell-19-30"><a href="#annotated-cell-19-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"Team2"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-19-31"><a href="#annotated-cell-19-31" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="annotated-cell-19-32"><a href="#annotated-cell-19-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">Hi =</span> <span class="fu">ifelse</span>(Team1.Seed <span class="sc">&lt;</span> Team2.Seed, Team1, Team2),</span>
<span id="annotated-cell-19-33"><a href="#annotated-cell-19-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">Lo =</span> <span class="fu">ifelse</span>(Team1.Seed <span class="sc">&lt;</span> Team2.Seed, Team2, Team1)) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-19-34"><a href="#annotated-cell-19-34" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(Hi, Lo) <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-19-35"><a href="#annotated-cell-19-35" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="annotated-cell-19-36"><a href="#annotated-cell-19-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> possible_matchups <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(Hi, Lo, prob), </span>
<span id="annotated-cell-19-37"><a href="#annotated-cell-19-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Hi"</span>, <span class="st">"Lo"</span>))</span>
<span id="annotated-cell-19-38"><a href="#annotated-cell-19-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-19-39"><a href="#annotated-cell-19-39" aria-hidden="true" tabindex="-1"></a>  alt_results[r, <span class="st">"Finals_Hi"</span>] <span class="ot">&lt;-</span> finals<span class="sc">$</span>Hi[<span class="dv">1</span>]</span>
<span id="annotated-cell-19-40"><a href="#annotated-cell-19-40" aria-hidden="true" tabindex="-1"></a>  alt_results[r, <span class="st">"Finals_Lo"</span>] <span class="ot">&lt;-</span> finals<span class="sc">$</span>Lo[<span class="dv">1</span>]</span>
<span id="annotated-cell-19-41"><a href="#annotated-cell-19-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-19-42"><a href="#annotated-cell-19-42" aria-hidden="true" tabindex="-1"></a>  final_outcome <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> finals<span class="sc">$</span>prob)</span>
<span id="annotated-cell-19-43"><a href="#annotated-cell-19-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-19-44"><a href="#annotated-cell-19-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(final_outcome <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="annotated-cell-19-45"><a href="#annotated-cell-19-45" aria-hidden="true" tabindex="-1"></a>    alt_results[r, <span class="st">"Champion"</span>] <span class="ot">&lt;-</span> finals<span class="sc">$</span>Hi[<span class="dv">1</span>]</span>
<span id="annotated-cell-19-46"><a href="#annotated-cell-19-46" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="annotated-cell-19-47"><a href="#annotated-cell-19-47" aria-hidden="true" tabindex="-1"></a>    alt_results[r, <span class="st">"Champion"</span>] <span class="ot">&lt;-</span> finals<span class="sc">$</span>Lo[<span class="dv">1</span>]</span>
<span id="annotated-cell-19-48"><a href="#annotated-cell-19-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="annotated-cell-19-49"><a href="#annotated-cell-19-49" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the alternative competition, where the higher-seeded team plays at home, we estimate that Wisconsin would win the championship about 77% of the time, up from the 71% in the version of the tournament played a neutral site.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(alt_results<span class="sc">$</span>Champion)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   Cornell  Minnesota Ohio State  Wisconsin 
       360        418       1533       7689 </code></pre>
</div>
</div>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<ol type="1">
<li><p>Use the bootstrap to quantify the uncertainty in relative rankings of each team. To do this, you will need to re-sample individual games, re-compute the numbers of home &amp; away team wins for every combination of teams and <code>neutral</code>, and fit a Bradley-Terry model. Report the number of bootstrap simulations in which Wisconsin was ranked 1st and also report a 95% bootstrap confidence interval for Wisconsin’s overall rank.</p></li>
<li><p>Build a simulation for the entire NCAA Tournament based on the estimating probabilities from our Bradley-Terry model that accounts for home advantage. In <a href="https://en.wikipedia.org/wiki/2025_NCAA_Division_I_women%27s_ice_hockey_tournament">this tournament</a>, the first round and quarterfinals were held on the campuses of the top-4 seeded teams (Wisconsin, Ohio State, Cornell, and Minnesota). Subsequent games were played at Ridder Arena at the University of Minnesota. Your simulation should involve only the 11 teams who actually played in the tournament</p></li>
</ol>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Remember, this is restriction is needed because the <span class="math inline">\(\lambda_{j}\)</span>’s are otherwise not identifiable. Without this restriction, the data gives us know way to distinguish between one set of values for the <span class="math inline">\(\lambda_{j}\)</span>’s and another set that shifts all the values by the same fixed constant. See <a href="../lectures/lecture12.html#sec-constraint">Lecture 12</a> for more details.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>R implements data frames using a <code>list</code> data type, with each column representing a separate list element. So, what we’re really doing here is adding a list-valued element to a list, which is easier to interpret than a data frame-valued column in a data frame.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>