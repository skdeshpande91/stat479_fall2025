<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lecture 8: Defensive Credit Allocation in Baseball – STAT479</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-4bfb630b09c0e164834af1bb3207dbff.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">STAT479</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../syllabus.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-lecture-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Lecture Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-lecture-notes">    
        <li>
    <a class="dropdown-item" href="../lectures/lecture00.html">
 <span class="dropdown-text">Lecture 0: Boxscore Metrics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture02.html">
 <span class="dropdown-text">Lecture 2: Expected Goals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture03.html">
 <span class="dropdown-text">Lecture 3: Estimating XG</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture04.html">
 <span class="dropdown-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture05.html">
 <span class="dropdown-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture06.html">
 <span class="dropdown-text">Lecture 6: Run Expectancy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture07.html">
 <span class="dropdown-text">Lecture 7: Offensive Credit Allocation in Baseball</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture08.html">
 <span class="dropdown-text">Lecture 8: Defensive Credit Allocation in Baseball</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture09.html">
 <span class="dropdown-text">Lecture 9: Multilevel Modeling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture10.html">
 <span class="dropdown-text">Lecture 10: NFl WAR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture11.html">
 <span class="dropdown-text">Lecture 11: Pitch Framing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture12.html">
 <span class="dropdown-text">Lecture 12: Power Rankings I</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture13.html">
 <span class="dropdown-text">Lecture 13: Power Rankings II</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-lecture-slides" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Lecture Slides</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-lecture-slides">    
        <li>
    <a class="dropdown-item" href="../slides/lecture01.html">
 <span class="dropdown-text">Lecture 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture02.html">
 <span class="dropdown-text">Lecture 2: Expected Goals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture03.html">
 <span class="dropdown-text">Lecture 3: Estimating XG</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture04.html">
 <span class="dropdown-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture05.html">
 <span class="dropdown-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture06.html">
 <span class="dropdown-text">Lecture 6: Expected Runs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture07.html">
 <span class="dropdown-text">Lecture 7: Offensive Credit</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture08.html">
 <span class="dropdown-text">Lecture 8: Defensive Credit Allocation &amp; WAR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture09.html">
 <span class="dropdown-text">Lecture 9: Multilevel Models</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../project1.html"> 
<span class="menu-text">Project 1 Information</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../lectures/lecture08.html">Lecture 8: Defensive Credit Allocation in Baseball</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 0: Boxscore Metrics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 2: Expected Goals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 3: Estimating XG</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 6: Run Expectancy</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 7: Offensive Credit Allocation in Baseball</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture08.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Lecture 8: Defensive Credit Allocation in Baseball</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 9: Multilevel Modeling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 10: NFl WAR</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 11: Pitch Framing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 12: Power Rankings I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 13: Power Rankings II</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sec-overview" id="toc-sec-overview" class="nav-link active" data-scroll-target="#sec-overview">Overview</a></li>
  <li><a href="#sec-hit-location-data" id="toc-sec-hit-location-data" class="nav-link" data-scroll-target="#sec-hit-location-data">Hit Location Data</a></li>
  <li><a href="#sec-out-probs" id="toc-sec-out-probs" class="nav-link" data-scroll-target="#sec-out-probs">Estimating Out Probabilities</a>
  <ul class="collapse">
  <li><a href="#binning-and-averaging" id="toc-binning-and-averaging" class="nav-link" data-scroll-target="#binning-and-averaging">Binning and Averaging</a></li>
  <li><a href="#sec-logistic" id="toc-sec-logistic" class="nav-link" data-scroll-target="#sec-logistic">A Logistic Regression Model for Outs</a></li>
  </ul></li>
  <li><a href="#sec-gam" id="toc-sec-gam" class="nav-link" data-scroll-target="#sec-gam">Generalized Additive Models</a>
  <ul class="collapse">
  <li><a href="#sec-divide-delta" id="toc-sec-divide-delta" class="nav-link" data-scroll-target="#sec-divide-delta">Dividing Defensive Run Value</a></li>
  </ul></li>
  <li><a href="#sec-fielding" id="toc-sec-fielding" class="nav-link" data-scroll-target="#sec-fielding">Fielding Run Values</a></li>
  <li><a href="#sec-pitching" id="toc-sec-pitching" class="nav-link" data-scroll-target="#sec-pitching">Pitching Run Values</a></li>
  <li><a href="#sec-war" id="toc-sec-war" class="nav-link" data-scroll-target="#sec-war">Replacement Level</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lecture 8: Defensive Credit Allocation in Baseball</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-overview" class="level2">
<h2 class="anchored" data-anchor-id="sec-overview">Overview</h2>
<p>In <a href="../lectures/lecture07.html">Lecture 7</a>, we distributed the run value created in each at-bat between the batter and base runners. Aggregating over all at-bats, we computed each player’s <span class="math inline">\(\textrm{RAA}^{\textrm{br}},\)</span> which quantifies how much more run value a player created through his base running than would otherwise be expected based on the starting game states and ending events of the at-bats in which he was involved. We also computed <span class="math inline">\(\textrm{RAA}^{\textrm{b}},\)</span> which quantifies how much more run value a player created through his hitting than would be expected based on his position.</p>
<p>According to the conservation of runs framework introduced by <span class="citation" data-cites="Baumer2015_openWAR">Baumer, Jensen, and Matthews (<a href="#ref-Baumer2015_openWAR" role="doc-biblioref">2015</a>)</span>, whenever the batting team creates <span class="math inline">\(\delta\)</span> units of run value in at-bat, the fielding team (necessarily) gives up <span class="math inline">\(\delta\)</span> units of run value. Equivalently, the fielding team creates <span class="math inline">\(-\delta\)</span> units of run value. In this lecture, we discuss how to divide this <span class="math inline">\(-\delta\)</span> run value between the pitchers (<a href="#sec-pitching" class="quarto-xref">Section&nbsp;6</a>) and fielders (<a href="#sec-fielding" class="quarto-xref">Section&nbsp;5</a>).</p>
<p>For at-bats <span class="math inline">\(i\)</span> that end without the ball being put in play (i.e., a strikeout, walk, or a homerun), we will assign the entirety of the <span class="math inline">\(-\delta_{i}\)</span> run value to the pitcher. But for at-bats that result with balls put in play, we will divide <span class="math inline">\(-\delta_{i}\)</span> into two parts <span class="math inline">\(\delta^{(f)}_{i} = -\delta \times \hat{p}_{i}\)</span> and <span class="math inline">\(\delta^{(p)} = -\delta_{i} \times (1 - \hat{p}_{i})\)</span> where <span class="math inline">\(\hat{p}_{i}\)</span> is an <em>estimate</em> of the probability that play results in an out given the batted ball’s location (<a href="#sec-out-probs" class="quarto-xref">Section&nbsp;3</a>). We will specifically estimate these out probabilities using <strong>Generalized Additive Models</strong> (<a href="#sec-gam" class="quarto-xref">Section&nbsp;4</a>). Finally, we compute how more run value each player creates through their batting, baserunning, pitching, and fielding than a replacement level player (<a href="#sec-war" class="quarto-xref">Section&nbsp;7</a>).</p>
</section>
<section id="sec-hit-location-data" class="level2">
<h2 class="anchored" data-anchor-id="sec-hit-location-data">Hit Location Data</h2>
<p>We begin by loading several of the data tables created in <a href="../lectures/lecture06.html">Lecture 6</a> and <a href="../lectures/lecture07.html">Lecture 7</a> including <code>statcast2024</code>, which contains pitch-level data for all regular season pitches in 2024, <code>runValue2024</code>, which contains the <span class="math inline">\(\delta_{i}\)</span>’s for each regular season at-bat, and <code>player2024_lookup</code>, which contains the names and MLB Advanced Media identifiers for each player.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"statcast2024.RData"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"runValue2024.RData"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"player2024_lookup.RData"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>oi_colors <span class="ot">&lt;-</span> </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">palette.colors</span>(<span class="at">palette =</span> <span class="st">"Okabe-Ito"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall from <a href="../lectures/lecture06.html">Lecture 6</a> that the Statcast variables <code>hc_x</code> and <code>hc_y</code> record the coordinates where each batted ball is first fielded. When we plotted the available <code>hc_x</code> and <code>hc_y</code> values, we saw the outlines of the park, with home plate located around <code>hc_x = 125</code> and <code>hc_y = 200.</code> We can also roughly make out the first and third base lines and the infield.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(statcast2024<span class="sc">$</span>hc_x, statcast2024<span class="sc">$</span>hc_y, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"hc_x"</span>, <span class="at">ylab =</span> <span class="st">"hc_y"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.2</span>, </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>(oi_colors[<span class="dv">1</span>], <span class="at">alpha.f =</span> <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-hc-coordinates" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hc-coordinates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="lecture08_files/figure-html/fig-hc-coordinates-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Locations where all batted balls are first fielded"><img src="lecture08_files/figure-html/fig-hc-coordinates-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-hc-coordinates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Locations where all batted balls are first fielded
</figcaption>
</figure>
</div>
</div>
</div>
<p>It is not immediately apparent, however, whether the first base line is on the left or right. Luckily, StatCast also contains the official <a href="https://en.wikipedia.org/wiki/Baseball_positions">fielding position</a> of the player who first fields the ball<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. When we plot just the pitches first fielded by first basemen (<code>hit_location=3</code>), we see that in the original <code>(hc_x, hc_y)</code> coordinate system, first base is on the <em>right</em> hand side of the plot.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(statcast2024<span class="sc">$</span>hc_x[statcast2024<span class="sc">$</span>hit_location<span class="sc">!=</span><span class="dv">3</span>], </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>     statcast2024<span class="sc">$</span>hc_y[statcast2024<span class="sc">$</span>hit_location <span class="sc">!=</span> <span class="dv">3</span>], </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"hc_x"</span>, <span class="at">ylab =</span> <span class="st">"hc_y"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.2</span>, </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>(oi_colors[<span class="dv">1</span>], <span class="at">alpha.f =</span> <span class="fl">0.1</span>))</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(statcast2024<span class="sc">$</span>hc_x[statcast2024<span class="sc">$</span>hit_location<span class="sc">==</span><span class="dv">3</span>], </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>     statcast2024<span class="sc">$</span>hc_y[statcast2024<span class="sc">$</span>hit_location<span class="sc">==</span><span class="dv">3</span>],</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.2</span>, </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>(oi_colors[<span class="dv">2</span>], <span class="at">alpha.f =</span> <span class="fl">0.1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-fielder3" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fielder3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="lecture08_files/figure-html/fig-fielder3-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: Location of all batted balls initially fielded by the first baseman"><img src="lecture08_files/figure-html/fig-fielder3-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fielder3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Location of all batted balls initially fielded by the first baseman
</figcaption>
</figure>
</div>
</div>
</div>
<p>Although MLB Stadiums are equipped with lots of very cool camera and ball tracking technology, the variables <code>hc_x</code> and <code>hc_y</code> are <em>not</em> derived from those technologies. Instead a stringer manually marks the location of the batted ball on a tablet so the coordinates <code>hc_x</code> and <code>hc_y</code> are expressed in units of pixels on that tablet. <a href="https://bayesball.github.io">Jim Albert</a>, who is one of the founding fathers of Statistical research in baseball, <a href="https://baseballwithr.wordpress.com/2021/04/">suggested</a> the following transformation from the original <code>(hc_x, hc_y)</code> coordinate system to one that places home plate at the bottom of the plot (with coordinates <code>(0,0)</code>) and measures distances in feet. <span class="math display">\[
\begin{align}
x &amp;= 2.5 \times (\texttt{hc\_x} - 125.42) &amp; y &amp;= 2.5 \times (198.27 - \texttt{hc\_y})
\end{align}
\]</span></p>
<p>The following code implements this transformation, storing the new coordinates as <code>x</code> and <code>y</code> and then plots the batted ball locations. It also overlays the first and third base lines, the base paths and places points at the base locations.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="annotated-cell-4"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a>statcast2024 <span class="ot">&lt;-</span></span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a>  statcast2024 <span class="sc">|&gt;</span></span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">2.5</span> <span class="sc">*</span> (hc_x <span class="sc">-</span> <span class="fl">125.42</span>),</span>
<span id="annotated-cell-4-5"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fl">2.5</span> <span class="sc">*</span> (<span class="fl">198.27</span> <span class="sc">-</span> hc_y))</span>
<span id="annotated-cell-4-6"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-7"><a href="#annotated-cell-4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<span id="annotated-cell-4-8"><a href="#annotated-cell-4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(statcast2024<span class="sc">$</span>x, </span>
<span id="annotated-cell-4-9"><a href="#annotated-cell-4-9" aria-hidden="true" tabindex="-1"></a>     statcast2024<span class="sc">$</span>y, </span>
<span id="annotated-cell-4-10"><a href="#annotated-cell-4-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"x"</span>, <span class="at">ylab =</span> <span class="st">"y"</span>,</span>
<span id="annotated-cell-4-11"><a href="#annotated-cell-4-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.2</span>, </span>
<span id="annotated-cell-4-12"><a href="#annotated-cell-4-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">300</span>, <span class="dv">300</span>),</span>
<span id="annotated-cell-4-13"><a href="#annotated-cell-4-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">500</span>),</span>
<span id="annotated-cell-4-14"><a href="#annotated-cell-4-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>(oi_colors[<span class="dv">1</span>], <span class="at">alpha.f =</span> <span class="fl">0.1</span>))</span>
<span id="annotated-cell-4-15"><a href="#annotated-cell-4-15" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1">1</button><span id="annotated-cell-4-16" class="code-annotation-target"><a href="#annotated-cell-4-16" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">col =</span> oi_colors[<span class="dv">5</span>], <span class="at">lwd =</span> <span class="dv">1</span>)</span>
<span id="annotated-cell-4-17"><a href="#annotated-cell-4-17" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">col =</span> oi_colors[<span class="dv">5</span>], <span class="at">lwd =</span> <span class="dv">1</span>)</span>
<span id="annotated-cell-4-18"><a href="#annotated-cell-4-18" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="2">2</button><span id="annotated-cell-4-19" class="code-annotation-target"><a href="#annotated-cell-4-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="annotated-cell-4-20"><a href="#annotated-cell-4-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="annotated-cell-4-21"><a href="#annotated-cell-4-21" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">0</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="annotated-cell-4-22"><a href="#annotated-cell-4-22" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">0</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="annotated-cell-4-23"><a href="#annotated-cell-4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-24"><a href="#annotated-cell-4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-4-25"><a href="#annotated-cell-4-25" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="annotated-cell-4-26"><a href="#annotated-cell-4-26" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">y =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="annotated-cell-4-27"><a href="#annotated-cell-4-27" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">y =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>,<span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="annotated-cell-4-28"><a href="#annotated-cell-4-28" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="16" data-code-annotation="1">The function <code>abline(a,b)</code> plots the line <span class="math inline">\(y = ax + b\)</span>. In our new coordinate system the first and third base lines correspond to the lines <span class="math inline">\(y = x\)</span> and <span class="math inline">\(y = -x\)</span>.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="19" data-code-annotation="2">In our new coordinate system, home plate is at <code>(0,0)</code>. First base and third base are 90 feet away from home plate along the 45 degree lines, meaning that their coordinates are <code>(90/sqrt(2), 90/sqrt(2))</code> and (-90/sqrt(2), 90/sqrt(2))`.</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div id="fig-new-coords" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-new-coords-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="lecture08_files/figure-html/fig-new-coords-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;3: Locations where batted balls are first fielded in our transformed coordinate system"><img src="lecture08_files/figure-html/fig-new-coords-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-new-coords-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Locations where batted balls are first fielded in our transformed coordinate system
</figcaption>
</figure>
</div>
</div>
</div>
<p>In <a href="../lectures/lecture07.html">Lecture 7</a>, we created a table <code>atbat2024</code> that contained the beginning and ending states of each at-bat, run value, ending event, and identities of the batter and baserunners. Today, we will build a similar data frame that contains the ending event, identities of the pitcher and fielders, and, if the at-bat resulted in a ball being put into play, the batted ball locations. Like the code we used to build <code>atbat2024</code>, we need to identify the <em>last</em> entry in the column <code>events</code> in each at bat as well as the last entry of the columns <code>x</code>, <code>y</code>, and <code>hit_location</code>. We will also keep the run value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>def_atbat2024 <span class="ot">&lt;-</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  statcast2024 <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(game_pk, at_bat_number) <span class="sc">|&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(pitch_number) <span class="sc">|&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_events =</span> dplyr<span class="sc">::</span><span class="fu">last</span>(events),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_x =</span> dplyr<span class="sc">::</span><span class="fu">last</span>(x),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_y =</span> dplyr<span class="sc">::</span><span class="fu">last</span>(y),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_type =</span> dplyr<span class="sc">::</span><span class="fu">last</span>(type),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_hit_location =</span> dplyr<span class="sc">::</span><span class="fu">last</span>(hit_location)) <span class="sc">|&gt;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(pitch_number <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(game_date, game_pk, at_bat_number, pitch_number) <span class="sc">|&gt;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    game_date, game_pk, at_bat_number,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    end_events, end_type, des,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    batter,</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    pitcher, fielder_2, fielder_3,</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    fielder_4, fielder_5, fielder_6,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    fielder_7, fielder_8, fielder_9,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    end_x, end_y, end_hit_location) <span class="sc">|&gt;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">x =</span> end_x, <span class="at">y =</span> end_y) <span class="sc">|&gt;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> runValue2024, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"game_pk"</span>, <span class="st">"at_bat_number"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-out-probs" class="level2">
<h2 class="anchored" data-anchor-id="sec-out-probs">Estimating Out Probabilities</h2>
<p>Recall that we need to estimate the probability that a batted ball results in an out given its coordinate. To do so, we first need to extract those at-bats that resulted in a ball being put in play. The variable <code>end_type</code> in <code>def_atbat2024</code> records whether the last pitch of each at-bat resulted in a strike (<code>end_type = S</code>), a ball (<code>end_type = B</code>), or a ball being hit into play (<code>end_type = X</code>). As a sanity check, let’s take a look at the ending event for all at-bats with <code>end_type = X</code>. Reassuringly, none of them can occur without a ball being hit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(def_atbat2024<span class="sc">$</span>end_events[def_atbat2024<span class="sc">$</span>end_type <span class="sc">==</span> <span class="st">"X"</span>], <span class="at">useNA =</span> <span class="st">'always'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                   double               double_play               field_error 
                     7608                       336                      1093 
                field_out           fielders_choice       fielders_choice_out 
                    72233                       373                       306 
                force_out grounded_into_double_play                  home_run 
                     3408                      3152                      5326 
                 sac_bunt                   sac_fly       sac_fly_double_play 
                      446                      1222                        13 
                   single                    triple               triple_play 
                    25363                       685                         1 
                     &lt;NA&gt; 
                        0 </code></pre>
</div>
</div>
<p>As another sanity check, when we tabulate the <code>end_events</code> for all at-bats with <code>end_type != X</code>, we do not see any of the hitting events from above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(def_atbat2024<span class="sc">$</span>end_events[def_atbat2024<span class="sc">$</span>end_type <span class="sc">!=</span> <span class="st">"X"</span>], <span class="at">useNA =</span> <span class="st">'always'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                             catcher_interf          hit_by_pitch 
                  308                    97                  1977 
            strikeout strikeout_double_play          truncated_pa 
                40145                   107                   304 
                 walk                  &lt;NA&gt; 
                14029                     0 </code></pre>
</div>
</div>
<p>So, we can isolate those at-bats with a ball put in play by filtering on <code>end_type</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>bip <span class="ot">&lt;-</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(end_type <span class="sc">==</span> <span class="st">"X"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The columns <code>end_events</code> includes values <code>fielders_choice</code> and <code>fielders_choice_out</code>. Presumably, balls recorded as <code>fielders_choice</code> did not result in an out while those recorded as <code>fielders_choice_out</code> did. To check whether this is the case, we will search from the string “out” in the description of the at-bat (<code>des</code>) for all balls with <code>event = fielders_choice</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">grepl</span>(<span class="st">"out"</span>, bip<span class="sc">$</span>des[bip<span class="sc">$</span>end_events <span class="sc">==</span> <span class="st">"fielders_choice"</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
FALSE  TRUE 
  371     2 </code></pre>
</div>
</div>
<p>Curiously, there are two instances where the play is recorded as a fielder’s choice but the string “out” appears. Investigating further, in one instance the string “out” appears as part of a player’s name while in the other, the play actually did result in an out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"out"</span>, bip<span class="sc">$</span>des) <span class="sc">&amp;</span> bip<span class="sc">$</span>end_events <span class="sc">==</span> <span class="st">"fielders_choice"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10235 65138</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>bip<span class="sc">$</span>des[<span class="fu">which</span>(<span class="fu">grepl</span>(<span class="st">"out"</span>, bip<span class="sc">$</span>des) <span class="sc">&amp;</span> bip<span class="sc">$</span>end_events <span class="sc">==</span> <span class="st">"fielders_choice"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Mike Trout reaches on a fielder's choice, fielded by shortstop David Hamilton. Anthony Rendon to 3rd. Nolan Schanuel to 2nd. Throwing error by shortstop David Hamilton."        
[2] "Ryan Jeffers reaches on a fielder's choice, fielded by second baseman Colt Keith. Byron Buxton scores. Ryan Jeffers out at 2nd, catcher Jake Rogers to first baseman Mark Canha."</code></pre>
</div>
</div>
<p>We will manually change the value of <code>end_events</code> in row 65138 to “fielders_choice_out”. For fitting our out probability model, we will focus only on those at-bats that did not end with a home run. We will also drop at-bats for which the batted ball locations are missing.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>bip<span class="sc">$</span>end_events[<span class="dv">65138</span>] <span class="ot">&lt;-</span> <span class="st">"fielders_choice_out"</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>out_events <span class="ot">&lt;-</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"double_play"</span>, <span class="st">"field_out"</span>, <span class="st">"fielders_choice_out"</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"force_out"</span>, <span class="st">"grounded_into_double_play"</span>, </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sac_bunt"</span>, <span class="st">"sac_fly"</span>, <span class="st">"sac_fly_double_play"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"triple_play"</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>bip <span class="ot">&lt;-</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  bip <span class="sc">|&gt;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(end_events <span class="sc">!=</span> <span class="st">"home_run"</span> <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y)) <span class="sc">|&gt;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">Out =</span> <span class="fu">ifelse</span>(end_events <span class="sc">%in%</span> out_events, <span class="dv">1</span>, <span class="dv">0</span>)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="binning-and-averaging" class="level3">
<h3 class="anchored" data-anchor-id="binning-and-averaging">Binning and Averaging</h3>
<p>One potential approach works by dividing the field into small rectangular regions and computing the proportion of balls landing within each region that result in an out. To this end, we will first create a grid of 3ft x 3ft squares that covers the range of our batted ball locations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(bip<span class="sc">$</span>x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -287.725  290.575</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">range</span>(bip<span class="sc">$</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -91.85 459.35</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-15"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="1">1</button><span id="annotated-cell-15-1" class="code-annotation-target"><a href="#annotated-cell-15-1" aria-hidden="true" tabindex="-1"></a>grid_sep <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="2">2</button><span id="annotated-cell-15-2" class="code-annotation-target"><a href="#annotated-cell-15-2" aria-hidden="true" tabindex="-1"></a>x_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="dv">300</span>, <span class="at">to =</span> <span class="dv">300</span>, <span class="at">by =</span> grid_sep)</span>
<span id="annotated-cell-15-3"><a href="#annotated-cell-15-3" aria-hidden="true" tabindex="-1"></a>y_grid <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from =</span> <span class="sc">-</span><span class="dv">100</span>, <span class="at">to =</span> <span class="dv">500</span>, <span class="at">by =</span> grid_sep)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="3">3</button><span id="annotated-cell-15-4" class="code-annotation-target"><a href="#annotated-cell-15-4" aria-hidden="true" tabindex="-1"></a>raw_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x =</span> x_grid, <span class="at">y =</span> y_grid)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-15" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="1" data-code-annotation="1">Separation between grid points in each dimension.</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="2" data-code-annotation="2">Creates a sequence of evenly-spaced points</span>
</dd>
<dt data-target-cell="annotated-cell-15" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="4" data-code-annotation="3">Creates a table with every combination of values in <code>x_grid</code> and <code>y_grid</code></span>
</dd>
</dl>
</div>
</div>
<p>The table <code>grid</code> contains many combinations of <code>x</code> and <code>y</code> that do not represent plausible batted ball locations. In the figure below, we plot all batted ball locations and overlay all the grid points.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bip<span class="sc">$</span>x, bip<span class="sc">$</span>y, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">300</span>, <span class="dv">300</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">500</span>),</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.2</span>, </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>(oi_colors[<span class="dv">1</span>], <span class="at">alpha.f =</span> <span class="fl">0.2</span>))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(raw_grid<span class="sc">$</span>x, raw_grid<span class="sc">$</span>y, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.2</span>, </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">adjustcolor</span>(oi_colors[<span class="dv">3</span>], <span class="at">alpha.f =</span> <span class="fl">0.3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-grid" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="lecture08_files/figure-html/fig-grid-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4" title="Figure&nbsp;4: The initial grid of points contains many locations at which we would not expect balls to be fielded."><img src="lecture08_files/figure-html/fig-grid-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: The initial grid of points contains many locations at which we would not expect balls to be fielded.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We will remove those <code>(x,y)</code> pairs in <code>grid</code> for which either</p>
<ol type="1">
<li><code>x + y &lt; -100</code>: these are locations far below the third base line</li>
<li><code>y - x &lt; -100</code>: these are locations far below the first base line</li>
<li><code>sqrt(x^2 +y^2 &lt; 580)</code>: these are locations very far from home plate</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  raw_grid <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(y <span class="sc">+</span> x <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">100</span> <span class="sc">&amp;</span> y <span class="sc">-</span> x <span class="sc">&gt;</span> <span class="sc">-</span><span class="dv">100</span> <span class="sc">&amp;</span> <span class="fu">sqrt</span>(x<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> y<span class="sc">^</span><span class="dv">2</span>) <span class="sc">&lt;</span> <span class="dv">580</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(bip<span class="sc">$</span>x, bip<span class="sc">$</span>y, </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">300</span>, <span class="dv">300</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">500</span>),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.2</span>, </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">adjustcolor</span>(oi_colors[<span class="dv">1</span>], <span class="at">alpha.f =</span> <span class="fl">0.2</span>))</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(grid<span class="sc">$</span>x, grid<span class="sc">$</span>y, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.2</span>, </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">adjustcolor</span>(oi_colors[<span class="dv">3</span>], <span class="at">alpha.f =</span> <span class="fl">0.3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-restrict-grid" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-restrict-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="lecture08_files/figure-html/fig-restrict-grid-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5" title="Figure&nbsp;5: A restricted grid of spatial locations."><img src="lecture08_files/figure-html/fig-restrict-grid-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-restrict-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: A restricted grid of spatial locations.
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can use the <code>cut()</code> function to divide the <code>x</code> and <code>y</code> values in <code>bip</code> into small bins. Here is a quick example of how <code>cut</code> works: we first create a vector with a few numbers. The <code>breaks</code> argument of <code>cut</code> tells it the end points of each bin.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.11</span>, <span class="fl">0.23</span>, <span class="fl">0.45</span>, <span class="fl">0.67</span>, <span class="fl">0.99</span>, <span class="fl">0.02</span>) </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cut</span>(x, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by =</span> <span class="fl">0.1</span>))  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] (0.1,0.2] (0.2,0.3] (0.4,0.5] (0.6,0.7] (0.9,1]   (0,0.1]  
10 Levels: (0,0.1] (0.1,0.2] (0.2,0.3] (0.3,0.4] (0.4,0.5] ... (0.9,1]</code></pre>
</div>
</div>
<p>Below, we first <code>cut</code> the values of <code>x</code> and <code>y</code> that appear in <code>bip</code>. Then, using a grouped summary, we can compute the number of balls hit to each bin and the proportion of those balls that result in an out.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-19"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-19-1"><a href="#annotated-cell-19-1" aria-hidden="true" tabindex="-1"></a>bin_probs <span class="ot">&lt;-</span></span>
<span id="annotated-cell-19-2"><a href="#annotated-cell-19-2" aria-hidden="true" tabindex="-1"></a>  bip <span class="sc">|&gt;</span></span>
<span id="annotated-cell-19-3"><a href="#annotated-cell-19-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(x, y, Out) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-19-4"><a href="#annotated-cell-19-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="1">1</button><span id="annotated-cell-19-5" class="code-annotation-target"><a href="#annotated-cell-19-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_bin =</span> <span class="fu">cut</span>(x, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">300</span><span class="sc">-</span>grid_sep<span class="sc">/</span><span class="dv">2</span>, <span class="dv">300</span><span class="sc">+</span>grid_sep<span class="sc">/</span><span class="dv">2</span>, <span class="at">by =</span> grid_sep)),</span>
<span id="annotated-cell-19-6"><a href="#annotated-cell-19-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_bin =</span> <span class="fu">cut</span>(y, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">100</span> <span class="sc">-</span> grid_sep<span class="sc">/</span><span class="dv">2</span>, <span class="dv">500</span><span class="sc">+</span>grid_sep<span class="sc">/</span><span class="dv">2</span>, <span class="at">by =</span> grid_sep))) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-19-7"><a href="#annotated-cell-19-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(x_bin, y_bin) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-19-8"><a href="#annotated-cell-19-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="annotated-cell-19-9"><a href="#annotated-cell-19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">out_prob =</span> <span class="fu">mean</span>(Out), </span>
<span id="annotated-cell-19-10"><a href="#annotated-cell-19-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_balls =</span> dplyr<span class="sc">::</span><span class="fu">n</span>(),</span>
<span id="annotated-cell-19-11"><a href="#annotated-cell-19-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-19" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="5" data-code-annotation="1">Offsetting by <code>grid_sep/2</code> ensures that the <code>x</code> and <code>y</code> values in <code>grid</code> are the <em>centers</em> of the squares in our grid (and not one of the corners)</span>
</dd>
</dl>
</div>
</div>
<p>We can now bin the <code>x</code> and <code>y</code> values contained in <code>grid</code> and, using a <code>left_join()</code>, append a column that contains the estimated probability of an out hit to each 3ft x 3ft square in our grid. Note that if there is a combination of <code>x_bin</code> and <code>y_bin</code> in <code>grid</code> that is not contained in <code>bin_prob</code>, the estimated probability will be <code>NA</code>. These are grid squares in which no balls were hit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>grid_probs_bin <span class="ot">&lt;-</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  grid <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x_bin =</span> <span class="fu">cut</span>(x, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">300</span><span class="sc">-</span>grid_sep<span class="sc">/</span><span class="dv">2</span>, <span class="dv">300</span><span class="sc">+</span>grid_sep<span class="sc">/</span><span class="dv">2</span>, <span class="at">by =</span> <span class="dv">3</span>)),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y_bin =</span> <span class="fu">cut</span>(y, <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">100</span><span class="sc">-</span>grid_sep<span class="sc">/</span><span class="dv">2</span>, <span class="dv">500</span><span class="sc">+</span>grid_sep<span class="sc">/</span><span class="dv">2</span>, <span class="at">by =</span> <span class="dv">3</span>))) <span class="sc">|&gt;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(<span class="at">y =</span> bin_probs, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"x_bin"</span>, <span class="st">"y_bin"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now make a heatmap of our estimated probabilities by looping over the rows in <code>grid_prob_bins</code>, drawing a small rectangle with corners <code>(x-1.5, y-1.5)</code>, <code>(x + 1.5, y-1.5)</code>, <code>(x+1.5, y+1.5)</code>, and <code>(x-1.5, y+1.5)</code>, and shading the rectangle based on the corresponding out probability.</p>
<!-- redraw and add a legend at the top -->
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="annotated-cell-21"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="1">1</button><span id="annotated-cell-21-1" class="code-annotation-target"><a href="#annotated-cell-21-1" aria-hidden="true" tabindex="-1"></a>col_list <span class="ot">&lt;-</span> colorBlindness<span class="sc">::</span>Blue2DarkRed18Steps</span>
<span id="annotated-cell-21-2"><a href="#annotated-cell-21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-21-3"><a href="#annotated-cell-21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">1</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="2">2</button><span id="annotated-cell-21-4" class="code-annotation-target"><a href="#annotated-cell-21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span>, <span class="at">type =</span> <span class="st">"n"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="3">3</button><span id="annotated-cell-21-5" class="code-annotation-target"><a href="#annotated-cell-21-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">300</span>, <span class="dv">300</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">500</span>),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="4">4</button><span id="annotated-cell-21-6" class="code-annotation-target"><a href="#annotated-cell-21-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">yaxt =</span> <span class="st">"n"</span>, <span class="at">bty =</span> <span class="st">"n"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="5">5</button><span id="annotated-cell-21-7" class="code-annotation-target"><a href="#annotated-cell-21-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Naive out probabilities"</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>)</span>
<span id="annotated-cell-21-8"><a href="#annotated-cell-21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-21-9"><a href="#annotated-cell-21-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_probs_bin)){</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="6">6</button><span id="annotated-cell-21-10" class="code-annotation-target"><a href="#annotated-cell-21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rect</span>(<span class="at">xleft =</span> grid_probs_bin<span class="sc">$</span>x[i] <span class="sc">-</span> grid_sep<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="annotated-cell-21-11"><a href="#annotated-cell-21-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">ybot =</span> grid_probs_bin<span class="sc">$</span>y[i] <span class="sc">-</span> grid_sep<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="annotated-cell-21-12"><a href="#annotated-cell-21-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">xright =</span> grid_probs_bin<span class="sc">$</span>x[i] <span class="sc">+</span> grid_sep<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="annotated-cell-21-13"><a href="#annotated-cell-21-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">ytop =</span> grid_probs_bin<span class="sc">$</span>y[i] <span class="sc">+</span> grid_sep<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="annotated-cell-21-14"><a href="#annotated-cell-21-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">ifelse</span>(</span>
<span id="annotated-cell-21-15"><a href="#annotated-cell-21-15" aria-hidden="true" tabindex="-1"></a>         <span class="fu">is.na</span>(grid_probs_bin<span class="sc">$</span>out_prob[i]), </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="7">7</button><span id="annotated-cell-21-16" class="code-annotation-target"><a href="#annotated-cell-21-16" aria-hidden="true" tabindex="-1"></a>         <span class="fu">adjustcolor</span>(oi_colors[<span class="dv">1</span>], <span class="at">alpha.f =</span> <span class="fl">0.2</span>),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="8">8</button><span id="annotated-cell-21-17" class="code-annotation-target"><a href="#annotated-cell-21-17" aria-hidden="true" tabindex="-1"></a>         <span class="fu">adjustcolor</span>(<span class="fu">rgb</span>(<span class="fu">colorRamp</span>(col_list,<span class="at">bias=</span><span class="dv">1</span>)(grid_probs_bin<span class="sc">$</span>out_prob[i])<span class="sc">/</span><span class="dv">255</span>),</span>
<span id="annotated-cell-21-18"><a href="#annotated-cell-21-18" aria-hidden="true" tabindex="-1"></a>                     <span class="at">alpha.f =</span> <span class="fl">0.5</span>)),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="9">9</button><span id="annotated-cell-21-19" class="code-annotation-target"><a href="#annotated-cell-21-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="annotated-cell-21-20"><a href="#annotated-cell-21-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-21-21"><a href="#annotated-cell-21-21" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">col =</span> oi_colors[<span class="dv">5</span>], <span class="at">lwd =</span> <span class="dv">2</span>) </span>
<span id="annotated-cell-21-22"><a href="#annotated-cell-21-22" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">col =</span> oi_colors[<span class="dv">5</span>], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="annotated-cell-21-23"><a href="#annotated-cell-21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-21-24"><a href="#annotated-cell-21-24" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>) </span>
<span id="annotated-cell-21-25"><a href="#annotated-cell-21-25" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="annotated-cell-21-26"><a href="#annotated-cell-21-26" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">0</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="annotated-cell-21-27"><a href="#annotated-cell-21-27" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">0</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="annotated-cell-21-28"><a href="#annotated-cell-21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-21-29"><a href="#annotated-cell-21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-21-30"><a href="#annotated-cell-21-30" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="annotated-cell-21-31"><a href="#annotated-cell-21-31" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">y =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="annotated-cell-21-32"><a href="#annotated-cell-21-32" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">y =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>,<span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="annotated-cell-21-33"><a href="#annotated-cell-21-33" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-21" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="1" data-code-annotation="1">This is a popular diverging color palette, which ranges from blue to red, that is color-blind friendly. See <a href="https://cran.r-project.org/web/packages/colorBlindness/vignettes/colorBlindness.html#Collection_of_safe_colors">here</a> for more details.</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="4" data-code-annotation="2">Specifying <code>type = "n"</code> tells R to make an empty plot</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="5" data-code-annotation="3">Manually set the horizontal and vertical limits of the plotting area</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="6" data-code-annotation="4"><code>xaxt = "n"</code> and <code>yaxt = "n"</code> suppress the axis lines and <code>bty = "n"</code> suppresses the bounding box</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="7" data-code-annotation="5"><code>main</code> controls the title of plot while setting <code>xlab = ""</code> and <code>ylab = ""</code> suppresses horizontal and vertical axis labels</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="10" data-code-annotation="6">To use <code>rect()</code>, we must pass the coordinates of the bottom left and top right corners of the rectangle</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="16" data-code-annotation="7">If there were no balls hit to a particular rectangle, we will color it gray. Otherwise, we will color it according to the fitted probability</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="17" data-code-annotation="8">The expression <code>rgb(colorRamp(col_list, bias=1)(grid_probs_bin$out_prob)/255)</code> maps the fitted probability to a color in <code>col_list</code> using linear interpolation. Here 0% maps to dark blue and 100% maps to dark red.</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="19" data-code-annotation="9">Suppresses the border of the rectangle</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div id="fig-bin-probs" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bin-probs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="lecture08_files/figure-html/fig-bin-probs-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6" title="Figure&nbsp;6: Empirical out probabilities based on binning balls in play."><img src="lecture08_files/figure-html/fig-bin-probs-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-bin-probs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Empirical out probabilities based on binning balls in play.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-logistic" class="level3">
<h3 class="anchored" data-anchor-id="sec-logistic">A Logistic Regression Model for Outs</h3>
<p>Our naively estimated out probabilities leave much to be desired. For one thing, there are lots of “gaps” in the fitted surface where our initial model can’t make a prediction. These are the cells in our grid into which no balls were hit. Of much greater concern are the sharp discontinuities evident in the figure. In fact, there are many regions where the fitted out probability jumps from 0% to 100% to 0% in the span of about 6 feet. Such discontinuities are <em>artifacts</em> of the small sample sizes within some of the bins. Indeed, we find that about 85% of the grid cells contain 10 or fewer observations</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(bin_probs<span class="sc">$</span>n_balls <span class="sc">&lt;=</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8541364</code></pre>
</div>
</div>
<p>Like we did to predict <a href="lecture03#sec-logistic.qmd">XG using shot distance</a>, we can overcome this challenge by building a statistical model. In particular, we would like to model the log-odds of an out as a function of the batted balls location. That is, <span class="math display">\[
\log\left(\frac{\mathbb{P}(\textrm{out})}{1 - \mathbb{P}(\textrm{out})} \right) = s(x,y),
\]</span> where <span class="math inline">\(s\)</span> is a smooth function of the batted balls location. What form should <span class="math inline">\(s\)</span> take?</p>
<p>One possibility is to assume that there are parameters <span class="math inline">\(\beta_{0}, \beta_{x},\)</span> and <span class="math inline">\(\beta_{y}\)</span> such that <span class="math display">\[
\log\left(\frac{\mathbb{P}(\textrm{out})}{1 - \mathbb{P}(\textrm{out})} \right) = \beta_{0} + \beta_{x}x + \beta_{y}y
\]</span> We can estimate these parameters using <code>glm()</code> and then compute the fitted probability for every cell in our grid.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-23"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-23-1"><a href="#annotated-cell-23-1" aria-hidden="true" tabindex="-1"></a>logit_fit <span class="ot">&lt;-</span></span>
<span id="annotated-cell-23-2"><a href="#annotated-cell-23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glm</span>(Out <span class="sc">~</span> x <span class="sc">+</span> y,</span>
<span id="annotated-cell-23-3"><a href="#annotated-cell-23-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>), <span class="at">data =</span> bip)</span>
<span id="annotated-cell-23-4"><a href="#annotated-cell-23-4" aria-hidden="true" tabindex="-1"></a>grid_logit_preds <span class="ot">&lt;-</span></span>
<span id="annotated-cell-23-5"><a href="#annotated-cell-23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(<span class="at">object =</span> logit_fit, </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="1">1</button><span id="annotated-cell-23-6" class="code-annotation-target"><a href="#annotated-cell-23-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">newdata =</span> grid, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="annotated-cell-23-7"><a href="#annotated-cell-23-7" aria-hidden="true" tabindex="-1"></a>grid_logit_cols <span class="ot">&lt;-</span> </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-23" data-target-annotation="2">2</button><span id="annotated-cell-23-8" class="code-annotation-target"><a href="#annotated-cell-23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgb</span>(<span class="fu">colorRamp</span>(col_list,<span class="at">bias=</span><span class="dv">1</span>)(grid_logit_preds)<span class="sc">/</span><span class="dv">255</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-23" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="6" data-code-annotation="1">To get fitted values on the probability scale, we need to specify <code>type = "response"</code></span>
</dd>
<dt data-target-cell="annotated-cell-23" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-23" data-code-lines="8" data-code-annotation="2">Creates a vector mapping the fitted probability at each grid location to a color between the two extremes</span>
</dd>
</dl>
</div>
</div>
<p>The fitted logistic regression model predicts that the probability of an out decreases as one moves vertically away from home plate. The model further predicts that balls hit into the outfield tend not to result in outs, which is at odds with what we see in the data. Indeed, our earlier plot revealed pockets of high out probability in the outfield, roughly corresponding to the usual positioning of the left, right, and center fielders.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="annotated-cell-24"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-24-1"><a href="#annotated-cell-24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">1</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<span id="annotated-cell-24-2"><a href="#annotated-cell-24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span>, <span class="at">type =</span> <span class="st">"n"</span>, </span>
<span id="annotated-cell-24-3"><a href="#annotated-cell-24-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">300</span>, <span class="dv">300</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">500</span>), </span>
<span id="annotated-cell-24-4"><a href="#annotated-cell-24-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">yaxt =</span> <span class="st">"n"</span>, <span class="at">bty =</span> <span class="st">"n"</span>, </span>
<span id="annotated-cell-24-5"><a href="#annotated-cell-24-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Logistic regression out probabilities"</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>)</span>
<span id="annotated-cell-24-6"><a href="#annotated-cell-24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-24-7"><a href="#annotated-cell-24-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_probs_bin)){</span>
<span id="annotated-cell-24-8"><a href="#annotated-cell-24-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rect</span>(<span class="at">xleft =</span> grid_probs_bin<span class="sc">$</span>x[i] <span class="sc">-</span> grid_sep<span class="sc">/</span><span class="dv">2</span>, </span>
<span id="annotated-cell-24-9"><a href="#annotated-cell-24-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">ybot =</span> grid_probs_bin<span class="sc">$</span>y[i] <span class="sc">-</span> grid_sep<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="annotated-cell-24-10"><a href="#annotated-cell-24-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">xright =</span> grid_probs_bin<span class="sc">$</span>x[i] <span class="sc">+</span> grid_sep<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="annotated-cell-24-11"><a href="#annotated-cell-24-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">ytop =</span> grid_probs_bin<span class="sc">$</span>y[i] <span class="sc">+</span> grid_sep<span class="sc">/</span><span class="dv">2</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-24" data-target-annotation="1">1</button><span id="annotated-cell-24-12" class="code-annotation-target"><a href="#annotated-cell-24-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">adjustcolor</span>(grid_logit_cols[i], <span class="at">alpha.f =</span> <span class="fl">0.5</span>),</span>
<span id="annotated-cell-24-13"><a href="#annotated-cell-24-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="annotated-cell-24-14"><a href="#annotated-cell-24-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-24-15"><a href="#annotated-cell-24-15" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">col =</span> oi_colors[<span class="dv">5</span>], <span class="at">lwd =</span> <span class="dv">2</span>) </span>
<span id="annotated-cell-24-16"><a href="#annotated-cell-24-16" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">col =</span> oi_colors[<span class="dv">5</span>], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="annotated-cell-24-17"><a href="#annotated-cell-24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-24-18"><a href="#annotated-cell-24-18" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>) </span>
<span id="annotated-cell-24-19"><a href="#annotated-cell-24-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="annotated-cell-24-20"><a href="#annotated-cell-24-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">0</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="annotated-cell-24-21"><a href="#annotated-cell-24-21" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">0</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="annotated-cell-24-22"><a href="#annotated-cell-24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-24-23"><a href="#annotated-cell-24-23" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="annotated-cell-24-24"><a href="#annotated-cell-24-24" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">y =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="annotated-cell-24-25"><a href="#annotated-cell-24-25" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">y =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>,<span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="annotated-cell-24-26"><a href="#annotated-cell-24-26" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-24" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-24" data-code-lines="12" data-code-annotation="1">Unlike with binning-and-averaging, our parametric model is able to make predictions at grid cells not present in the training data. So, we don’t need to check whether the predicted probability is <code>NA</code></span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div id="fig-logistic-fit" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-logistic-fit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="lecture08_files/figure-html/fig-logistic-fit-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7" title="Figure&nbsp;7: Logistic regression forecasts of out probabilities as a function of location."><img src="lecture08_files/figure-html/fig-logistic-fit-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-logistic-fit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Logistic regression forecasts of out probabilities as a function of location.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-gam" class="level2">
<h2 class="anchored" data-anchor-id="sec-gam">Generalized Additive Models</h2>
<p>The root cause of the conflict between our data and the logistic regression model forecasts in <a href="#fig-logistic-fit" class="quarto-xref">Figure&nbsp;7</a> is the model’s strong — and totally unrealistic — assumption that the log-odds of an out is <em>linear</em> in both <span class="math inline">\(x\)</span> and <span class="math inline">\(y.\)</span> A more accurate model would allow the log-odds to vary non-linearly.</p>
<p>Generalized Additive Models (or GAMs) are an elegant way to introduce non-linearity and create spatially smooth maps. In our context, a GAM model expresses <span class="math inline">\(s(x,y)\)</span> as a linear combination of a large number of two-dimensional <em>splines</em> functions. Each spline function is a piecewise polynomial that is localized to a small region of <span class="math inline">\((x,y)\)</span> space, meaning that it is non-zero inside the region and zero outside the region. Such spline functions can be linearly combined to approximate really complicated functions arbitrarily well<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>We can fit GAMs in R using the <a href="https://cran.r-project.org/web/packages/mgcv/refman/mgcv.html"><strong>mgcv</strong></a> package, which can be installed using</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"mgcv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The package provides two fitting functions, <code>gam()</code> and <code>bam()</code>, which is recommended for very large data sets like <code>bip</code>. Both functions are similar <code>lm()</code> and <code>glm()</code> in that they require users to specify a formula and, in the case of non-continuous outcomes, a link function. The main difference is the term <code>s()</code>, which is used to signal to <code>gam()</code> or <code>bam()</code> that we want to smooth over whatever variables appear inside of the brackets of <code>s()</code>. In our case, because we wish to smooth over both <code>x</code> and <code>y</code>, we will include the terms <code>s(x,y)</code></p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Fitting our out probability model takes a few minutes</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>gam_fit <span class="ot">&lt;-</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bam</span>(<span class="at">formula =</span> Out <span class="sc">~</span> <span class="fu">s</span>(x,y), </span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>), <span class="at">data =</span> bip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>After fitting our GAM, we can visualize the estimated out probabilities:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>grid_gam_preds <span class="ot">&lt;-</span> </span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(<span class="at">object =</span> gam_fit,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">newdata =</span> grid, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>grid_gam_cols <span class="ot">&lt;-</span>   </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rgb</span>(<span class="fu">colorRamp</span>(col_list,<span class="at">bias=</span><span class="dv">1</span>)(grid_gam_preds)<span class="sc">/</span><span class="dv">255</span>) </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">1</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span>, <span class="at">type =</span> <span class="st">"n"</span>, </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">300</span>, <span class="dv">300</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="dv">500</span>), </span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>     <span class="at">xaxt =</span> <span class="st">"n"</span>, <span class="at">yaxt =</span> <span class="st">"n"</span>, <span class="at">bty =</span> <span class="st">"n"</span>, </span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"GAM out probabilities"</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid_probs_bin)){</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rect</span>(<span class="at">xleft =</span> grid_probs_bin<span class="sc">$</span>x[i] <span class="sc">-</span> grid_sep<span class="sc">/</span><span class="dv">2</span>, </span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">ybot =</span> grid_probs_bin<span class="sc">$</span>y[i] <span class="sc">-</span> grid_sep<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">xright =</span> grid_probs_bin<span class="sc">$</span>x[i] <span class="sc">+</span> grid_sep<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>       <span class="at">ytop =</span> grid_probs_bin<span class="sc">$</span>y[i] <span class="sc">+</span> grid_sep<span class="sc">/</span><span class="dv">2</span>,</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">adjustcolor</span>(grid_gam_cols[i], <span class="at">alpha.f =</span> <span class="fl">0.5</span>),</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">border =</span> <span class="cn">NA</span>)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>, <span class="at">col =</span> oi_colors[<span class="dv">5</span>], <span class="at">lwd =</span> <span class="dv">2</span>) </span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">col =</span> oi_colors[<span class="dv">5</span>], <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>) </span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">0</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">0</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>)), <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">y =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="sc">-</span><span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">y =</span> <span class="dv">90</span><span class="sc">/</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>,<span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="at">x =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="dv">90</span><span class="sc">*</span><span class="fu">sqrt</span>(<span class="dv">2</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">col =</span> <span class="st">"white"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-out-gam" class="quarto-float quarto-figure quarto-figure-center anchored" width="576" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-out-gam-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="lecture08_files/figure-html/fig-out-gam-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8" title="Figure&nbsp;8: "><img src="lecture08_files/figure-html/fig-out-gam-1.png" id="fig-out-gam" class="img-fluid quarto-figure quarto-figure-center anchored figure-img" width="576"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-out-gam-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8
</figcaption>
</figure>
</div>
</div>
</div>
<p>The out probabilities fitted by the GAM appear <strong>much</strong> more reasonable: balls hit within the in-field and close to the outfielders tend to be result in outs while balls hit in the gap between the infield and outfield tend not to result in outs.</p>
<section id="sec-divide-delta" class="level3">
<h3 class="anchored" data-anchor-id="sec-divide-delta">Dividing Defensive Run Value</h3>
<p>Recall that if at-bat <span class="math inline">\(i\)</span> results in a ball put in play, we will distribute <span class="math inline">\(\delta_{i}^{(f)} = -\delta_{i} \times \hat{p}_{i}\)</span> to the fielders and assign <span class="math inline">\(\delta_{i}^{(p)} = -\delta \times (1 - \hat{p}_{i})\)</span> to the pitcher. The following code adds a column to <code>def_atbat2024</code> containing the predicted out probabilities from our fitted GAM. Note that this column contains <code>NA</code> values for those at-bats that did not result in a ball in play (e.g., they ended with a walk or a strikeout or a home run) For the vast majority of these at-bats, we will manually set <span class="math inline">\(\hat{p}_{i} = 0\)</span> so that the pitcher gets all the credit (i.e., <span class="math inline">\(\delta^{(p)}_{i} = -\delta_{i}\)</span>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-29"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-29-1"><a href="#annotated-cell-29-1" aria-hidden="true" tabindex="-1"></a>all_preds <span class="ot">&lt;-</span></span>
<span id="annotated-cell-29-2"><a href="#annotated-cell-29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(<span class="at">object =</span> gam_fit, </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="1">1</button><span id="annotated-cell-29-3" class="code-annotation-target"><a href="#annotated-cell-29-3" aria-hidden="true" tabindex="-1"></a>          <span class="at">newdata =</span> def_atbat2024,</span>
<span id="annotated-cell-29-4"><a href="#annotated-cell-29-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">type =</span> <span class="st">"response"</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="2">2</button><span id="annotated-cell-29-5" class="code-annotation-target"><a href="#annotated-cell-29-5" aria-hidden="true" tabindex="-1"></a>def_atbat2024<span class="sc">$</span>p_out <span class="ot">&lt;-</span> all_preds</span>
<span id="annotated-cell-29-6"><a href="#annotated-cell-29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-29-7"><a href="#annotated-cell-29-7" aria-hidden="true" tabindex="-1"></a>def_atbat2024 <span class="ot">&lt;-</span></span>
<span id="annotated-cell-29-8"><a href="#annotated-cell-29-8" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="annotated-cell-29-9"><a href="#annotated-cell-29-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="annotated-cell-29-10"><a href="#annotated-cell-29-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_out =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="3">3</button><span id="annotated-cell-29-11" class="code-annotation-target"><a href="#annotated-cell-29-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(p_out) <span class="sc">&amp;</span> end_events <span class="sc">==</span> <span class="st">"home_run"</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-29" data-target-annotation="4">4</button><span id="annotated-cell-29-12" class="code-annotation-target"><a href="#annotated-cell-29-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(p_out) <span class="sc">&amp;</span> end_type <span class="sc">!=</span> <span class="st">"X"</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="annotated-cell-29-13"><a href="#annotated-cell-29-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> p_out))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-29" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="3" data-code-annotation="1">When <code>x</code> and <code>y</code> are <code>NA</code> (i.e., whenever the at-bat doesn’t end with a ball in play), <code>predict</code> will return <code>NA</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="5" data-code-annotation="2">Adds fitted out probabilities to the data table</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="11" data-code-annotation="3">For home runs, manually set <code>p_out = 0</code> (so pitcher gets all credit/blame)</span>
</dd>
<dt data-target-cell="annotated-cell-29" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-29" data-code-lines="12" data-code-annotation="4">For at-bats that end with a ball or strike, set <code>p_out = 0</code> (so pitcher gets all credit/blame)</span>
</dd>
</dl>
</div>
</div>
<p>Even after manually setting <span class="math inline">\(\hat{p}_{i} = 0\)</span> on the at-bats that didn’t end with the ball in play, there are still some <code>NA</code> values in the column <code>p_out</code>. On further inspection, it looks like these were at-bats in which the ball was put in play but are missing hit locations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(def_atbat2024<span class="sc">$</span>end_events[<span class="fu">is.na</span>(def_atbat2024<span class="sc">$</span>p_out)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                   double                 field_out grounded_into_double_play 
                        2                         5                         1 
                   single                    triple 
                        4                         1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">is.na</span>(def_atbat2024<span class="sc">$</span>x[<span class="fu">is.na</span>(def_atbat2024<span class="sc">$</span>p_out)]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 13</code></pre>
</div>
</div>
<p>We will remove these rows from our calculations</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>def_atbat2024 <span class="ot">&lt;-</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(p_out))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now finally compute <span class="math inline">\(\delta^{(f)}_{i}\)</span> and <span class="math inline">\(\delta^{(p)}_{i}\)</span> for each at-bat.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>def_atbat2024 <span class="ot">&lt;-</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_p =</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> p_out) <span class="sc">*</span> RunValue,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_f =</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> p_out <span class="sc">*</span> RunValue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="sec-fielding" class="level2">
<h2 class="anchored" data-anchor-id="sec-fielding">Fielding Run Values</h2>
<p>If a ball is hit towards deep left field and results in the fielding team creating a large <span class="math inline">\(-\delta\)</span>, how much blame should the third baseman, who is on the opposite side of the park receive? Following <span class="citation" data-cites="Baumer2015_openWAR">Baumer, Jensen, and Matthews (<a href="#ref-Baumer2015_openWAR" role="doc-biblioref">2015</a>)</span>, we will apportion <span class="math inline">\(\delta_{i}^{(f)},\)</span> the portion of the run value <span class="math inline">\(-\delta_{i}\)</span> attributable to the fielding in at-bat <span class="math inline">\(i\)</span>, based on each fielder’s responsibility for making an out on the batted ball. Specifically, we will assign <span class="math inline">\(w_{i,\ell} \times \delta_{i}^{(f)}\)</span> to the fielder playing position <span class="math inline">\(\ell \in \{1, 2, \ldots, 9\}\)</span> during the at-bat where <span class="math display">\[
w_{i,\ell} = \frac{\hat{p}_{i,\ell}}{\hat{p}_{i,1} + \cdots + \hat{p}_{i,9}}
\]</span> and <span class="math inline">\(\hat{p}_{i,\ell}\)</span> is the probability that fielder <span class="math inline">\(\ell\)</span> makes the out given the location of the batted ball.</p>
<p>To estimate the <span class="math inline">\(\hat{p}_{i,\ell}\)</span>’s, we will fit 9 separate GAMs, one for each fielding position. For fielding position <span class="math inline">\(\ell,\)</span> we will create a new variable that is equal to 1 if the ball in play resulted in an out was initially fielded by the player at position <span class="math inline">\(\ell.\)</span> Unlike our overall out probability model, which we fit using data from all batted balls, each position-specific GAM will be fitted using data from the subset of batted balls that are reasonably close to the typical position location. For instance, when fitting the model for the first basemen, we won’t include data from balls hit into deep left field. We compute the coordinates of the typical position by taking the average value of the <code>x</code> and <code>y</code> coordinates of all batted balls fielded by players at position <span class="math inline">\(\ell.\)</span> We fit each position-specific GAM using batted balls hit within 150 ft of this typical location<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This code takes between several minutes to run</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-34"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="1">1</button><span id="annotated-cell-34-1" class="code-annotation-target"><a href="#annotated-cell-34-1" aria-hidden="true" tabindex="-1"></a>mid_x <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> <span class="dv">9</span>)</span>
<span id="annotated-cell-34-2"><a href="#annotated-cell-34-2" aria-hidden="true" tabindex="-1"></a>mid_y <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> <span class="dv">9</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="2">2</button><span id="annotated-cell-34-3" class="code-annotation-target"><a href="#annotated-cell-34-3" aria-hidden="true" tabindex="-1"></a>fit_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="annotated-cell-34-4"><a href="#annotated-cell-34-4" aria-hidden="true" tabindex="-1"></a>fit_time <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> <span class="dv">9</span>)</span>
<span id="annotated-cell-34-5"><a href="#annotated-cell-34-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(l <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>){</span>
<span id="annotated-cell-34-6"><a href="#annotated-cell-34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">"Starting l = "</span>, <span class="fu">Sys.time</span>()))</span>
<span id="annotated-cell-34-7"><a href="#annotated-cell-34-7" aria-hidden="true" tabindex="-1"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="3">3</button><span id="annotated-cell-34-8" class="code-annotation-target"><a href="#annotated-cell-34-8" aria-hidden="true" tabindex="-1"></a>  mid_x[l] <span class="ot">&lt;-</span> <span class="fu">mean</span>(bip<span class="sc">$</span>x[bip<span class="sc">$</span>end_hit_location <span class="sc">==</span> l], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="annotated-cell-34-9"><a href="#annotated-cell-34-9" aria-hidden="true" tabindex="-1"></a>  mid_y[l] <span class="ot">&lt;-</span> <span class="fu">mean</span>(bip<span class="sc">$</span>y[bip<span class="sc">$</span>end_hit_location<span class="sc">==</span>l], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="annotated-cell-34-10"><a href="#annotated-cell-34-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-34-11"><a href="#annotated-cell-34-11" aria-hidden="true" tabindex="-1"></a>  train_df <span class="ot">&lt;-</span></span>
<span id="annotated-cell-34-12"><a href="#annotated-cell-34-12" aria-hidden="true" tabindex="-1"></a>    bip <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="4">4</button><span id="annotated-cell-34-13" class="code-annotation-target"><a href="#annotated-cell-34-13" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">newOut =</span> <span class="fu">ifelse</span>(Out <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> end_hit_location <span class="sc">==</span> l, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-34-14"><a href="#annotated-cell-34-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(x) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y)) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="5">5</button><span id="annotated-cell-34-15" class="code-annotation-target"><a href="#annotated-cell-34-15" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>( <span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[l])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[l])<span class="sc">^</span><span class="dv">2</span> ) <span class="sc">&lt;</span> <span class="dv">150</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-34-16"><a href="#annotated-cell-34-16" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(x,y,newOut) </span>
<span id="annotated-cell-34-17"><a href="#annotated-cell-34-17" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="6">6</button><span id="annotated-cell-34-18" class="code-annotation-target"><a href="#annotated-cell-34-18" aria-hidden="true" tabindex="-1"></a>  fit_time[l] <span class="ot">&lt;-</span></span>
<span id="annotated-cell-34-19"><a href="#annotated-cell-34-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">system.time</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="7">7</button><span id="annotated-cell-34-20" class="code-annotation-target"><a href="#annotated-cell-34-20" aria-hidden="true" tabindex="-1"></a>      fit_list[[l]] <span class="ot">&lt;-</span></span>
<span id="annotated-cell-34-21"><a href="#annotated-cell-34-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">bam</span>(<span class="at">formula =</span> newOut <span class="sc">~</span> <span class="fu">s</span>(x, y),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="8">8</button><span id="annotated-cell-34-22" class="code-annotation-target"><a href="#annotated-cell-34-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link=</span><span class="st">"logit"</span>),<span class="at">data =</span> train_df))[<span class="st">"elapsed"</span>]</span>
<span id="annotated-cell-34-23"><a href="#annotated-cell-34-23" aria-hidden="true" tabindex="-1"></a>  tmp_df <span class="ot">&lt;-</span></span>
<span id="annotated-cell-34-24"><a href="#annotated-cell-34-24" aria-hidden="true" tabindex="-1"></a>    def_atbat2024 <span class="sc">|&gt;</span> </span>
<span id="annotated-cell-34-25"><a href="#annotated-cell-34-25" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="9">9</button><span id="annotated-cell-34-26" class="code-annotation-target"><a href="#annotated-cell-34-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">ifelse</span>(<span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[l])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[l])<span class="sc">^</span><span class="dv">2</span> ) <span class="sc">&lt;</span> <span class="dv">150</span>, x, <span class="cn">NA</span>),</span>
<span id="annotated-cell-34-27"><a href="#annotated-cell-34-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">ifelse</span>(<span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[l])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[l])<span class="sc">^</span><span class="dv">2</span> ) <span class="sc">&lt;</span> <span class="dv">150</span>, y, <span class="cn">NA</span>)</span>
<span id="annotated-cell-34-28"><a href="#annotated-cell-34-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-34-29"><a href="#annotated-cell-34-29" aria-hidden="true" tabindex="-1"></a>    </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="10">10</button><span id="annotated-cell-34-30" class="code-annotation-target"><a href="#annotated-cell-34-30" aria-hidden="true" tabindex="-1"></a>  preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(<span class="at">object =</span> fit_list[[l]], <span class="at">newdata =</span> tmp_df, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="11">11</button><span id="annotated-cell-34-31" class="code-annotation-target"><a href="#annotated-cell-34-31" aria-hidden="true" tabindex="-1"></a>  def_atbat2024[[<span class="fu">paste0</span>(<span class="st">"p_out_"</span>, l)]] <span class="ot">&lt;-</span> preds</span>
<span id="annotated-cell-34-32"><a href="#annotated-cell-34-32" aria-hidden="true" tabindex="-1"></a>}</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-34" data-target-annotation="12">12</button><span id="annotated-cell-34-33" class="code-annotation-target"><a href="#annotated-cell-34-33" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(fit_list, mid_x, mid_y, <span class="at">file =</span> <span class="st">"position_gam_fits.RData"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-34" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="1" data-code-annotation="1">Vectors containing coordinates for the typical fielder location</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="3" data-code-annotation="2">Holds all fitted objects, so that we can use them later to visualize position-specific out probabilities</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="8" data-code-annotation="3">Compute typical coordinates for position <code>l</code></span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="13" data-code-annotation="4">Create position-specific outcome variable</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="15" data-code-annotation="5">Subsets to batted balls within 150 ft of the typical location</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="18" data-code-annotation="6">It’s often helpful to track how long it takes to fit a model. <code>system.time()</code> can return, among other things, the elapsed time. We save the time for fitting each position’s model in the vector <code>fit_time</code></span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="20" data-code-annotation="7">Instead of creating a different object for each position’s fitted model, we will store all the fitted models in a single <code>list</code>, which can be saved.</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="22" data-code-annotation="8"><code>system.time()</code> returns three different time measures. The most pertinent one is the actual elapsed time, stored in the slot “elapsed”.</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="26" data-code-annotation="9">We only want model predictions for balls hit within 150ft of the typical location. Passing <code>NA</code> <code>x</code> and <code>y</code> values to <code>predict()</code> is a hack to suppress model predictions for balls hit outside this radius. We will later over-write the resulting <code>NA</code>’s with 0’s.</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="30" data-code-annotation="10"><code>fit_list[[l]]</code> is the fitted object return by <code>bam</code> for position <code>l</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="31" data-code-annotation="11">Creates a column in <code>def_atbat2024</code> holding the</span>
</dd>
<dt data-target-cell="annotated-cell-34" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-34" data-code-lines="33" data-code-annotation="12">Save’s the list containing all position-specific fits</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Starting l = 2025-09-14 10:16:07.922465"
[1] "Starting l = 2025-09-14 10:17:22.080352"
[1] "Starting l = 2025-09-14 10:18:30.254582"
[1] "Starting l = 2025-09-14 10:19:55.76501"
[1] "Starting l = 2025-09-14 10:21:22.550645"
[1] "Starting l = 2025-09-14 10:22:44.629997"
[1] "Starting l = 2025-09-14 10:24:04.949589"
[1] "Starting l = 2025-09-14 10:24:45.704601"
[1] "Starting l = 2025-09-14 10:25:26.06384"</code></pre>
</div>
</div>
<p>The columns <code>p_out_1</code>, …, <code>p_out_9</code> in <code>def_atbat2024</code> contain several <code>NA</code> values. Some of these correspond to at-bats that did not result in ball being put in play (i.e., those with <code>end_type = S</code> or <code>end_type = B</code>) while others correspond to at-bats in which the ball was hit far away from the typical location of the fielder. For these latter at-bats, we will manually set the position-specific out probabilities as follows: 1. For home runs and balls hit outside the 150ft radius for each position, we set <code>p_out_*</code> = 0 2. For at-bats ending with a strike or ball, we keep <code>p_out_* = NA</code>. 3. For balls in play with missing <code>x</code> and <code>y</code> coordinates, we set <code>p_out_* = NA</code></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>def_atbat2024 <span class="ot">&lt;-</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_out_1 =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>      end_events <span class="sc">==</span> <span class="st">"home_run"</span> <span class="sc">~</span> <span class="dv">0</span>, </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>      end_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"B"</span>) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="fu">is.na</span>(y) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[<span class="dv">1</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[<span class="dv">1</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">&gt;=</span> <span class="dv">150</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> p_out_1),</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_out_2 =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>      end_events <span class="sc">==</span> <span class="st">"home_run"</span> <span class="sc">~</span> <span class="dv">0</span>, </span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>      end_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"B"</span>) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="fu">is.na</span>(y) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[<span class="dv">2</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">&gt;=</span> <span class="dv">150</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> p_out_2),</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_out_3 =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>      end_events <span class="sc">==</span> <span class="st">"home_run"</span> <span class="sc">~</span> <span class="dv">0</span>, </span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>      end_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"B"</span>) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="fu">is.na</span>(y) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[<span class="dv">3</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[<span class="dv">3</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">&gt;=</span> <span class="dv">150</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> p_out_3),</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_out_4 =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>      end_events <span class="sc">==</span> <span class="st">"home_run"</span> <span class="sc">~</span> <span class="dv">0</span>, </span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>      end_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"B"</span>) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="fu">is.na</span>(y) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[<span class="dv">4</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[<span class="dv">4</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">&gt;=</span> <span class="dv">150</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> p_out_4),</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_out_5 =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>      end_events <span class="sc">==</span> <span class="st">"home_run"</span> <span class="sc">~</span> <span class="dv">0</span>, </span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>      end_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"B"</span>) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="fu">is.na</span>(y) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[<span class="dv">5</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[<span class="dv">5</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">&gt;=</span> <span class="dv">150</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> p_out_5),</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_out_6 =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>      end_events <span class="sc">==</span> <span class="st">"home_run"</span> <span class="sc">~</span> <span class="dv">0</span>, </span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>      end_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"B"</span>) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="fu">is.na</span>(y) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[<span class="dv">6</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[<span class="dv">6</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">&gt;=</span> <span class="dv">150</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> p_out_6),</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_out_7 =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>      end_events <span class="sc">==</span> <span class="st">"home_run"</span> <span class="sc">~</span> <span class="dv">0</span>, </span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>      end_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"B"</span>) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="fu">is.na</span>(y) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[<span class="dv">7</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[<span class="dv">7</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">&gt;=</span> <span class="dv">150</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> p_out_7),</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_out_8 =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>      end_events <span class="sc">==</span> <span class="st">"home_run"</span> <span class="sc">~</span> <span class="dv">0</span>, </span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>      end_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"B"</span>) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="fu">is.na</span>(y) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[<span class="dv">8</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[<span class="dv">8</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">&gt;=</span> <span class="dv">150</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> p_out_8),</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_out_9 =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>      end_events <span class="sc">==</span> <span class="st">"home_run"</span> <span class="sc">~</span> <span class="dv">0</span>, </span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>      end_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"B"</span>) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">is.na</span>(x) <span class="sc">|</span> <span class="fu">is.na</span>(y) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sqrt</span>( (x <span class="sc">-</span> mid_x[<span class="dv">9</span>])<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> (y <span class="sc">-</span> mid_y[<span class="dv">9</span>])<span class="sc">^</span><span class="dv">2</span>) <span class="sc">&gt;=</span> <span class="dv">150</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> p_out_9))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We now normalize the <span class="math inline">\(\hat{p}_{i,\ell}\)</span> values to get the weights <span class="math inline">\(w_{i,\ell}\)</span> measuring the responsibility of each fielder for making an out in the at-bat.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>def_atbat2024 <span class="ot">&lt;-</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_weight =</span> p_out_1 <span class="sc">+</span> p_out_2 <span class="sc">+</span> p_out_3 <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>      p_out_4 <span class="sc">+</span> p_out_5 <span class="sc">+</span> p_out_6 <span class="sc">+</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>      p_out_7 <span class="sc">+</span> p_out_8 <span class="sc">+</span> p_out_9,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">w1 =</span> p_out_1<span class="sc">/</span>total_weight,</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">w2 =</span> p_out_2<span class="sc">/</span>total_weight,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">w3 =</span> p_out_3<span class="sc">/</span>total_weight,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">w4 =</span> p_out_4<span class="sc">/</span>total_weight,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">w5 =</span> p_out_5<span class="sc">/</span>total_weight,</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">w6 =</span> p_out_6<span class="sc">/</span>total_weight,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">w7 =</span> p_out_7<span class="sc">/</span>total_weight,</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">w8 =</span> p_out_8<span class="sc">/</span>total_weight,</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">w9 =</span> p_out_9<span class="sc">/</span>total_weight)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, for each fielding position, we can compute <span class="math inline">\(w_{i,\ell} \times \delta^{(f)}_{i}\)</span> and aggregate these values across players at that position to compute <span class="math inline">\(\textrm{RAA}_{\ell}^{(f)},\)</span> which quantifies the total run value created by the player through their fielding at position <span class="math inline">\(\ell.\)</span> Negative values of <span class="math inline">\(\textrm{RAA}_{\ell}^{(f)}\)</span> suggest that the player’s fielding at position <span class="math inline">\(\ell\)</span> netted <em>positive</em> run value for the batting team, thereby negatively impacthing his own team.</p>
<p>Here is the calculation for first basemen (fielding position number <span class="math inline">\(\ell = 3\)</span>). Taking a looking at the largest <span class="math inline">\(\textrm{RAA}_{\ell}^{f}\)</span> values, we see several recent <a href="https://en.wikipedia.org/wiki/Gold_Glove_Award">Golden Glove</a> winners who are known for their fielding prowess (Santana, Walker, Goldschmidt, Olson, Guerrero).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>raa_f3 <span class="ot">&lt;-</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA_f3 =</span> delta_f <span class="sc">*</span> w3) <span class="sc">|&gt;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(fielder_3) <span class="sc">|&gt;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">RAA_f3 =</span> <span class="fu">sum</span>(RAA_f3, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> fielder_3)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>raa_f3 <span class="sc">|&gt;</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> player2024_lookup, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Name, RAA_f3) <span class="sc">|&gt;</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(RAA_f3)) <span class="sc">|&gt;</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   Name              RAA_f3
   &lt;chr&gt;              &lt;dbl&gt;
 1 Carlos Santana      55.7
 2 Christian Walker    54.6
 3 Paul Goldschmidt    52.4
 4 Bryce Harper        51.1
 5 Matt Olson          51.0
 6 Ryan Mountcastle    48.7
 7 Vladimir Guerrero   47.1
 8 Michael Toglia      46.5
 9 Freddie Freeman     46.2
10 Josh Naylor         46.2</code></pre>
</div>
</div>
<p>The following code repeats this calculation for all fielding positions.</p>
<div class="cell">
<details class="code-fold">
<summary>Show the code computes the fielding RAA for all positions.</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>raa_f1 <span class="ot">&lt;-</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA_f1 =</span> delta_f <span class="sc">*</span> w1) <span class="sc">|&gt;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(pitcher) <span class="sc">|&gt;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">RAA_f1 =</span> <span class="fu">sum</span>(RAA_f1, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> pitcher) <span class="sc">|&gt;</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(key_mlbam, RAA_f1)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>raa_f2 <span class="ot">&lt;-</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA_f2 =</span> delta_f <span class="sc">*</span> w2) <span class="sc">|&gt;</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(fielder_2) <span class="sc">|&gt;</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">RAA_f2 =</span> <span class="fu">sum</span>(RAA_f2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> fielder_2) <span class="sc">|&gt;</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(key_mlbam, RAA_f2)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>raa_f3 <span class="ot">&lt;-</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA_f3 =</span> delta_f <span class="sc">*</span> w3) <span class="sc">|&gt;</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(fielder_3) <span class="sc">|&gt;</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">RAA_f3 =</span> <span class="fu">sum</span>(RAA_f3, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> fielder_3) <span class="sc">|&gt;</span></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(key_mlbam, RAA_f3)</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>raa_f4 <span class="ot">&lt;-</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA_f4 =</span> delta_f <span class="sc">*</span> w4) <span class="sc">|&gt;</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(fielder_4) <span class="sc">|&gt;</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">RAA_f4 =</span> <span class="fu">sum</span>(RAA_f4, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> fielder_4) <span class="sc">|&gt;</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(key_mlbam, RAA_f4)</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>raa_f5 <span class="ot">&lt;-</span></span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA_f5 =</span> delta_f <span class="sc">*</span> w5) <span class="sc">|&gt;</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(fielder_5) <span class="sc">|&gt;</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">RAA_f5 =</span> <span class="fu">sum</span>(RAA_f5, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> fielder_5) <span class="sc">|&gt;</span></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(key_mlbam, RAA_f5)</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-41"><a href="#cb45-41" aria-hidden="true" tabindex="-1"></a>raa_f6 <span class="ot">&lt;-</span></span>
<span id="cb45-42"><a href="#cb45-42" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb45-43"><a href="#cb45-43" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA_f6 =</span> delta_f <span class="sc">*</span> w6) <span class="sc">|&gt;</span></span>
<span id="cb45-44"><a href="#cb45-44" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(fielder_6) <span class="sc">|&gt;</span></span>
<span id="cb45-45"><a href="#cb45-45" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">RAA_f6 =</span> <span class="fu">sum</span>(RAA_f6, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-46"><a href="#cb45-46" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> fielder_6) <span class="sc">|&gt;</span></span>
<span id="cb45-47"><a href="#cb45-47" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(key_mlbam, RAA_f6)</span>
<span id="cb45-48"><a href="#cb45-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-49"><a href="#cb45-49" aria-hidden="true" tabindex="-1"></a>raa_f7 <span class="ot">&lt;-</span></span>
<span id="cb45-50"><a href="#cb45-50" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb45-51"><a href="#cb45-51" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA_f7 =</span> delta_f <span class="sc">*</span> w7) <span class="sc">|&gt;</span></span>
<span id="cb45-52"><a href="#cb45-52" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(fielder_7) <span class="sc">|&gt;</span></span>
<span id="cb45-53"><a href="#cb45-53" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">RAA_f7 =</span> <span class="fu">sum</span>(RAA_f7, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-54"><a href="#cb45-54" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> fielder_7) <span class="sc">|&gt;</span></span>
<span id="cb45-55"><a href="#cb45-55" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(key_mlbam, RAA_f7)</span>
<span id="cb45-56"><a href="#cb45-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-57"><a href="#cb45-57" aria-hidden="true" tabindex="-1"></a>raa_f8 <span class="ot">&lt;-</span></span>
<span id="cb45-58"><a href="#cb45-58" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb45-59"><a href="#cb45-59" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA_f8 =</span> delta_f <span class="sc">*</span> w8) <span class="sc">|&gt;</span></span>
<span id="cb45-60"><a href="#cb45-60" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(fielder_8) <span class="sc">|&gt;</span></span>
<span id="cb45-61"><a href="#cb45-61" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">RAA_f8 =</span> <span class="fu">sum</span>(RAA_f8, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-62"><a href="#cb45-62" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> fielder_8) <span class="sc">|&gt;</span></span>
<span id="cb45-63"><a href="#cb45-63" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(key_mlbam, RAA_f8)</span>
<span id="cb45-64"><a href="#cb45-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-65"><a href="#cb45-65" aria-hidden="true" tabindex="-1"></a>raa_f9 <span class="ot">&lt;-</span></span>
<span id="cb45-66"><a href="#cb45-66" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb45-67"><a href="#cb45-67" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA_f9 =</span> delta_f <span class="sc">*</span> w9) <span class="sc">|&gt;</span></span>
<span id="cb45-68"><a href="#cb45-68" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(fielder_9) <span class="sc">|&gt;</span></span>
<span id="cb45-69"><a href="#cb45-69" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(<span class="at">RAA_f9 =</span> <span class="fu">sum</span>(RAA_f9, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-70"><a href="#cb45-70" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> fielder_9) <span class="sc">|&gt;</span></span>
<span id="cb45-71"><a href="#cb45-71" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(key_mlbam, RAA_f9)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Like we did when computing <span class="math inline">\(\textrm{RAA}^{(br)}\)</span> in <a href="../lectures/lecture07.html">Lecture 7</a>, we will concatenate <code>raa_f1</code>, …, <code>raa_f9</code> and sum every players total contributions across all fielding positions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>raa_f <span class="ot">&lt;-</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  raa_f1 <span class="sc">|&gt;</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_f2, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_f3, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_f4, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_f5, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_f6, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_f7, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_f8, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_f9, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">replace_na</span>(</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">RAA_f1=</span><span class="dv">0</span>, <span class="at">RAA_f2=</span><span class="dv">0</span>, <span class="at">RAA_f3=</span><span class="dv">0</span>, <span class="at">RAA_f4=</span><span class="dv">0</span>, </span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">RAA_f5=</span><span class="dv">0</span>, <span class="at">RAA_f6 =</span> <span class="dv">0</span>, <span class="at">RAA_f7=</span><span class="dv">0</span>, <span class="at">RAA_f8 =</span> <span class="dv">0</span>, <span class="at">RAA_f9=</span><span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">RAA_f =</span> RAA_f1 <span class="sc">+</span> RAA_f2 <span class="sc">+</span> RAA_f3 <span class="sc">+</span> RAA_f4 <span class="sc">+</span> </span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>      RAA_f5 <span class="sc">+</span> RAA_f6 <span class="sc">+</span> RAA_f7 <span class="sc">+</span> RAA_f8 <span class="sc">+</span> RAA_f9) <span class="sc">|&gt;</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> player2024_lookup, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Name, key_mlbam, RAA_f, RAA_f1, RAA_f2, RAA_f3, RAA_f4, RAA_f5,</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>                RAA_f6, RAA_f7, RAA_f8, RAA_f9)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-pitching" class="level2">
<h2 class="anchored" data-anchor-id="sec-pitching">Pitching Run Values</h2>
<p>Recall that <span class="math inline">\(\delta_{i}^{(p)}\)</span> is the amount of run value created by the pitcher in at-bat <span class="math inline">\(i.\)</span> Summing this value across all at-bats involving each pitcher, we obtain each pitchers <span class="math inline">\(\textrm{RAA}^{(p)}.\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>raa_p <span class="ot">&lt;-</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(pitcher, delta_p) <span class="sc">|&gt;</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(pitcher) <span class="sc">|&gt;</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">RAA_p =</span> <span class="fu">sum</span>(delta_p, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> pitcher) <span class="sc">|&gt;</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> player2024_lookup, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Name, key_mlbam, RAA_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that the two 2024 <a href="https://en.wikipedia.org/wiki/Cy_Young_Award">Cy Young Award</a> winners<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>, Tarik Skubal and Chris Sale, have the highest <span class="math inline">\(\textrm{RAA}^{(p)}\)</span> values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>raa_p <span class="sc">|&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(RAA_p)) <span class="sc">|&gt;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   Name            key_mlbam RAA_p
   &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt;
 1 Tarik Skubal       669373 14.7 
 2 Chris Sale         519242 14.6 
 3 Ryan Walker        676254 13.5 
 4 Cade Smith         671922 13.3 
 5 Paul Skenes        694973 12.3 
 6 Emmanuel Clase     661403 11.2 
 7 Kirby Yates        489446  9.99
 8 Griffin Jax        643377  9.53
 9 Edwin Uceta        670955  9.23
10 Garrett Crochet    676979  9.13</code></pre>
</div>
</div>
<p>We will save both <code>raa_f</code> and <code>raa_p</code> for later use</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(raa_f, raa_p, <span class="at">file =</span> <span class="st">"raa_defensive2024.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-war" class="level2">
<h2 class="anchored" data-anchor-id="sec-war">Replacement Level</h2>
<p>We now combine the fielding and pitching RAA values with the baserunning and batting RAA values we computed in <a href="../lectures/lecture07.html">Lecture 7</a> into a single table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"raa_offensive2024.RData"</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>raa <span class="ot">&lt;-</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  raa_b <span class="sc">|&gt;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Name) <span class="sc">|&gt;</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_br <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Name), <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_p <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Name), <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">full_join</span>(<span class="at">y =</span> raa_f <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Name), <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">replace_na</span>(<span class="fu">list</span>(<span class="at">RAA_b =</span> <span class="dv">0</span>, <span class="at">RAA_br =</span> <span class="dv">0</span>, <span class="at">RAA_f =</span> <span class="dv">0</span>, <span class="at">RAA_p =</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">RAA =</span> RAA_b <span class="sc">+</span> RAA_br <span class="sc">+</span> RAA_f <span class="sc">+</span> RAA_p) <span class="sc">|&gt;</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(<span class="at">y =</span> player2024_lookup <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(key_mlbam, Name), <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Name, key_mlbam, RAA, RAA_b, RAA_br, RAA_f, RAA_p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><span class="math inline">\(RAA\)</span> is a comprehensive measure of a player’s performance that accounts not only for the actual runs scored (or given up) due to his contributions but also the changes in the expected runs that can be attributed to his play. We constructed <span class="math inline">\(RAA\)</span> so that larger numbers indicate better performance. While the absolute <span class="math inline">\(RAA\)</span> values are useful on their own, they become even more useful — and easier to interpret — when calibrated to measure performance <em>relative</em> to a baseline player. As argued by <span class="citation" data-cites="Baumer2015_openWAR">Baumer, Jensen, and Matthews (<a href="#ref-Baumer2015_openWAR" role="doc-biblioref">2015</a>)</span>, although comparing an individual players <span class="math inline">\(RAA\)</span> to the league-average value is intuitive, average players are themselves quite valuable. Further, it is not reasonable to expect a team to be able to replace any player with a league average one. Thus, it is more useful to compare each player’s performance relative to a replacement-level player.</p>
<p>As discussed in class (and also in <span class="citation" data-cites="Baumer2015_openWAR">(<a href="#ref-Baumer2015_openWAR" role="doc-biblioref">Baumer, Jensen, and Matthews 2015, sec. 3.8</a>)</span>), existing definitions of replacement level are fairly arbitrary. For instance, back in 2010, <a href="https://library.fangraphs.com/misc/war/replacement-level/">FanGraphs</a> asserted that a team of players making the minimum MLB salary would win 29.7% of its games (so between 48 and 49 games). Similar definitions have been adopted by other sites like Baseball Propsectus and Baseball Reference. Unfortunately, there is little empirical justification for this number.</p>
<p>We will instead use <span class="citation" data-cites="Baumer2015_openWAR">Baumer, Jensen, and Matthews (<a href="#ref-Baumer2015_openWAR" role="doc-biblioref">2015</a>)</span>’s roster-based definition of replacement level, which is motivated and computed as follows:</p>
<ol type="1">
<li>Each of the 30 major league teams typically carries 25 players, 13 of whom are position players and 12 of whom are pitchers</li>
<li>On any given day, there are generally <span class="math inline">\(12 \times 30 = 360\)</span> pitchers and <span class="math inline">\(13 \times 30 = 390\)</span> active players.</li>
<li>So, we will treat the 390 position players with the most plate appearances and the 360 pitchers who faced the most batters as <em>non</em>-replacement level and everyone else as replacement-level.</li>
</ol>
<p>Remember that our table <code>def_atbat2024</code> contains information from all available at-bats in the 2024 regular season. We can use the data in this table to count the number of plate appearances for each non-pitcher and number of batters faced by each pitcher. To this end, we first create lists of the MLB Advanced Media IDs of all pitchers and all non-pitchers who appear in our dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-44"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-44" data-target-annotation="1">1</button><span id="annotated-cell-44-1" class="code-annotation-target"><a href="#annotated-cell-44-1" aria-hidden="true" tabindex="-1"></a>all_players <span class="ot">&lt;-</span> <span class="fu">unique</span>(</span>
<span id="annotated-cell-44-2"><a href="#annotated-cell-44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(def_atbat2024<span class="sc">$</span>batter, def_atbat2024<span class="sc">$</span>pitcher, def_atbat2024<span class="sc">$</span>fielder_2,</span>
<span id="annotated-cell-44-3"><a href="#annotated-cell-44-3" aria-hidden="true" tabindex="-1"></a>    def_atbat2024<span class="sc">$</span>fielder_3, def_atbat2024<span class="sc">$</span>fielder_4, def_atbat2024<span class="sc">$</span>fielder_5,</span>
<span id="annotated-cell-44-4"><a href="#annotated-cell-44-4" aria-hidden="true" tabindex="-1"></a>    def_atbat2024<span class="sc">$</span>fielder_6, def_atbat2024<span class="sc">$</span>fielder_7, def_atbat2024<span class="sc">$</span>fielder_8, def_atbat2024<span class="sc">$</span>fielder_9))</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-44" data-target-annotation="2">2</button><span id="annotated-cell-44-5" class="code-annotation-target"><a href="#annotated-cell-44-5" aria-hidden="true" tabindex="-1"></a>pitchers <span class="ot">&lt;-</span> <span class="fu">unique</span>(def_atbat2024<span class="sc">$</span>pitcher)</span>
<span id="annotated-cell-44-6"><a href="#annotated-cell-44-6" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-44" data-target-annotation="3">3</button><span id="annotated-cell-44-7" class="code-annotation-target"><a href="#annotated-cell-44-7" aria-hidden="true" tabindex="-1"></a>position_players <span class="ot">&lt;-</span> all_players[<span class="sc">!</span>all_players <span class="sc">%in%</span> pitchers]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-44" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-44" data-code-lines="1" data-code-annotation="1">Get the ID for all players</span>
</dd>
<dt data-target-cell="annotated-cell-44" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-44" data-code-lines="5" data-code-annotation="2">Get the ID for all pitchers</span>
</dd>
<dt data-target-cell="annotated-cell-44" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-44" data-code-lines="7" data-code-annotation="3">Pull out the ID for all non-pitchers</span>
</dd>
</dl>
</div>
</div>
<p>Using grouped summaries, we can count the number of at-bats faced by each position player as a batter and by each pitcher. Since the overwhelming majority of at-bats involved only one batter, these counts effectively tell us the number of batters faced by each pitcher.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-45"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-45-1"><a href="#annotated-cell-45-1" aria-hidden="true" tabindex="-1"></a>position_pa <span class="ot">&lt;-</span></span>
<span id="annotated-cell-45-2"><a href="#annotated-cell-45-2" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-45" data-target-annotation="1">1</button><span id="annotated-cell-45-3" class="code-annotation-target"><a href="#annotated-cell-45-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(batter <span class="sc">%in%</span> position_players) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-45-4"><a href="#annotated-cell-45-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(batter) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-45" data-target-annotation="2">2</button><span id="annotated-cell-45-5" class="code-annotation-target"><a href="#annotated-cell-45-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-45" data-target-annotation="3">3</button><span id="annotated-cell-45-6" class="code-annotation-target"><a href="#annotated-cell-45-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(n)) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-45-7"><a href="#annotated-cell-45-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> batter)</span>
<span id="annotated-cell-45-8"><a href="#annotated-cell-45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-45-9"><a href="#annotated-cell-45-9" aria-hidden="true" tabindex="-1"></a>pitcher_pa <span class="ot">&lt;-</span></span>
<span id="annotated-cell-45-10"><a href="#annotated-cell-45-10" aria-hidden="true" tabindex="-1"></a>  def_atbat2024 <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-45" data-target-annotation="4">4</button><span id="annotated-cell-45-11" class="code-annotation-target"><a href="#annotated-cell-45-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(pitcher) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-45-12"><a href="#annotated-cell-45-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">n =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-45-13"><a href="#annotated-cell-45-13" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(n)) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-45" data-target-annotation="5">5</button><span id="annotated-cell-45-14" class="code-annotation-target"><a href="#annotated-cell-45-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">key_mlbam =</span> pitcher)</span>
<span id="annotated-cell-45-15"><a href="#annotated-cell-45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-45-16"><a href="#annotated-cell-45-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-45-17"><a href="#annotated-cell-45-17" aria-hidden="true" tabindex="-1"></a>repl_position_players <span class="ot">&lt;-</span> position_pa<span class="sc">$</span>key_mlbam[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">390</span>)]</span>
<span id="annotated-cell-45-18"><a href="#annotated-cell-45-18" aria-hidden="true" tabindex="-1"></a>repl_pitchers <span class="ot">&lt;-</span> pitcher_pa<span class="sc">$</span>key_mlbam[<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">360</span>)]</span>
<span id="annotated-cell-45-19"><a href="#annotated-cell-45-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-45-20"><a href="#annotated-cell-45-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cut-off for position players:"</span>, position_pa<span class="sc">$</span>n[<span class="dv">390</span>], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="annotated-cell-45-21"><a href="#annotated-cell-45-21" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Cut-off for pitchers:"</span>, pitcher_pa<span class="sc">$</span>n[<span class="dv">360</span>], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-45" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-45" data-code-lines="3" data-code-annotation="1">This removes at-bats in which a pitcher is hitting</span>
</dd>
<dt data-target-cell="annotated-cell-45" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-45" data-code-lines="5" data-code-annotation="2">Counts the number of at-bats in which each position player is batting</span>
</dd>
<dt data-target-cell="annotated-cell-45" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-45" data-code-lines="6" data-code-annotation="3">Arranges the counts in decreasing order so that we can determine replacement-level cut-offs</span>
</dd>
<dt data-target-cell="annotated-cell-45" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-45" data-code-lines="11" data-code-annotation="4">Since the vector <code>pitchers</code> is just the unique values of <code>def_atbat2024$pitcher</code>, there is no need to filter</span>
</dd>
<dt data-target-cell="annotated-cell-45" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-45" data-code-lines="14" data-code-annotation="5">Get the IDs of the position players and pitchers outside, respectively, the top 390 and 360 numbers of plate appearances</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Cut-off for position players: 131 
Cut-off for pitchers: 204 </code></pre>
</div>
</div>
<p>Ultimately, we wish to compare each player’s <span class="math inline">\(RAA\)</span> to the <span class="math inline">\(RAA\)</span> that would have been created had the player been replaced by a replacement-level player. To estimate this counter-factual <span class="math inline">\(RAA\)</span>, we will divide the total <span class="math inline">\(RAA\)</span> produced by all replacement-level players by the total number of plate appearances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-46"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-46-1"><a href="#annotated-cell-46-1" aria-hidden="true" tabindex="-1"></a>repl_position_raa <span class="ot">&lt;-</span></span>
<span id="annotated-cell-46-2"><a href="#annotated-cell-46-2" aria-hidden="true" tabindex="-1"></a>  raa <span class="sc">|&gt;</span></span>
<span id="annotated-cell-46-3"><a href="#annotated-cell-46-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(key_mlbam <span class="sc">%in%</span> repl_position_players) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-46" data-target-annotation="1">1</button><span id="annotated-cell-46-4" class="code-annotation-target"><a href="#annotated-cell-46-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> position_pa, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-46-5"><a href="#annotated-cell-46-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Name, key_mlbam, RAA, n)</span>
<span id="annotated-cell-46-6"><a href="#annotated-cell-46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-46-7"><a href="#annotated-cell-46-7" aria-hidden="true" tabindex="-1"></a>repl_pitch_raa <span class="ot">&lt;-</span></span>
<span id="annotated-cell-46-8"><a href="#annotated-cell-46-8" aria-hidden="true" tabindex="-1"></a>  raa <span class="sc">|&gt;</span></span>
<span id="annotated-cell-46-9"><a href="#annotated-cell-46-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(key_mlbam <span class="sc">%in%</span> repl_pitchers) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-46-10"><a href="#annotated-cell-46-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> pitcher_pa, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-46-11"><a href="#annotated-cell-46-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Name, key_mlbam, RAA, n) </span>
<span id="annotated-cell-46-12"><a href="#annotated-cell-46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-46-13"><a href="#annotated-cell-46-13" aria-hidden="true" tabindex="-1"></a>repl_avg_pos <span class="ot">&lt;-</span> <span class="fu">sum</span>(repl_position_raa<span class="sc">$</span>RAA)<span class="sc">/</span><span class="fu">sum</span>(repl_position_raa<span class="sc">$</span>n)</span>
<span id="annotated-cell-46-14"><a href="#annotated-cell-46-14" aria-hidden="true" tabindex="-1"></a>repl_avg_pitch <span class="ot">&lt;-</span> <span class="fu">sum</span>(repl_pitch_raa<span class="sc">$</span>RAA)<span class="sc">/</span><span class="fu">sum</span>(repl_pitch_raa<span class="sc">$</span>n)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-46" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-46" data-code-lines="4" data-code-annotation="1">Using an inner join ensures that we only append the <code>n</code> values for replacement-level players</span>
</dd>
</dl>
</div>
</div>
<p>We see that the replacement-level RAA per-at-bat is 0 for position players and -0.03 for pitchers. Multiplying the the replacement-level per-at-bat RAA values by the number of plate appearances faced by each non-replacement-level player gives us an estimate of how each player’s replacement-level “shadow” would perform. Finally, using the heuristic of 10 runs per win, dividing the difference between the actual RAA and the RAA for the replacement-level shadow yields our wins above replacement for position players.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>position_war <span class="ot">&lt;-</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  raa <span class="sc">|&gt;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>key_mlbam <span class="sc">%in%</span> repl_position_players) <span class="sc">|&gt;</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> position_pa, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Name, key_mlbam, RAA, n) <span class="sc">|&gt;</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">shadowRAA =</span> n <span class="sc">*</span> repl_avg_pos) <span class="sc">|&gt;</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">WAR =</span> (RAA <span class="sc">-</span> shadowRAA)<span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>position_war <span class="sc">|&gt;</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(WAR)) <span class="sc">|&gt;</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 6
   Name              key_mlbam   RAA     n shadowRAA   WAR
   &lt;chr&gt;                 &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;     &lt;dbl&gt; &lt;dbl&gt;
 1 Bobby Witt           677951 149.    694    -0.572 15.0 
 2 Gunnar Henderson     683002 109.    702    -0.579 10.9 
 3 Zach Neto            687263 100.    590    -0.486 10.1 
 4 Vladimir Guerrero    665489  99.2   671    -0.553  9.97
 5 Elly De La Cruz      682829  98.7   679    -0.560  9.92
 6 Marcus Semien        543760  98.1   701    -0.578  9.87
 7 Masyn Winn           691026  93.8   624    -0.514  9.43
 8 Francisco Lindor     596019  93.2   689    -0.568  9.37
 9 Ezequiel Tovar       678662  92.3   681    -0.561  9.29
10 Ketel Marte          606466  90.9   562    -0.463  9.14</code></pre>
</div>
</div>
<p>We can run a similar calculation for pitchers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>pitch_war <span class="ot">&lt;-</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  raa <span class="sc">|&gt;</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>key_mlbam <span class="sc">%in%</span> repl_pitchers) <span class="sc">|&gt;</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> pitcher_pa, <span class="at">by =</span> <span class="st">"key_mlbam"</span>) <span class="sc">|&gt;</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Name, key_mlbam, RAA, n) <span class="sc">|&gt;</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">shadowRAA =</span> n <span class="sc">*</span> repl_avg_pitch) <span class="sc">|&gt;</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">WAR =</span> (RAA <span class="sc">-</span> shadowRAA)<span class="sc">/</span><span class="dv">10</span>)</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>pitch_war <span class="sc">|&gt;</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(WAR)) <span class="sc">|&gt;</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 6
   Name            key_mlbam   RAA     n shadowRAA   WAR
   &lt;chr&gt;               &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;     &lt;dbl&gt; &lt;dbl&gt;
 1 Tarik Skubal       669373 17.2    730    -18.3   3.55
 2 Chris Sale         519242 17.2    702    -17.6   3.48
 3 Zack Wheeler       554430 10.1    759    -19.0   2.92
 4 Paul Skenes        694973 14.6    495    -12.4   2.70
 5 Garrett Crochet    676979  9.91   596    -15.0   2.49
 6 Bryce Miller       682243  7.66   681    -17.1   2.47
 7 Seth Lugo          607625  2.47   813    -20.4   2.29
 8 Reynaldo Lopez     625643  8.82   542    -13.6   2.24
 9 Ryan Walker        676254 14.7    302     -7.58  2.23
10 Cade Smith         671922 14.2    289     -7.25  2.14</code></pre>
</div>
</div>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<ol type="1">
<li>We modeled the probability of a batted ball resulting in out using just the batted ball location. Try adjusting for additional factors about the pitch and swing in our GAM. How do the out probabilities and our downstream analysis change when you account for these factors?</li>
</ol>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-Baumer2015_openWAR" class="csl-entry" role="listitem">
Baumer, Benjamin S., Shane T. Jensen, and Gregory J. Matthews. 2015. <span>“<span class="nocase">openWAR</span>: An Open Source System for Evaluating Overall Player Performance in <span>Major League Baseball</span>.”</span> <em>Journal of Quantitative Analysis in Sports</em> 11 (2).
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>The official position numbers are: 1 (pitcher), 2 (catcher), 3 (first baseman), 4 (second baseman), 5 (third baseman), 6 (shortstop), 7 (left fielder), 8 (center fielder), and 9 (right fielder).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>If you’re keen to learn more about splines, consider taking STAT 351 (Introduction to Nonparametric Statistics). A lot of the mathematical theory underpinning smoothing splines was developed by Prof.&nbsp;<a href="https://en.wikipedia.org/wiki/Grace_Wahba">Grace Wahba</a>, who was a long-serving member of the faculty here.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>This choice is decidedly ad hoc. You should experiment with different cut-offs to see how the downstream results change!<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>The Cy Young Award is given to the best pitchers in the National League and American League.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>