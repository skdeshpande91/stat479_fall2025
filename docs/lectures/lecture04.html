<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lecture 4: Adjusted Plus/Minus – STAT479</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-4bfb630b09c0e164834af1bb3207dbff.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">STAT479</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../syllabus.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-lecture-code" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Lecture Code</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-lecture-code">    
        <li>
    <a class="dropdown-item" href="../lectures/lecture00.html">
 <span class="dropdown-text">Lecture 0: Boxscore Metrics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture02.html">
 <span class="dropdown-text">Lecture 2: Expected Goals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture03.html">
 <span class="dropdown-text">Lecture 3: Estimating XG</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture04.html">
 <span class="dropdown-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture05.html">
 <span class="dropdown-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture06.html">
 <span class="dropdown-text">Lecture 6: Run Expectancy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture07.html">
 <span class="dropdown-text">Lecture 7: Offensive Credit Allocation in Baseball</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture08.html">
 <span class="dropdown-text">Lecture 8: Defensive Credit Allocation in Baseball</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture09.html">
 <span class="dropdown-text">Lecture 9: Multilevel Modeling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture10.html">
 <span class="dropdown-text">Lecture 10: NFl WAR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture11.html">
 <span class="dropdown-text">Lecture 11: Pitch Framing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture12.html">
 <span class="dropdown-text">Lecture 12: Power Rankings I</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture13.html">
 <span class="dropdown-text">Lecture 13: Power Rankings II</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-lecture-slides" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Lecture Slides</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-lecture-slides">    
        <li>
    <a class="dropdown-item" href="../slides/lecture01.html">
 <span class="dropdown-text">Lecture 1</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../lectures/lecture04.html">Lecture 4: Adjusted Plus/Minus</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 0: Boxscore Metrics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 2: Expected Goals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 3: Estimating XG</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture04.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 6: Run Expectancy</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 7: Offensive Credit Allocation in Baseball</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 8: Defensive Credit Allocation in Baseball</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 9: Multilevel Modeling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 10: NFl WAR</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 11: Pitch Framing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 12: Power Rankings I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 13: Power Rankings II</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#sec-overview" id="toc-sec-overview" class="nav-link active" data-scroll-target="#sec-overview">Overview</a>
  <ul class="collapse">
  <li><a href="#sec-data-prep" id="toc-sec-data-prep" class="nav-link" data-scroll-target="#sec-data-prep">Stint-level NBA Data</a></li>
  </ul></li>
  <li><a href="#sec-pm" id="toc-sec-pm" class="nav-link" data-scroll-target="#sec-pm">Plus/Minus</a>
  <ul class="collapse">
  <li><a href="#sec-individual-pm" id="toc-sec-individual-pm" class="nav-link" data-scroll-target="#sec-individual-pm">Computing Individual +/-’s</a></li>
  <li><a href="#sec-matrix-pm" id="toc-sec-matrix-pm" class="nav-link" data-scroll-target="#sec-matrix-pm">Matrix-Based Computation</a></li>
  <li><a href="#sec-pm-issues" id="toc-sec-pm-issues" class="nav-link" data-scroll-target="#sec-pm-issues">Issues with +/-</a></li>
  </ul></li>
  <li><a href="#sec-apm-intro" id="toc-sec-apm-intro" class="nav-link" data-scroll-target="#sec-apm-intro">Adjusted Plus/Minus</a>
  <ul class="collapse">
  <li><a href="#sec-apm-lm" id="toc-sec-apm-lm" class="nav-link" data-scroll-target="#sec-apm-lm">APM As A Linear Model</a></li>
  <li><a href="#sec-baseline" id="toc-sec-baseline" class="nav-link" data-scroll-target="#sec-baseline">Value Relative to Baseline</a></li>
  <li><a href="#sec-apm-beta" id="toc-sec-apm-beta" class="nav-link" data-scroll-target="#sec-apm-beta">A Re-parametrized Model</a></li>
  <li><a href="#weighted-adjusted-plusminus" id="toc-weighted-adjusted-plusminus" class="nav-link" data-scroll-target="#weighted-adjusted-plusminus">Weighted adjusted plus/minus</a></li>
  </ul></li>
  <li><a href="#sec-looking-ahead" id="toc-sec-looking-ahead" class="nav-link" data-scroll-target="#sec-looking-ahead">Looking Ahead</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises">Exercises</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lecture 4: Adjusted Plus/Minus</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-overview" class="level2">
<h2 class="anchored" data-anchor-id="sec-overview">Overview</h2>
<p>Which NBA players do the most to help their teams win? And how might we quantify that contribution? One option is to rely on box score statistics like points, rebounds, assists, steals, blocks, and turnovers. Underlying this approach is the assumption that the “best” or players with the most impact are the ones that record extreme values of these statistics. That is, they are the ones who score the most points, grab the most rebounds, commit the fewest turnovers, etc?</p>
<p>While this approach seems natural, it quickly runs into problems. As <a href="https://www.82games.com/ilardi1.htm">Ilardi 2007</a> notes, it is not obvious whether all of these statistics should count the same or whether some should be weighted more heavily than others. It is also difficult to compare players who play different roles: is a guard who records 10 assists per game more valuable than a center who grabs 10 rebounds per game? More subtley, players do many things during the course of a game (e.g., setting screens, rotating on defense, dive for loose balls, etc.) that impact the outcome of a play or the game but do not appear in the box score. How should those contributions be valued?</p>
<p>In today’s lecture, we introduce two now-classical approaches to player evaluation: <em>plus/minus</em> (<a href="#sec-pm" class="quarto-xref">Section&nbsp;2</a>) and <em>adjusted plus/minus</em> (<a href="#sec-apm-intro" class="quarto-xref">Section&nbsp;3</a>). At a high-level, plus/minus is simply the total point differential that a player’s team accrues when he is on the court. Adjusted plus/minus measures how much more a player contributes to his team’s point differential per 100 after accounting than a baseline-level player, after accounting for the relative contributions of his teammates and opponents.</p>
<section id="sec-data-prep" class="level3">
<h3 class="anchored" data-anchor-id="sec-data-prep">Stint-level NBA Data</h3>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>##Definition: Stint A <em>stint</em> is a period of play between substitutions during which the same 10 players remain on the court.</p>
</div>
</div>
<p>To compute plus/minus and adjusted plus/minus, we need to build a data table in which rows correspond to stints within individual games. In addition to recording the identities of the home and away team players on the court during each stint, the data table needs to include game-state information about each stint including both teams’ scores and the amount of time left at the start and end of each stint and the number of possessions in each stint.</p>
<p>The NBA posts a play-by-play for every game that contains the time-stamp and a short description of important events during a game. Basically, whenever a player does something tracked by the scorekeepers or reported in the box-score (e.g., attempt a shot, steal the ball, commit a foul, etc.), an entry is added to the play-by-play log. <a href="https://www.nba.com/game/dal-vs-min-0042300312/play-by-play?period=All">Here</a> is an example from a game from a few years ago between the Dallas Mavericks and Minnesota Timberwolves<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p>We can scrap play-by-play data into R using the <a href="https://hoopr.sportsdataverse.org">[<strong>hoopR</strong>]</a> package, which can be installed using the code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"hoopR"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following function, which is based on a <a href="https://github.com/SCOREnetworkorg/sports-data-repository/blob/main/_prep/nba-rapm/init-nba-rapm-data.R">script</a> written by <a href="https://www.stat.cmu.edu/~ryurko/">Ron Yurko</a>, extracts stint information from a single game’s play-by-play.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>It takes about 30 minutes to download all single season’s worth of play-by-play data.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code to get stinte data</summary>
<div class="sourceCode cell-code" id="annotated-cell-2"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="1">1</button><span id="annotated-cell-2-1" class="code-annotation-target"><a href="#annotated-cell-2-1" aria-hidden="true" tabindex="-1"></a>get_game_stint_data <span class="ot">&lt;-</span> <span class="cf">function</span>(game_i) {</span>
<span id="annotated-cell-2-2"><a href="#annotated-cell-2-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-3"><a href="#annotated-cell-2-3" aria-hidden="true" tabindex="-1"></a>  game_data <span class="ot">&lt;-</span> hoopR<span class="sc">::</span><span class="fu">nba_pbp</span>(<span class="at">game_id =</span> game_i)</span>
<span id="annotated-cell-2-4"><a href="#annotated-cell-2-4" aria-hidden="true" tabindex="-1"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="2">2</button><span id="annotated-cell-2-5" class="code-annotation-target"><a href="#annotated-cell-2-5" aria-hidden="true" tabindex="-1"></a>  game_data<span class="sc">$</span>home_score[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="annotated-cell-2-6"><a href="#annotated-cell-2-6" aria-hidden="true" tabindex="-1"></a>  game_data<span class="sc">$</span>away_score[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="annotated-cell-2-7"><a href="#annotated-cell-2-7" aria-hidden="true" tabindex="-1"></a>  game_data<span class="sc">$</span>score_margin[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="annotated-cell-2-8"><a href="#annotated-cell-2-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-9"><a href="#annotated-cell-2-9" aria-hidden="true" tabindex="-1"></a>  game_data <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-2-10"><a href="#annotated-cell-2-10" aria-hidden="true" tabindex="-1"></a>    game_data <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="3">3</button><span id="annotated-cell-2-11" class="code-annotation-target"><a href="#annotated-cell-2-11" aria-hidden="true" tabindex="-1"></a>    tidyr<span class="sc">::</span><span class="fu">fill</span>(home_score, away_score, score_margin)</span>
<span id="annotated-cell-2-12"><a href="#annotated-cell-2-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-13"><a href="#annotated-cell-2-13" aria-hidden="true" tabindex="-1"></a>  home_lineups <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-2-14"><a href="#annotated-cell-2-14" aria-hidden="true" tabindex="-1"></a>    game_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-15"><a href="#annotated-cell-2-15" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(home_player1, home_player2, home_player3, home_player4, home_player5) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="4">4</button><span id="annotated-cell-2-16" class="code-annotation-target"><a href="#annotated-cell-2-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(<span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){<span class="fu">paste</span>(<span class="fu">sort</span>(x), <span class="at">collapse =</span> <span class="st">"_"</span>)})</span>
<span id="annotated-cell-2-17"><a href="#annotated-cell-2-17" aria-hidden="true" tabindex="-1"></a>  away_lineups <span class="ot">&lt;-</span></span>
<span id="annotated-cell-2-18"><a href="#annotated-cell-2-18" aria-hidden="true" tabindex="-1"></a>    game_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-19"><a href="#annotated-cell-2-19" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(away_player1, away_player2,away_player3, away_player4, away_player5) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="5">5</button><span id="annotated-cell-2-20" class="code-annotation-target"><a href="#annotated-cell-2-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(<span class="at">MARGIN =</span> <span class="dv">1</span>, <span class="at">FUN =</span> <span class="cf">function</span>(x){<span class="fu">paste</span>(<span class="fu">sort</span>(x), <span class="at">collapse =</span> <span class="st">"_"</span>)})</span>
<span id="annotated-cell-2-21"><a href="#annotated-cell-2-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-22"><a href="#annotated-cell-2-22" aria-hidden="true" tabindex="-1"></a>  game_data<span class="sc">$</span>home_lineup <span class="ot">&lt;-</span> home_lineups</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="6">6</button><span id="annotated-cell-2-23" class="code-annotation-target"><a href="#annotated-cell-2-23" aria-hidden="true" tabindex="-1"></a>  game_data<span class="sc">$</span>away_lineup <span class="ot">&lt;-</span> away_lineups</span>
<span id="annotated-cell-2-24"><a href="#annotated-cell-2-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-25"><a href="#annotated-cell-2-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Now there are a couple of ways to figure out the stints, but I think the</span></span>
<span id="annotated-cell-2-26"><a href="#annotated-cell-2-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># best way is to use the substitution events - where a stint changes once</span></span>
<span id="annotated-cell-2-27"><a href="#annotated-cell-2-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># a substitution takes places (but only if the previous event was NOT a substitution)</span></span>
<span id="annotated-cell-2-28"><a href="#annotated-cell-2-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-29"><a href="#annotated-cell-2-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Start by making an indicator for the stint change:</span></span>
<span id="annotated-cell-2-30"><a href="#annotated-cell-2-30" aria-hidden="true" tabindex="-1"></a>  game_data <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-2-31"><a href="#annotated-cell-2-31" aria-hidden="true" tabindex="-1"></a>    game_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-32"><a href="#annotated-cell-2-32" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">is_sub =</span> <span class="fu">ifelse</span>(event_type <span class="sc">==</span> <span class="dv">8</span>, <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="annotated-cell-2-33"><a href="#annotated-cell-2-33" aria-hidden="true" tabindex="-1"></a>                  <span class="at">new_stint_start =</span> <span class="fu">ifelse</span>((is_sub <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">&amp;</span> (dplyr<span class="sc">::</span><span class="fu">lead</span>(is_sub) <span class="sc">!=</span> <span class="dv">1</span>),<span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="annotated-cell-2-34"><a href="#annotated-cell-2-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-35"><a href="#annotated-cell-2-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For substitutions that take place</span></span>
<span id="annotated-cell-2-36"><a href="#annotated-cell-2-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># during a free throw window, then the new stint should start after the free throw</span></span>
<span id="annotated-cell-2-37"><a href="#annotated-cell-2-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-38"><a href="#annotated-cell-2-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Easiest way to track if substitution takes places before final free throw:</span></span>
<span id="annotated-cell-2-39"><a href="#annotated-cell-2-39" aria-hidden="true" tabindex="-1"></a>  game_data <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-2-40"><a href="#annotated-cell-2-40" aria-hidden="true" tabindex="-1"></a>    game_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-41"><a href="#annotated-cell-2-41" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">sub_during_free_throw =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="annotated-cell-2-42"><a href="#annotated-cell-2-42" aria-hidden="true" tabindex="-1"></a>      (stringr<span class="sc">::</span><span class="fu">str_detect</span>(visitor_description, <span class="st">"Free Throw 1 of 1"</span>) <span class="sc">|</span></span>
<span id="annotated-cell-2-43"><a href="#annotated-cell-2-43" aria-hidden="true" tabindex="-1"></a>         stringr<span class="sc">::</span><span class="fu">str_detect</span>(visitor_description, <span class="st">"Free Throw 2 of 2"</span>) <span class="sc">|</span></span>
<span id="annotated-cell-2-44"><a href="#annotated-cell-2-44" aria-hidden="true" tabindex="-1"></a>         stringr<span class="sc">::</span><span class="fu">str_detect</span>(visitor_description, <span class="st">"Free Throw 3 of 3"</span>)) <span class="sc">&amp;</span></span>
<span id="annotated-cell-2-45"><a href="#annotated-cell-2-45" aria-hidden="true" tabindex="-1"></a>        (dplyr<span class="sc">::</span><span class="fu">lag</span>(is_sub) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="annotated-cell-2-46"><a href="#annotated-cell-2-46" aria-hidden="true" tabindex="-1"></a>      (stringr<span class="sc">::</span><span class="fu">str_detect</span>(home_description, <span class="st">"Free Throw 1 of 1"</span>) <span class="sc">|</span></span>
<span id="annotated-cell-2-47"><a href="#annotated-cell-2-47" aria-hidden="true" tabindex="-1"></a>         stringr<span class="sc">::</span><span class="fu">str_detect</span>(home_description, <span class="st">"Free Throw 2 of 2"</span>) <span class="sc">|</span></span>
<span id="annotated-cell-2-48"><a href="#annotated-cell-2-48" aria-hidden="true" tabindex="-1"></a>         stringr<span class="sc">::</span><span class="fu">str_detect</span>(home_description, <span class="st">"Free Throw 3 of 3"</span>)) <span class="sc">&amp;</span></span>
<span id="annotated-cell-2-49"><a href="#annotated-cell-2-49" aria-hidden="true" tabindex="-1"></a>        (dplyr<span class="sc">::</span><span class="fu">lag</span>(is_sub) <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="annotated-cell-2-50"><a href="#annotated-cell-2-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="dv">0</span>),</span>
<span id="annotated-cell-2-51"><a href="#annotated-cell-2-51" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Now if the sub is followed by this, then set new_stint_start to 0, but</span></span>
<span id="annotated-cell-2-52"><a href="#annotated-cell-2-52" aria-hidden="true" tabindex="-1"></a>      <span class="co"># if this set a new stint to start post the final free throw:</span></span>
<span id="annotated-cell-2-53"><a href="#annotated-cell-2-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">new_stint_start =</span> <span class="fu">ifelse</span>(is_sub <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> dplyr<span class="sc">::</span><span class="fu">lead</span>(sub_during_free_throw) <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">0</span>, new_stint_start),</span>
<span id="annotated-cell-2-54"><a href="#annotated-cell-2-54" aria-hidden="true" tabindex="-1"></a>      <span class="at">new_stint_start =</span> <span class="fu">ifelse</span>(<span class="fu">lag</span>(sub_during_free_throw) <span class="sc">==</span> <span class="dv">1</span>,<span class="dv">1</span>, new_stint_start),</span>
<span id="annotated-cell-2-55"><a href="#annotated-cell-2-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">new_stint_start =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(new_stint_start), <span class="dv">0</span>, new_stint_start)</span>
<span id="annotated-cell-2-56"><a href="#annotated-cell-2-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="annotated-cell-2-57"><a href="#annotated-cell-2-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-58"><a href="#annotated-cell-2-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter out subs that are not new stints, and then just use</span></span>
<span id="annotated-cell-2-59"><a href="#annotated-cell-2-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the cumulative sum of the new stint start to effectively create a stint ID:</span></span>
<span id="annotated-cell-2-60"><a href="#annotated-cell-2-60" aria-hidden="true" tabindex="-1"></a>  game_data <span class="ot">&lt;-</span> game_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-61"><a href="#annotated-cell-2-61" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="sc">!</span>(is_sub <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> new_stint_start <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-62"><a href="#annotated-cell-2-62" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">stint_id =</span> <span class="fu">cumsum</span>(new_stint_start) <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="annotated-cell-2-63"><a href="#annotated-cell-2-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-64"><a href="#annotated-cell-2-64" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Toughest part - need to count the number of possessions for each team during</span></span>
<span id="annotated-cell-2-65"><a href="#annotated-cell-2-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the stint... will rely on this for counting when a possession ends:</span></span>
<span id="annotated-cell-2-66"><a href="#annotated-cell-2-66" aria-hidden="true" tabindex="-1"></a>  <span class="co"># https://squared2020.com/2017/09/18/deep-dive-on-regularized-adjusted-plus-minus-ii-basic-application-to-2017-nba-data-with-r/</span></span>
<span id="annotated-cell-2-67"><a href="#annotated-cell-2-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># "Recall that a possession is ended by a converted last free throw, made field goal, defensive rebound, turnover, or end of period"</span></span>
<span id="annotated-cell-2-68"><a href="#annotated-cell-2-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-69"><a href="#annotated-cell-2-69" aria-hidden="true" tabindex="-1"></a>  game_data <span class="ot">&lt;-</span> game_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-70"><a href="#annotated-cell-2-70" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">pos_ends =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<span id="annotated-cell-2-71"><a href="#annotated-cell-2-71" aria-hidden="true" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_detect</span>(home_description, <span class="st">" PTS"</span>) <span class="sc">&amp;</span></span>
<span id="annotated-cell-2-72"><a href="#annotated-cell-2-72" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(home_description, <span class="st">"Free Throw 1 of 2"</span>, <span class="at">negate =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;</span></span>
<span id="annotated-cell-2-73"><a href="#annotated-cell-2-73" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(home_description, <span class="st">"Free Throw 2 of 3"</span>,<span class="at">negate =</span> <span class="cn">TRUE</span>) <span class="sc">~</span> <span class="dv">1</span>, <span class="co"># made field goals or free throws</span></span>
<span id="annotated-cell-2-74"><a href="#annotated-cell-2-74" aria-hidden="true" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_detect</span>(visitor_description, <span class="st">" PTS"</span>) <span class="sc">&amp;</span> </span>
<span id="annotated-cell-2-75"><a href="#annotated-cell-2-75" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(visitor_description, <span class="st">"Free Throw 1 of 2"</span>,<span class="at">negate =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;</span> </span>
<span id="annotated-cell-2-76"><a href="#annotated-cell-2-76" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(visitor_description, <span class="st">"Free Throw 2 of 3"</span>,<span class="at">negate =</span> <span class="cn">TRUE</span>) <span class="sc">~</span> <span class="dv">1</span>, </span>
<span id="annotated-cell-2-77"><a href="#annotated-cell-2-77" aria-hidden="true" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="fu">tolower</span>(visitor_description), <span class="st">"rebound"</span>) <span class="sc">&amp;</span></span>
<span id="annotated-cell-2-78"><a href="#annotated-cell-2-78" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="fu">tolower</span>(<span class="fu">lag</span>(home_description)), <span class="st">"miss "</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="annotated-cell-2-79"><a href="#annotated-cell-2-79" aria-hidden="true" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="fu">tolower</span>(home_description), <span class="st">"rebound"</span>) <span class="sc">&amp;</span></span>
<span id="annotated-cell-2-80"><a href="#annotated-cell-2-80" aria-hidden="true" tabindex="-1"></a>        stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="fu">tolower</span>(<span class="fu">lag</span>(visitor_description)), <span class="st">"miss "</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="annotated-cell-2-81"><a href="#annotated-cell-2-81" aria-hidden="true" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="fu">tolower</span>(home_description), <span class="st">" turnover"</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="annotated-cell-2-82"><a href="#annotated-cell-2-82" aria-hidden="true" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="fu">tolower</span>(visitor_description), <span class="st">" turnover"</span>) <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="annotated-cell-2-83"><a href="#annotated-cell-2-83" aria-hidden="true" tabindex="-1"></a>      stringr<span class="sc">::</span><span class="fu">str_detect</span>(neutral_description, <span class="st">"End"</span>) <span class="sc">~</span> <span class="dv">1</span>,<span class="at">.default =</span> <span class="dv">0</span>))</span>
<span id="annotated-cell-2-84"><a href="#annotated-cell-2-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-2-85"><a href="#annotated-cell-2-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Now the final part - compute the stint level summaries:</span></span>
<span id="annotated-cell-2-86"><a href="#annotated-cell-2-86" aria-hidden="true" tabindex="-1"></a>  game_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-87"><a href="#annotated-cell-2-87" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">group_by</span>(stint_id) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-88"><a href="#annotated-cell-2-88" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarize</span>(</span>
<span id="annotated-cell-2-89"><a href="#annotated-cell-2-89" aria-hidden="true" tabindex="-1"></a>      <span class="at">home_lineup =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(home_lineup),</span>
<span id="annotated-cell-2-90"><a href="#annotated-cell-2-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">away_lineup =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(away_lineup),</span>
<span id="annotated-cell-2-91"><a href="#annotated-cell-2-91" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_home_lineups =</span> <span class="fu">length</span>(<span class="fu">unique</span>(home_lineup)),</span>
<span id="annotated-cell-2-92"><a href="#annotated-cell-2-92" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_away_lineups =</span> <span class="fu">length</span>(<span class="fu">unique</span>(away_lineup)),</span>
<span id="annotated-cell-2-93"><a href="#annotated-cell-2-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">start_home_score =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(home_score),</span>
<span id="annotated-cell-2-94"><a href="#annotated-cell-2-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">end_home_score =</span> dplyr<span class="sc">::</span><span class="fu">last</span>(home_score),</span>
<span id="annotated-cell-2-95"><a href="#annotated-cell-2-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">start_away_score =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(away_score),</span>
<span id="annotated-cell-2-96"><a href="#annotated-cell-2-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">end_away_score =</span> dplyr<span class="sc">::</span><span class="fu">last</span>(away_score),</span>
<span id="annotated-cell-2-97"><a href="#annotated-cell-2-97" aria-hidden="true" tabindex="-1"></a>      <span class="at">start_minutes =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(minute_game),</span>
<span id="annotated-cell-2-98"><a href="#annotated-cell-2-98" aria-hidden="true" tabindex="-1"></a>      <span class="at">end_minutes =</span> dplyr<span class="sc">::</span><span class="fu">last</span>(minute_game),</span>
<span id="annotated-cell-2-99"><a href="#annotated-cell-2-99" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_pos =</span> <span class="fu">sum</span>(pos_ends),</span>
<span id="annotated-cell-2-100"><a href="#annotated-cell-2-100" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-101"><a href="#annotated-cell-2-101" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="7">7</button><span id="annotated-cell-2-102" class="code-annotation-target"><a href="#annotated-cell-2-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">home_points =</span> end_home_score <span class="sc">-</span> start_home_score,</span>
<span id="annotated-cell-2-103"><a href="#annotated-cell-2-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">away_points =</span> end_away_score <span class="sc">-</span> start_away_score,</span>
<span id="annotated-cell-2-104"><a href="#annotated-cell-2-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">minutes =</span> end_minutes <span class="sc">-</span> start_minutes,</span>
<span id="annotated-cell-2-105"><a href="#annotated-cell-2-105" aria-hidden="true" tabindex="-1"></a>      <span class="at">pts_diff =</span> home_points <span class="sc">-</span> away_points,</span>
<span id="annotated-cell-2-106"><a href="#annotated-cell-2-106" aria-hidden="true" tabindex="-1"></a>      <span class="at">margin =</span> <span class="dv">100</span> <span class="sc">*</span> (pts_diff) <span class="sc">/</span> n_pos,</span>
<span id="annotated-cell-2-107"><a href="#annotated-cell-2-107" aria-hidden="true" tabindex="-1"></a>      <span class="at">game_id =</span> game_i) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-2-108"><a href="#annotated-cell-2-108" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(game_id, stint_id, </span>
<span id="annotated-cell-2-109"><a href="#annotated-cell-2-109" aria-hidden="true" tabindex="-1"></a>                  start_home_score, start_away_score,</span>
<span id="annotated-cell-2-110"><a href="#annotated-cell-2-110" aria-hidden="true" tabindex="-1"></a>                  start_minutes, </span>
<span id="annotated-cell-2-111"><a href="#annotated-cell-2-111" aria-hidden="true" tabindex="-1"></a>                  end_home_score, end_away_score, end_minutes,</span>
<span id="annotated-cell-2-112"><a href="#annotated-cell-2-112" aria-hidden="true" tabindex="-1"></a>                  home_lineup, away_lineup, n_pos,</span>
<span id="annotated-cell-2-113"><a href="#annotated-cell-2-113" aria-hidden="true" tabindex="-1"></a>                  home_points, away_points, minutes, pts_diff, margin) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="8">8</button><span id="annotated-cell-2-114" class="code-annotation-target"><a href="#annotated-cell-2-114" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(n_pos <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="annotated-cell-2-115"><a href="#annotated-cell-2-115" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-2-116"><a href="#annotated-cell-2-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-2-117"><a href="#annotated-cell-2-117" aria-hidden="true" tabindex="-1"></a>poss_get_game_stints <span class="ot">&lt;-</span> </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-2" data-target-annotation="9">9</button><span id="annotated-cell-2-118" class="code-annotation-target"><a href="#annotated-cell-2-118" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">possibly</span>(<span class="at">.f =</span> get_game_stint_data, <span class="at">otherwise =</span> <span class="cn">NULL</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-2" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="1" data-code-annotation="1">Function to extract the stints from a single game’s play-by-play</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="5" data-code-annotation="2">Initialize the starting score and margin (i.e., point differential per 100 possessions) at 0</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="11" data-code-annotation="3"><a href="https://tidyr.tidyverse.org/reference/fill.html"><code>tidyr::fill()</code></a> fills in missing values with the previous entry.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="16" data-code-annotation="4">Get the 5 home team players and a create a string of the numeric IDs separated by underscores (“_“)</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="20" data-code-annotation="5">Get the 5 away team players and a create a string of the numeric IDs separated by underscores (“_“)</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="23" data-code-annotation="6">Add the strings recording who is on the court to <code>game_data</code></span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="102" data-code-annotation="7">Compute number of points scored by each team and other game-state information</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="114" data-code-annotation="8">Remove stints with 0 possessions.</span>
</dd>
<dt data-target-cell="annotated-cell-2" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-2" data-code-lines="118" data-code-annotation="9">We will loop over many games. To prevent an error from prematurely terminating the loop (e.g., from a game with missing or corrupted play-by-play), we create a version that returns <code>NULL</code> when it hits an error.</span>
</dd>
</dl>
</div>
</div>
<p>The following code downloads play-by-play logs for every game in the 2024-25 season and applies the function defined above to create our stint-level data table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-3"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-3-1"><a href="#annotated-cell-3-1" aria-hidden="true" tabindex="-1"></a>raw_game_log <span class="ot">&lt;-</span> hoopR<span class="sc">::</span><span class="fu">nba_leaguegamelog</span>(<span class="at">season =</span> <span class="dv">2024</span>)</span>
<span id="annotated-cell-3-2"><a href="#annotated-cell-3-2" aria-hidden="true" tabindex="-1"></a>nba_game_log <span class="ot">&lt;-</span> raw_game_log<span class="sc">$</span>LeagueGameLog</span>
<span id="annotated-cell-3-3"><a href="#annotated-cell-3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-4"><a href="#annotated-cell-3-4" aria-hidden="true" tabindex="-1"></a>nba_season_games <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-3-5"><a href="#annotated-cell-3-5" aria-hidden="true" tabindex="-1"></a>  nba_game_log <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-6"><a href="#annotated-cell-3-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(GAME_ID) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="1">1</button><span id="annotated-cell-3-7" class="code-annotation-target"><a href="#annotated-cell-3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="annotated-cell-3-8"><a href="#annotated-cell-3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-9"><a href="#annotated-cell-3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-10"><a href="#annotated-cell-3-10" aria-hidden="true" tabindex="-1"></a>season_stint_data <span class="ot">&lt;-</span> </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="2">2</button><span id="annotated-cell-3-11" class="code-annotation-target"><a href="#annotated-cell-3-11" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(nba_season_games, <span class="sc">~</span><span class="fu">poss_get_game_stints</span>(.x)) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="3">3</button><span id="annotated-cell-3-12" class="code-annotation-target"><a href="#annotated-cell-3-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>()</span>
<span id="annotated-cell-3-13"><a href="#annotated-cell-3-13" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="4">4</button><span id="annotated-cell-3-14" class="code-annotation-target"><a href="#annotated-cell-3-14" aria-hidden="true" tabindex="-1"></a>game_stint_context <span class="ot">&lt;-</span></span>
<span id="annotated-cell-3-15"><a href="#annotated-cell-3-15" aria-hidden="true" tabindex="-1"></a>  season_stint_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-16"><a href="#annotated-cell-3-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="annotated-cell-3-17"><a href="#annotated-cell-3-17" aria-hidden="true" tabindex="-1"></a>    game_id, stint_id, n_pos,</span>
<span id="annotated-cell-3-18"><a href="#annotated-cell-3-18" aria-hidden="true" tabindex="-1"></a>    start_home_score, start_away_score,start_minutes, </span>
<span id="annotated-cell-3-19"><a href="#annotated-cell-3-19" aria-hidden="true" tabindex="-1"></a>    end_home_score, end_away_score, end_minutes,</span>
<span id="annotated-cell-3-20"><a href="#annotated-cell-3-20" aria-hidden="true" tabindex="-1"></a>    home_points, away_points, minutes, </span>
<span id="annotated-cell-3-21"><a href="#annotated-cell-3-21" aria-hidden="true" tabindex="-1"></a>    pts_diff, margin)</span>
<span id="annotated-cell-3-22"><a href="#annotated-cell-3-22" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="5">5</button><span id="annotated-cell-3-23" class="code-annotation-target"><a href="#annotated-cell-3-23" aria-hidden="true" tabindex="-1"></a>home_players_data <span class="ot">&lt;-</span></span>
<span id="annotated-cell-3-24"><a href="#annotated-cell-3-24" aria-hidden="true" tabindex="-1"></a>  season_stint_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-25"><a href="#annotated-cell-3-25" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(game_id, stint_id, home_lineup)<span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-26"><a href="#annotated-cell-3-26" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">separate_rows</span>(home_lineup, <span class="at">sep =</span> <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-27"><a href="#annotated-cell-3-27" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">on_court =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-28"><a href="#annotated-cell-3-28" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="annotated-cell-3-29"><a href="#annotated-cell-3-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(<span class="st">"game_id"</span>, <span class="st">"stint_id"</span>),</span>
<span id="annotated-cell-3-30"><a href="#annotated-cell-3-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> home_lineup,</span>
<span id="annotated-cell-3-31"><a href="#annotated-cell-3-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> on_court,</span>
<span id="annotated-cell-3-32"><a href="#annotated-cell-3-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="annotated-cell-3-33"><a href="#annotated-cell-3-33" aria-hidden="true" tabindex="-1"></a>home_players_cols <span class="ot">&lt;-</span> <span class="fu">colnames</span>(home_players_data)[<span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(home_players_data)]</span>
<span id="annotated-cell-3-34"><a href="#annotated-cell-3-34" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="6">6</button><span id="annotated-cell-3-35" class="code-annotation-target"><a href="#annotated-cell-3-35" aria-hidden="true" tabindex="-1"></a>away_players_data <span class="ot">&lt;-</span></span>
<span id="annotated-cell-3-36"><a href="#annotated-cell-3-36" aria-hidden="true" tabindex="-1"></a>  season_stint_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-37"><a href="#annotated-cell-3-37" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(game_id, stint_id, away_lineup) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-38"><a href="#annotated-cell-3-38" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">separate_rows</span>(away_lineup, <span class="at">sep =</span> <span class="st">"_"</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-39"><a href="#annotated-cell-3-39" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">on_court =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-40"><a href="#annotated-cell-3-40" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(</span>
<span id="annotated-cell-3-41"><a href="#annotated-cell-3-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_cols =</span> <span class="fu">c</span>(<span class="st">"game_id"</span>, <span class="st">"stint_id"</span>),</span>
<span id="annotated-cell-3-42"><a href="#annotated-cell-3-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> away_lineup,</span>
<span id="annotated-cell-3-43"><a href="#annotated-cell-3-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> on_court,</span>
<span id="annotated-cell-3-44"><a href="#annotated-cell-3-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_fill =</span> <span class="dv">0</span>)</span>
<span id="annotated-cell-3-45"><a href="#annotated-cell-3-45" aria-hidden="true" tabindex="-1"></a>away_players_cols <span class="ot">&lt;-</span> <span class="fu">colnames</span>(away_players_data)[<span class="dv">3</span><span class="sc">:</span><span class="fu">ncol</span>(away_players_data)]</span>
<span id="annotated-cell-3-46"><a href="#annotated-cell-3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-3-47"><a href="#annotated-cell-3-47" aria-hidden="true" tabindex="-1"></a>game_stint_players_data <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-3-48"><a href="#annotated-cell-3-48" aria-hidden="true" tabindex="-1"></a>  home_players_data <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="7">7</button><span id="annotated-cell-3-49" class="code-annotation-target"><a href="#annotated-cell-3-49" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(away_players_data) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-50"><a href="#annotated-cell-3-50" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(game_id, stint_id) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-51"><a href="#annotated-cell-3-51" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarize</span>(</span>
<span id="annotated-cell-3-52"><a href="#annotated-cell-3-52" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">across</span>(dplyr<span class="sc">::</span><span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">sum</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="annotated-cell-3-53"><a href="#annotated-cell-3-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="annotated-cell-3-54"><a href="#annotated-cell-3-54" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-3" data-target-annotation="8">8</button><span id="annotated-cell-3-55" class="code-annotation-target"><a href="#annotated-cell-3-55" aria-hidden="true" tabindex="-1"></a>rapm_data <span class="ot">&lt;-</span></span>
<span id="annotated-cell-3-56"><a href="#annotated-cell-3-56" aria-hidden="true" tabindex="-1"></a>  game_stint_context <span class="sc">|&gt;</span></span>
<span id="annotated-cell-3-57"><a href="#annotated-cell-3-57" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(game_stint_players_data,<span class="at">by =</span> <span class="fu">c</span>(<span class="st">"game_id"</span>, <span class="st">"stint_id"</span>))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-3" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="7" data-code-annotation="1">Get the ID number for every game</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="11" data-code-annotation="2">Loop over all game IDs and extract stint information</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="12" data-code-annotation="3"><a href="https://purrr.tidyverse.org/reference/map.html"><code>purrr::map()</code></a> stores the stint data table for each game as a separate element of a list. Here we concatenate each of these tables into a single table.</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="14" data-code-annotation="4">Pulls out the game-state/contextual information about each stint</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="23" data-code-annotation="5">Creates a column for every home team player’s on-court indicator</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="35" data-code-annotation="6">Creates a column for every away team player’s on-court indicator</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="49" data-code-annotation="7">Concatenates the home team indicators and away team indicators</span>
</dd>
<dt data-target-cell="annotated-cell-3" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-3" data-code-lines="55" data-code-annotation="8">Joins the player on-court indicators with the contextual information about the stint</span>
</dd>
</dl>
</div>
</div>
<p>The first 14 columns of <code>rapm_data</code> record:</p>
<ul>
<li>Numeric identifiers for the game (<code>game_id</code>) and stint (<code>stint_id</code>).</li>
<li>Both teams’ scores and the amount of time remaining at the start of a shift: <code>start_home_score</code>, <code>start_away_score</code>, and <code>start_minutes</code>.</li>
<li>Both teams’ scores and the amount of time remaining at the end of each shift: <code>end_home_score</code>, <code>end_away_score</code>, and <code>end_minutes</code>.</li>
<li>The length of a shift (<code>minutes</code>), the number of points scored by the home (<code>home_points</code>) and away team (<code>away_points</code>), and the number of possessions (<code>n_pos</code>).</li>
<li>The score differential <code>pts_diff = home_points - away_points</code>.</li>
<li>The score differential per 100 possessions, <code>margin = pts_diff/n_pos * 100</code>.</li>
</ul>
<p>The remaining columns record whether individual players are not on the court (0), on the court and playing at home (+1), or on the court and playing on the road (-1) in each stint. The names of these columns are just identifiers assigned by <strong>hoopR</strong>. The function <code>hoopR::nba_commonallplayers()</code> returns a table with all players identifiers and names. The code below uses the function <code>hoopR::nba_commonallplayers()</code> to make a look-up table containing player names and identifiers. It also creates a column where all accents and special characters have been removed, which makes it easier to look up player ids by name (i.e., we can type “Luka Doncic” instead of “Luka Dončić”).</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-4"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a>player_table <span class="ot">&lt;-</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1">1</button><span id="annotated-cell-4-2" class="code-annotation-target"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a>  hoopR<span class="sc">::</span><span class="fu">nba_commonallplayers</span>()[[<span class="st">"CommonAllPlayers"</span>]] <span class="sc">|&gt;</span></span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(PERSON_ID, DISPLAY_FIRST_LAST) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-4-4"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">id =</span> PERSON_ID, <span class="at">FullName =</span> DISPLAY_FIRST_LAST) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-4-5"><a href="#annotated-cell-4-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="2">2</button><span id="annotated-cell-4-6" class="code-annotation-target"><a href="#annotated-cell-4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">Name =</span> stringi<span class="sc">::</span><span class="fu">stri_trans_general</span>(FullName, <span class="st">"Latin-ASCII"</span>))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="2" data-code-annotation="1">The function returns a list with a single element named “CommonAllPlayers”. The <code>[[ ]]</code> bit pulls out the table.</span>
</dd>
<dt data-target-cell="annotated-cell-4" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="6" data-code-annotation="2">Transliterate player names to ASCII. Effectively this strips out the accents</span>
</dd>
</dl>
</div>
</div>
</section>
</section>
<section id="sec-pm" class="level2">
<h2 class="anchored" data-anchor-id="sec-pm">Plus/Minus</h2>
<p>Intuitively, we expect a team to perform better when a “good” player is on the court than when he is not on the court. Similarly, we expect a team to perform worse when a “bad” player is on the court than when he is not on the court. <em>Plus/Minus</em> (hereafter +/-) attempts to quantify this intuition by computing the total number of points by which a player’s team outscores their opponents when that player is on the floor. If a player has a large, positive +/- value, that means that the player’s team outscored its opponents by a large margin Similarly, a large, negative +/- value indicates that a player’s team was outscored by a wide margin when the player was on the court.</p>
<section id="sec-individual-pm" class="level3">
<h3 class="anchored" data-anchor-id="sec-individual-pm">Computing Individual +/-’s</h3>
<p>As an example, let’s compute the plus/minus values for Shai Gilgeous-Alexander (SGA), who was recognized as the league’s Most Valuable Player (MVP) in the 2024-25 regular season. To compute SGA’s +/-, we need to</p>
<ol type="1">
<li>Sum the home team point differentials (i.e., the values in the column <code>pts_diff</code>) for all shifts where SGA was on the court and playing at home.</li>
<li>Sum the <em>negative</em> of the home team point differentials for all shifts where SGA was on the court and playing on the road.</li>
<li>Add the two totals from Steps 1 and 2.</li>
</ol>
<p>Mathematically, for every stint <span class="math inline">\(i\)</span> in our data table, let <span class="math inline">\(\Delta_{i}\)</span> be the home team’s point differential during that shift. Additionally, let <span class="math inline">\(x_{i, \textrm{SGA}}\)</span> be the <em>signed on-court indicator</em> that is equal to 1 if SGA is on the court and playing at home during shift <span class="math inline">\(i\)</span>; -1 if Shai is on the court and playing on the road during shift <span class="math inline">\(i\)</span>; and 0 if SGA is not on the court during shift <span class="math inline">\(i.\)</span> Then, SGA’s +/- is equal to <span class="math display">\[
\sum_{i = 1}^{n}{x_{i,\textrm{SGA}} \times \Delta_{i}}.
\]</span> The data table <code>rapm_data</code> contains a column with the signed on-court indicators for every player. The names of these columns are just the <strong>hoopR</strong> identifiers, which were recorded in the <code>id</code> column of our look-up table <code>player_table</code>. The following code computes Shai’s +/- and uses the function <code>[dplyr::pull()</code>](https://dplyr.tidyverse.org/reference/pull.html) to extract values from specific columns of <code>rapm_data</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-5"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a>shai_id <span class="ot">&lt;-</span></span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a>  player_table <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1">1</button><span id="annotated-cell-5-3" class="code-annotation-target"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(Name <span class="sc">==</span> <span class="st">"Shai Gilgeous-Alexander"</span>) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2">2</button><span id="annotated-cell-5-4" class="code-annotation-target"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(id)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="3">3</button><span id="annotated-cell-5-5" class="code-annotation-target"><a href="#annotated-cell-5-5" aria-hidden="true" tabindex="-1"></a>shai_x <span class="ot">&lt;-</span> rapm_data <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(shai_id)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="4">4</button><span id="annotated-cell-5-6" class="code-annotation-target"><a href="#annotated-cell-5-6" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> rapm_data <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(pts_diff)</span>
<span id="annotated-cell-5-7"><a href="#annotated-cell-5-7" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="5">5</button><span id="annotated-cell-5-8" class="code-annotation-target"><a href="#annotated-cell-5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(shai_x <span class="sc">*</span> delta)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="3" data-code-annotation="1">Find the row in our look-up table corresponding to SGA</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="4" data-code-annotation="2">Since there is only one row corresponding to SGA, this saves SGA’s identifier as <code>shai_id</code></span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="5" data-code-annotation="3">Extracts the vector of SGA’s signed on-court indicators from the corresponding column of <code>rapm_data</code></span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="6" data-code-annotation="4">Extracts the vector of home team point differentials across all shifts from <code>rapm_data</code></span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="8" data-code-annotation="5">Computes SGA’s +/-</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 888</code></pre>
</div>
</div>
<p>We now repeat this calculation for Nikola Jokic, who finished second in the MVP voting in the 2024-25 regular season. His overall +/- is <em>substantially</em> smaller than SGA’s.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>jokic_id <span class="ot">&lt;-</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  player_table <span class="sc">|&gt;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(Name <span class="sc">==</span> <span class="st">"Nikola Jokic"</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(id)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>jokic_x <span class="ot">&lt;-</span> rapm_data <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(jokic_id) </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(jokic_x <span class="sc">*</span> delta) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 452</code></pre>
</div>
</div>
</section>
<section id="sec-matrix-pm" class="level3">
<h3 class="anchored" data-anchor-id="sec-matrix-pm">Matrix-Based Computation</h3>
<p>Repeating this calculation for all players one at a time is exceptionally tedious. Luckily, with a bit of matrix algebra, we can compute the +/- for <em>all</em> players in one shot.</p>
<p>To this end, let <span class="math inline">\(n\)</span> be the total number of stints in our data table and let <span class="math inline">\(p\)</span> be the total number of players. Just like we did for SGA and Jokic in <a href="#sec-individual-pm" class="quarto-xref">Section&nbsp;2.1</a>, for each shift <span class="math inline">\(i = 1, \ldots, n\)</span> and for each player <span class="math inline">\(j = 1, \ldots, p,\)</span> let <span class="math inline">\(x_{ij}\)</span> be the signed on-court indicator for player <span class="math inline">\(j\)</span> during shift <span class="math inline">\(i.\)</span> So, <span class="math inline">\(x_{ij}\)</span> is equal to 0 if player <span class="math inline">\(j\)</span> is not on the court during shift <span class="math inline">\(i\)</span> and is equal to 1 (resp. -1) if player <span class="math inline">\(j\)</span> is on the court and playing at home (resp. on the road) during shift <span class="math inline">\(i.\)</span> Player <span class="math inline">\(j\)</span>’s overall +/- is given by <span class="math display">\[
\sum_{i = 1}^{n}{x_{ij}\Delta_{i}}.
\]</span> We can arrange the <span class="math inline">\(x_{ij}\)</span> values into an <span class="math inline">\(n \times p\)</span> matrix <span class="math inline">\(\boldsymbol{\mathbf{X}}\)</span> so that <span class="math inline">\(x_{ij}\)</span> appears in in the <span class="math inline">\(j-th\)</span> column of the <span class="math inline">\(i\)</span>-th row (i.e., <span class="math inline">\(x_{ij}\)</span> is the <span class="math inline">\((i,j)\)</span> entry of <span class="math inline">\(\boldsymbol{\mathbf{X}}\)</span><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>). This way, the rows (resp. columns) of <span class="math inline">\(\boldsymbol{\mathbf{X}}\)</span> correspond to shifts (resp. players). Let <span class="math inline">\(\boldsymbol{\Delta}\)</span> be the vector of length <span class="math inline">\(n\)</span> whose <span class="math inline">\(i\)</span>-th entry is <span class="math inline">\(\Delta_{i},\)</span> the home-team point differential in shift <span class="math inline">\(i.\)</span></p>
<p>It turns out<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> that player <span class="math inline">\(j\)</span>’s +/- is the <span class="math inline">\(j\)</span>-th entry of the vector obtained when we multiply the <em>transpose</em>[^transpose] of <span class="math inline">\(\boldsymbol{\mathbf{X}}\)</span> by the vector <span class="math inline">\(\boldsymbol{\Delta}.\)</span> That is, if <span class="math display">\[
\boldsymbol{\mathbf{pm}} = \boldsymbol{\mathbf{X}}^{\top}\boldsymbol{\Delta},
\]</span> then the vector <span class="math inline">\(\boldsymbol{\mathbf{pm}}\)</span> contains <span class="math inline">\(p\)</span> entries and its <span class="math inline">\(j\)</span>-th entry is given by <span class="math display">\[
\textrm{pm}_{j} = \sum_{i = 1}^{n}{x_{ij}\Delta_{i}}.
\]</span> [^transpose]: The transpose of a matrix <span class="math inline">\(\boldsymbol{A}\)</span>, which is denoted as <span class="math inline">\(\boldsymbol{A}^{\top}\)</span>, is obtained by switching the rows and columns indices. For instance, <span class="math inline">\(\begin{pmatrix} 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \end{pmatrix}^{\top} = \begin{pmatrix} 1 &amp; 4 \\ 2 &amp; 5 \\ 3 &amp; 6 \end{pmatrix}.\)</span> See <a href="https://en.wikipedia.org/wiki/Transpose">this Wikipedia article</a> for more information.</p>
<p>The first 14 columns of the data table <code>rapm_data</code> contain contextual information about the stint. The remaining columns contain the values of each player’s signed on-court indicators. So, to form the matrix <span class="math inline">\(\boldsymbol{\mathbf{X}},\)</span> we just need to drop the contextual columns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-7"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1">1</button><span id="annotated-cell-7-1" class="code-annotation-target"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a>context_vars <span class="ot">&lt;-</span></span>
<span id="annotated-cell-7-2"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"game_id"</span>, <span class="st">"stint_id"</span>, <span class="st">"n_pos"</span>, </span>
<span id="annotated-cell-7-3"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"start_home_score"</span>, <span class="st">"start_away_score"</span>, <span class="st">"start_minutes"</span>,</span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"end_home_score"</span>, <span class="st">"end_away_score"</span>, <span class="st">"end_minutes"</span>,</span>
<span id="annotated-cell-7-5"><a href="#annotated-cell-7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"home_points"</span>, <span class="st">"away_points"</span>, <span class="st">"minutes"</span>,</span>
<span id="annotated-cell-7-6"><a href="#annotated-cell-7-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pts_diff"</span>, <span class="st">"margin"</span>)</span>
<span id="annotated-cell-7-7"><a href="#annotated-cell-7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-8"><a href="#annotated-cell-7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-9"><a href="#annotated-cell-7-9" aria-hidden="true" tabindex="-1"></a>X_full <span class="ot">&lt;-</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="2">2</button><span id="annotated-cell-7-10" class="code-annotation-target"><a href="#annotated-cell-7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>(</span>
<span id="annotated-cell-7-11"><a href="#annotated-cell-7-11" aria-hidden="true" tabindex="-1"></a>    rapm_data <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="3">3</button><span id="annotated-cell-7-12" class="code-annotation-target"><a href="#annotated-cell-7-12" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span> tidyr<span class="sc">::</span><span class="fu">all_of</span>(context_vars)))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="1" data-code-annotation="1">Vector of contextual variables contained in <code>rapm_data</code></span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="10" data-code-annotation="2">Converts from a <code>tibble</code> to a <code>matrix</code></span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="12" data-code-annotation="3">Drops the contextual variables</span>
</dd>
</dl>
</div>
</div>
<p>In R, we can compute the transpose of a matrix using the function <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/t.html"><code>t()</code></a>. But, it turns out that when we want to compute a product like <span class="math inline">\(\boldsymbol{\mathbf{X}}^{\top}\boldsymbol{\Delta},\)</span> it is much more efficient to use the function <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/crossprod.html"><code>crossprod()</code></a>.</p>
<p>The following code creates a data table <code>pm</code> with one column containing player id’s another column containing plus/minus values. It then uses an <code>inner_join</code> to append player names. The code also computes the number of possessions played by each player. To this end, let <span class="math inline">\(\textrm{pos}_{i}\)</span> be the number of possessions played during stint <span class="math inline">\(i\)</span>. Notice that <span class="math inline">\(\lvert x_{ij} \rvert\)</span> is equal to 1 whenever player <span class="math inline">\(j\)</span> is on the court and is equal to 0 otherwise. So, the number of possessions played by player <span class="math inline">\(j\)</span> is simply <span class="math inline">\(\sum_{i = 1}^{n}{\lvert x_{ij} \rvert \textrm{pos}_{i}}.\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-8-1"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a>pm <span class="ot">&lt;-</span></span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>( </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1">1</button><span id="annotated-cell-8-3" class="code-annotation-target"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="fu">colnames</span>(X_full),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="2">2</button><span id="annotated-cell-8-4" class="code-annotation-target"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">pm =</span> <span class="fu">crossprod</span>(<span class="at">x =</span> X_full, <span class="at">y =</span> delta),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="3">3</button><span id="annotated-cell-8-5" class="code-annotation-target"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pos =</span> <span class="fu">crossprod</span>(<span class="fu">abs</span>(X_full), <span class="at">y =</span> rapm_data <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(n_pos)),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="4">4</button><span id="annotated-cell-8-6" class="code-annotation-target"><a href="#annotated-cell-8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">minutes =</span> <span class="fu">crossprod</span>(<span class="fu">abs</span>(X_full), <span class="at">y =</span> rapm_data <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(minutes))) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="5">5</button><span id="annotated-cell-8-7" class="code-annotation-target"><a href="#annotated-cell-8-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> player_table <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(id, Name), <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="6">6</button><span id="annotated-cell-8-8" class="code-annotation-target"><a href="#annotated-cell-8-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(id, Name, pm, n_pos, minutes) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(pm))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="3" data-code-annotation="1">Creates a column containing player ID’s</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="4" data-code-annotation="2">Computes each player’s +/-.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="5" data-code-annotation="3">Computes the number of possessions played by each player. The function <code>abs()</code> computes absolute value. We used <code>dplyr::pull</code> to extract the number of possessions in each stint.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="6" data-code-annotation="4">Compute the number of minutes played by each player.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="7" data-code-annotation="5">Append only the names of players from <code>player_table</code> whose ID appears as a column name of <code>X_full</code></span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="8" data-code-annotation="6">Re-arrange the columns</span>
</dd>
</dl>
</div>
</div>
<p>Looking at the +/- values for a handful of selected players, we notice that SGA had a much higher +/- than many other prominent players in the league.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>selected_players <span class="ot">&lt;-</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"Shai Gilgeous-Alexander"</span>, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Jayson Tatum"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nikola Jokic"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Giannis Antetokounmpo"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Luka Doncic"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Anthony Davis"</span>, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"LeBron James"</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>pm <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(Name <span class="sc">%in%</span> selected_players) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(Name, pm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                     Name  pm
1 Shai Gilgeous-Alexander 888
2            Jayson Tatum 474
3            Nikola Jokic 452
4   Giannis Antetokounmpo 331
5             Luka Doncic 276
6           Anthony Davis -78
7            LeBron James -88</code></pre>
</div>
</div>
<p>The following code helps visualize just how much larger SGA’s +/- was compared to the rest of these selected players and the rest of the league.</p>
<div class="cell" data-layout-align="center" data-fit-asp="0.5625">
<div class="sourceCode cell-code" id="annotated-cell-10"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="1">1</button><span id="annotated-cell-10-1" class="code-annotation-target"><a href="#annotated-cell-10-1" aria-hidden="true" tabindex="-1"></a>oi_colors <span class="ot">&lt;-</span> <span class="fu">palette.colors</span>(<span class="at">palette =</span> <span class="st">"Okabe-Ito"</span>)</span>
<span id="annotated-cell-10-2"><a href="#annotated-cell-10-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(X_full)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="2">2</button><span id="annotated-cell-10-3" class="code-annotation-target"><a href="#annotated-cell-10-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ncol</span>(X_full)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="3">3</button><span id="annotated-cell-10-4" class="code-annotation-target"><a href="#annotated-cell-10-4" aria-hidden="true" tabindex="-1"></a>y_lim <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="fu">abs</span>(pm<span class="sc">$</span>pm)) <span class="sc">*</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.01</span>, <span class="fl">1.01</span>)</span>
<span id="annotated-cell-10-5"><a href="#annotated-cell-10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-6"><a href="#annotated-cell-10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="4">4</button><span id="annotated-cell-10-7" class="code-annotation-target"><a href="#annotated-cell-10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span>, <span class="at">type =</span> <span class="st">"n"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="5">5</button><span id="annotated-cell-10-8" class="code-annotation-target"><a href="#annotated-cell-10-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, p<span class="sc">+</span><span class="dv">1</span>), <span class="at">ylim =</span> y_lim,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="6">6</button><span id="annotated-cell-10-9" class="code-annotation-target"><a href="#annotated-cell-10-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">xaxt =</span> <span class="st">"n"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="7">7</button><span id="annotated-cell-10-10" class="code-annotation-target"><a href="#annotated-cell-10-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"+/-"</span>, <span class="at">main =</span> <span class="st">"Plus-Minus"</span>)</span>
<span id="annotated-cell-10-11"><a href="#annotated-cell-10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-10-12"><a href="#annotated-cell-10-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="8">8</button><span id="annotated-cell-10-13" class="code-annotation-target"><a href="#annotated-cell-10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(<span class="at">x =</span> <span class="fu">c</span>(p<span class="sc">+</span><span class="dv">1</span><span class="sc">-</span>i,p<span class="sc">+</span><span class="dv">1</span><span class="sc">-</span>i), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, pm<span class="sc">$</span>pm[i]),</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-10" data-target-annotation="9">9</button><span id="annotated-cell-10-14" class="code-annotation-target"><a href="#annotated-cell-10-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> oi_colors[<span class="dv">9</span>], <span class="at">lwd =</span> <span class="fl">0.25</span>)</span>
<span id="annotated-cell-10-15"><a href="#annotated-cell-10-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(pm<span class="sc">$</span>Name[i] <span class="sc">%in%</span> selected_players){</span>
<span id="annotated-cell-10-16"><a href="#annotated-cell-10-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(<span class="at">x =</span> p<span class="sc">+</span><span class="dv">1</span><span class="sc">-</span>i, <span class="at">y =</span> pm<span class="sc">$</span>pm[i], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.7</span>, <span class="at">col =</span> oi_colors[<span class="dv">3</span>])</span>
<span id="annotated-cell-10-17"><a href="#annotated-cell-10-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="annotated-cell-10-18"><a href="#annotated-cell-10-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">points</span>(<span class="at">x =</span> p<span class="sc">+</span><span class="dv">1</span><span class="sc">-</span>i, <span class="at">y =</span> pm<span class="sc">$</span>pm[i], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.25</span>, <span class="at">col =</span> oi_colors[<span class="dv">9</span>])</span>
<span id="annotated-cell-10-19"><a href="#annotated-cell-10-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="annotated-cell-10-20"><a href="#annotated-cell-10-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-10-21"><a href="#annotated-cell-10-21" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> oi_colors[<span class="dv">8</span>])</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-10" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="1" data-code-annotation="1">Load a color-blind friendly palette</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="3" data-code-annotation="2">Handy to keep the number of stints and players in our environment</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="4" data-code-annotation="3">To set symmetric vertical limits in our plot, we adjust the largest absolute +/- value by 1% in each direction.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="7" data-code-annotation="4">Tells R to set up the plot area but not to plot anything in it</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="8" data-code-annotation="5">Set the horizontal and vertical limits of the plot.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="9" data-code-annotation="6">Suppresses the horizontal axis and its labels</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="10" data-code-annotation="7">Label the vertical axis and add a title to the plot</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="13" data-code-annotation="8">The data table <code>pm</code> is sorted with +/- in decreasing order. To visualize these values in increasing order, we plot the <span class="math inline">\(i\)</span>-th largest +/- value at the horizontal coordinate <span class="math inline">\(p+1-i\)</span>.</span>
</dd>
<dt data-target-cell="annotated-cell-10" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-10" data-code-lines="14" data-code-annotation="9">The argument <code>lwd</code> controls the thickness of the lines. Setting it to 0.25 prevents over-plotting in this case</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="lecture04_files/figure-html/plot-pm-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="lecture04_files/figure-html/plot-pm-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-pm-issues" class="level3">
<h3 class="anchored" data-anchor-id="sec-pm-issues">Issues with +/-</h3>
<p>The gap SGA’s +/- and the +/- values for the rest of the league is striking. Is this gap really attributable to difference in skill alone? Or is the gap an artifact of some systematic factors? When we plot each player’s +/- against the number of possessions played, we find much more variation in the +/- values of players who played more possessions than those who played less.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">1</span>), <span class="at">mgp =</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fl">0.5</span>, <span class="dv">0</span>))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(pm<span class="sc">$</span>n_pos, pm<span class="sc">$</span>pm, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">cex =</span> <span class="fl">0.5</span>, <span class="at">col =</span> oi_colors[<span class="dv">9</span>],</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"Possessions played"</span>, <span class="at">ylab =</span> <span class="st">"+/-"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"Plus-Minus vs Possessions"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">col =</span> oi_colors[<span class="dv">8</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-pm-poss" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pm-poss-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="lecture04_files/figure-html/fig-pm-poss-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;1: Relationship between Plus/Minus and number of possessions played"><img src="lecture04_files/figure-html/fig-pm-poss-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="576"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pm-poss-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Relationship between Plus/Minus and number of possessions played
</figcaption>
</figure>
</div>
</div>
</div>
<p>Because +/- is an aggregated statistic — that is, it is formed by adding up contributions over the course of a season — this is not wholly surprising. We see that SGA, in particular, played <strong>many</strong> more possessions than the other players with the ten highest +/- values. Consequently, if player A has a higher +/- than player B, we cannot immediately conclude that A is better or more valuable than B due to potential disparities in opportunities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>pm <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        id                    Name  pm n_pos minutes
1  1628983 Shai Gilgeous-Alexander 888  8159 2837.31
2  1629652           Luguentz Dort 561  5584 1955.17
3  1630198              Isaiah Joe 552  4896 1715.11
4  1628401           Derrick White 509  6129 2327.72
5  1630596             Evan Mobley 508  5944 2049.43
6  1630598           Aaron Wiggins 507  4868 1683.08
7  1628378        Donovan Mitchell 491  6101 2106.53
8  1628369            Jayson Tatum 474  7498 2840.95
9  1628386           Jarrett Allen 459  6163 2142.82
10  203999            Nikola Jokic 452  7907 2707.97</code></pre>
</div>
</div>
<p>Looking at the top-10 plus/minus values reveals another potential issue: three of SGA’s teammates (Dort, Joe, Wiggins) appear in the top-10. Do we really believe that Lugentz Dort, who is known primarily for his defensive abilites, is the second-best player in the league? The player with the third-highest +/- is Isaiah Joe, who primarily came off the bench. Does this mean that the Oklahoma City Thunder under-utilitzed potentially the third-best player in the league?</p>
<p>Recall that +/- is computed by adding up the point differential for every player when they are on the court. So, if a player is fortunate enough to play alongside extremely talented teammates, they might post a high +/- rating, regardless of their actual contribution. Moreover, players who consistently find themselves playing against the opponents’ best players may have a lower +/- rating than players who more often play against their opponents’ second units. Thus, even if player A and player B played a similar number of possessions, A having a higher +/- than B still does not necessarily mean that A is better than B due to potential differences in their teammates and opponents.</p>
</section>
</section>
<section id="sec-apm-intro" class="level2">
<h2 class="anchored" data-anchor-id="sec-apm-intro">Adjusted Plus/Minus</h2>
<p>An inherent weakness, then, of +/- is that a player’s +/- necessarily depends on the performances of his teammates and opponents, which can vary dramatically across players. <em>Adjusted plus/minus</em>, which was first introduced by <a href="https://www.82games.com/comm30.htm">Rosenbaum in 2004</a>, attempts to take into account the quality of a player’s teammates and opponents. Paraphrasing Rosenbaum, adjusted plus/minus does not reward players for simply being fortunate enough to play with teammates better than their opponents.</p>
<p>As noted above, comparing totals runs the risk of favoring players with many more possessions. So, to facilitate fairer comparisons, APM first converts the point differential into rate, namely point differential per 100 possessions In our <code>rapm_data</code> data table, this quantity is saved in the column <code>margin</code><a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. We will denote the margin for stint <span class="math inline">\(i\)</span> by <span class="math inline">\(Y_{i}.\)</span></p>
<p>Formally, APM associates a number <span class="math inline">\(\alpha_{j}\)</span> to every player <span class="math inline">\(j = 1, \ldots, p\)</span> and models <span class="math display">\[
\begin{align}
Y_{i} &amp;= \alpha_{0} + \alpha_{h_{1}(i)} + \alpha_{h_{2}(i)} + \alpha_{h_{3}(i)} + \alpha_{h_{4}(i)} + \alpha_{h_{5}(i)} \\
~&amp;~~~~~~~~~~- \alpha_{a_{1}(i)} - \alpha_{a_{2}(i)} - \alpha_{a_{3}(i)} - \alpha_{a_{4}(i)} - \alpha_{a_{5}(i)} + \epsilon_{i},
\end{align}
\]</span> where <span class="math inline">\(h_{1}(i), \ldots, h_{5}(i)\)</span> and <span class="math inline">\(a_{1}(i), \ldots, a_{5}(i)\)</span> are, respectively, the indices of the homes and away team players on the court during stint <span class="math inline">\(i\)</span>; <span class="math inline">\(\alpha_{0}\)</span> captures the average home court advantage in terms of point-differential per 100 possessions across all teams; and the <span class="math inline">\(\epsilon_{i}\)</span>’s are independent random errors drawn from a distribution with mean zero. In other words, APM expresses the actually observed point differential per 100 possessions as a random deviation away from the <strong>expected</strong> point differential per 100 possessions when players <span class="math inline">\(h_{1}(i), \ldots, h_{5}(i)\)</span> play against <span class="math inline">\(a_{1}(i), \ldots, a_{5}(i).\)</span></p>
<p>To better understand the model, consider the first stint from the December 23, 2024 game between the Dallas Mavericks (away) and the Golden State Warriors (home). The players on the court were:</p>
<ul>
<li>Mavericks (away): Luka Doncic, Dereck Lively II, Kyrie Irving, P.J. Washington, and Klay Thompson</li>
<li>Warriors (home): Stephen Curry, Buddy Hield, Andrew Wiggins, Jonathan Kuminga, and Kevon Looney.</li>
</ul>
<p>Because the Mavericks were playing on the road, they would be expected to outscore the Warriors by <span class="math display">\[
\begin{align}
&amp;-1 \times (\alpha_{0} + \alpha_{SC} + \alpha_{BH} + \alpha_{AW} + \alpha_{JK} + \alpha_{KL}) \\
&amp;~~~~~+(\alpha_{LD} + \alpha_{KI} + \alpha_{DL} + \alpha_{PW} + \alpha_{KT}).
\end{align}
\]</span> points per 100 possessions during this stint. Now imagine that Luka Doncic were replaced by Anthony Davis<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> but the other 9 players remain on the court. Then, the Mavericks’ expected points differential per 100 possessions would be <span class="math display">\[
\begin{align}
&amp;-1 \times (\alpha_{0} + \alpha_{SC} + \alpha_{BH} + \alpha_{AW} + \alpha_{JK} + \alpha_{KL}) \\
&amp;~~~~~+(\alpha_{AD} + \alpha_{KI} + \alpha_{DL} + \alpha_{PW} + \alpha_{KT}).
\end{align}
\]</span> Taking the difference between these two expectations, under the APM model, the Mavericks are expected to outscore the Warriors by <span class="math inline">\(\alpha_{\textrm{AD}} - \alpha_{\textrm{LD}}\)</span> points per 100 possessions when they replace Dončić with Davis. More generally, the quantity <span class="math inline">\(\alpha_{j} - \alpha_{j'}\)</span> represents how many more points per 100 possessions a team expects to score when player <span class="math inline">\(j\)</span> is on the court than when he is replaced by player <span class="math inline">\(j'\)</span>.</p>
<section id="sec-apm-lm" class="level3">
<h3 class="anchored" data-anchor-id="sec-apm-lm">APM As A Linear Model</h3>
<p>Of course, we don’t know the exact <span class="math inline">\(\alpha_{j}\)</span> values and must use our data to <em>estimate</em> them. To this end, let <span class="math inline">\(\boldsymbol{\mathbf{Z}}\)</span> be the <span class="math inline">\(n \times (p+1)\)</span> matrix formed by appending a column of 1’s to the matrix <span class="math inline">\(\boldsymbol{\mathbf{X}}\)</span> and let <span class="math inline">\(\boldsymbol{\alpha} = (\alpha_{0}, \alpha_{1}, \ldots, \alpha_{p})^{\top}\)</span> be the vector of length <span class="math inline">\(p+1\)</span> containing the home court advantage <span class="math inline">\(\alpha_{0}\)</span> and all the player-specific parameters <span class="math inline">\(\alpha_{j}.\)</span> Then, letting <span class="math inline">\(\boldsymbol{\mathbf{z}}_{i}\)</span> be the <span class="math inline">\(i\)</span>-th row of <span class="math inline">\(\boldsymbol{\mathbf{Z}},\)</span> the APM model asserts that <span class="math display">\[
Y_{i} = \boldsymbol{\mathbf{z}}_{i}^{\top}\boldsymbol{\alpha} + \epsilon_{i}.
\]</span> That is, the APM model is really just a <em>multiple linear regression model</em><a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> where the predictors include the intercept and the signed on-court indicators for all players. Because it is just a linear model, it is tempting to estimate the unknown parameter vector <span class="math inline">\(\boldsymbol{\alpha}\)</span> using ordinary least squares.</p>
<p>That is, we want to find <span class="math inline">\(\hat{\boldsymbol{\alpha}}\)</span> that minimizes the quantity <span class="math display">\[
\sum_{i = 1}^{n}{\left( Y_{i} - \boldsymbol{\mathbf{z}}_{i}^{\top}\boldsymbol{\alpha} \right)^{2}} .
\]</span></p>
<p>Unfortunately, this problem does not have a unique solution because the matrix <span class="math inline">\(\boldsymbol{\mathbf{Z}}^{\top}\boldsymbol{\mathbf{Z}}\)</span> does not have a unique inverse. To see this, recall that each row of <span class="math inline">\(\boldsymbol{\mathbf{Z}}}\)</span> contains exactly 11 non-zero entries: * The first element in each row is equal to 1, corresponding to the intercept in the APM model * 5 entries equal to 1, corresponding to the five home players on the court during the stint * 5 entries equal to -1, correspond to the five away players on the court during the stint So, each row of <span class="math inline">\(\boldsymbol{\mathbf{Z}}\)</span> sums to zero, meaning that the matrix is not of full-rank. This in turn implies that <span class="math inline">\(\boldsymbol{\mathbf{Z}}^{\top}\boldsymbol{\mathbf{Z}}\)</span> does not have a unique inverse and that the optimization problem does not have a unique solution.</p>
</section>
<section id="sec-baseline" class="level3">
<h3 class="anchored" data-anchor-id="sec-baseline">Value Relative to Baseline</h3>
<p>In short, there are two main difficulties with our initial APM model. The first is practical: we simply cannot obtain player-specific estimates using the method of least squares. And even if we could, we face a more subtle problem: the individual parameters <span class="math inline">\(\alpha_{j}\)</span> are meaningless on their own and represent an absurd counter-factual situation.</p>
<p>To elaborate, earlier we considered a hypothetical scenario when Luka Dončić was replaced on the court by Anthony Davis. From that exercise, we saw that <span class="math inline">\(\alpha_{j} - \alpha_{j'}\)</span> quantifies how much a team’s point differential per 100 possessions changes if you replace player <span class="math inline">\(j'\)</span> by player <span class="math inline">\(j\)</span> and leave everything else unchanged. Using the exact same logic, we can conclude that <span class="math inline">\(\alpha_{j}\)</span> represents the change in point differential per 100 possession when you remove player <span class="math inline">\(j\)</span> from the court and don’t replace him with anybody else. Since teams <strong>never</strong> play 4-on-5, the absolute <span class="math inline">\(\alpha_{j}\)</span> values are meaningless.</p>
<p>To overcome these challenges, most analysts create a group of “baseline-level” players and, without losing any generality, they re-order the players <span class="math inline">\(j = 1, \ldots, p\)</span> so that the first <span class="math inline">\(p'\)</span> are non-baseline and the last <span class="math inline">\(p-p'\)</span> are baseline-level. Then, they <strong>assume</strong> that the <span class="math inline">\(\alpha_{j}\)</span>’s for all baseline-level players are identical and equal to some common value <span class="math inline">\(\mu.\)</span> For each non-baseline player <span class="math inline">\(j = 1, \ldots, \tilde{p},\)</span> they introduce the parameter <span class="math inline">\(\beta_{j} = \alpha_{j} - \mu.\)</span> Unlike the individual <span class="math inline">\(\alpha_{j}\)</span> values, the <span class="math inline">\(\beta_{j}\)</span> parameters for non-baseline players have a sensible interpretation: a team should expect to score <span class="math inline">\(\beta_{j}\)</span> more points per 100 possessions if they replace a baseline-level player with non-baseline player <span class="math inline">\(j\)</span>, keeping all other players on the court the same<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
<p>The <span class="math inline">\(\beta_{j}\)</span>’s can also be estimated using the method of least squares. Formally, let <span class="math inline">\(\beta_{0} = \alpha_{0};\)</span> <span class="math inline">\(\boldsymbol{\beta} = (\beta_{0}, \beta_{1}, \ldots, \beta_{p'})^{\top}\)</span> be the vector of unknown model parameters; and let <span class="math inline">\(\tilde{\boldsymbol{\mathbf{Z}}}\)</span> be the <span class="math inline">\(n \times (p'+1)\)</span> sub-matrix of <span class="math inline">\(\boldsymbol{\mathbf{Z}}\)</span> formed by removing the columns. It turns out that[^prove2] <span class="math display">\[
\tilde{\boldsymbol{\mathbf{Z}}}\boldsymbol{\beta} = \boldsymbol{\mathbf{Z}}\boldsymbol{\alpha}
\]</span> [^prove2]: Again, try to prove this yourself. If you run into any issues, ask on Piazza or stop by office hours.</p>
<p>However, unlike the matrix <span class="math inline">\(\boldsymbol{\mathbf{Z}},\)</span> the matrix <span class="math inline">\(\tilde{\boldsymbol{\mathbf{Z}}}\)</span> is full-rank, which means that the minimization problem <span class="math display">\[
\sum_{i = 1}^{n}{\left(Y_{i} - \tilde{\boldsymbol{\mathbf{z}}}_{i}^{\top}\boldsymbol{\beta}\right)^{2}}
\]</span> has a unique solution: <span class="math display">\[
\hat{\boldsymbol{\beta}} = \left( \tilde{\boldsymbol{\mathbf{Z}}}^{\top}\tilde{\boldsymbol{\mathbf{Z}}}\right)^{-1}\tilde{\boldsymbol{\mathbf{Z}}}^{\top}\boldsymbol{\mathbf{Y}}.
\]</span></p>
</section>
<section id="sec-apm-beta" class="level3">
<h3 class="anchored" data-anchor-id="sec-apm-beta">A Re-parametrized Model</h3>
<p>In practice, we rarely fit linear models like our re-parametrized APM model with manual matrix calculations. Instead, we rely on R’s built-in <code>lm()</code> function to do compute <span class="math inline">\(\hat{\boldsymbol{\beta}}.\)</span> To this end, it suffices to create a data table where each row corresponds to a stint and there are columns containing the margin for the stint and the signed on-court indicators for all <em>non-baseline</em> players.</p>
<p>Before proceeding, we need to define the set of baseline-level players. For our analysis, we will use a 250 minute threshold, classifying any player who played fewer than 250 minutes as baseline-level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nonbaseline_id <span class="ot">&lt;-</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  pm <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(minutes <span class="sc">&gt;=</span> <span class="dv">250</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we create a data table containing columns for the signed on-court indicators of all non-baseline players and the point differential per 100 possessions. Then, we fit the linear model and extract the estimated parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-14"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-14-1"><a href="#annotated-cell-14-1" aria-hidden="true" tabindex="-1"></a>apm_df <span class="ot">&lt;-</span></span>
<span id="annotated-cell-14-2"><a href="#annotated-cell-14-2" aria-hidden="true" tabindex="-1"></a>  rapm_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-14-3"><a href="#annotated-cell-14-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"margin"</span>, nonbaseline_id)))</span>
<span id="annotated-cell-14-4"><a href="#annotated-cell-14-4" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="1">1</button><span id="annotated-cell-14-5" class="code-annotation-target"><a href="#annotated-cell-14-5" aria-hidden="true" tabindex="-1"></a>apm_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(margin <span class="sc">~</span> ., <span class="at">data =</span> apm_df)</span>
<span id="annotated-cell-14-6"><a href="#annotated-cell-14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-14-7"><a href="#annotated-cell-14-7" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="2">2</button><span id="annotated-cell-14-8" class="code-annotation-target"><a href="#annotated-cell-14-8" aria-hidden="true" tabindex="-1"></a>beta0 <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(apm_fit)[<span class="dv">1</span>]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="3">3</button><span id="annotated-cell-14-9" class="code-annotation-target"><a href="#annotated-cell-14-9" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(apm_fit)[<span class="sc">-</span><span class="dv">1</span>]</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-14" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="5" data-code-annotation="1">Fit the linear model</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="8" data-code-annotation="2">Extract the intercept term, which captures the home-court advantage</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="9" data-code-annotation="3">Extract the estimates of <span class="math inline">\(\beta_{j}\)</span> for all non-baseline players</span>
</dd>
</dl>
</div>
</div>
<p>After inspecting the first few elements, we see that the elements of <code>beta</code> are named and that there is an additional character back-tick in the element names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>beta[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> `1628983`  `1629652`  `1630198`  `1628401`  `1630596` 
10.2568750  1.8500194  4.0660224 -0.8287388  7.9423890 </code></pre>
</div>
</div>
<p>We will build a data table similar to <code>pm</code> containing the id and estimated adjusted plus/minus value of every non-baseline player. To do this, we need to remove the back-tick from the names of <code>beta</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-16"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="1">1</button><span id="annotated-cell-16-1" class="code-annotation-target"><a href="#annotated-cell-16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(beta) <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="at">string =</span> <span class="fu">names</span>(beta), <span class="at">pattern =</span> <span class="st">"`"</span>)</span>
<span id="annotated-cell-16-2"><a href="#annotated-cell-16-2" aria-hidden="true" tabindex="-1"></a>apm <span class="ot">&lt;-</span></span>
<span id="annotated-cell-16-3"><a href="#annotated-cell-16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">names</span>(beta), <span class="at">apm =</span> beta) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-16-4"><a href="#annotated-cell-16-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> player_table, <span class="at">by =</span> <span class="st">"id"</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-16" data-target-annotation="2">2</button><span id="annotated-cell-16-5" class="code-annotation-target"><a href="#annotated-cell-16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(apm) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-16" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="1" data-code-annotation="1">Removes all instances of the back-tick from the names of <code>beta</code></span>
</dd>
<dt data-target-cell="annotated-cell-16" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-16" data-code-lines="5" data-code-annotation="2">Because <code>beta</code> is named, the data table <code>apm</code> is created with rownames, which are unnecessary. The top-10 players based on adjusted plus/minus looks quite a bit different than the raw plus/minus!</span>
</dd>
</dl>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>apm <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(apm)) <span class="sc">|&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Name, apm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    Name      apm
1          Tobias Harris 17.01331
2         Mouhamed Gueye 16.79320
3           Devin Carter 16.60148
4             Trae Young 15.13287
5  Giannis Antetokounmpo 14.61082
6            Isaiah Wong 14.50091
7           Nikola Jokic 14.40837
8         Alperen Sengun 13.55544
9        Quenton Jackson 13.13962
10    Karl-Anthony Towns 13.13714</code></pre>
</div>
</div>
</section>
<section id="weighted-adjusted-plusminus" class="level3">
<h3 class="anchored" data-anchor-id="weighted-adjusted-plusminus">Weighted adjusted plus/minus</h3>
<p>Although APM takes into account the quality of the teammates and opponents with whom each player plays, it fails to account fully for the <em>context</em> in which players play. Quoting <span class="citation" data-cites="DeshpandeJensen2016">Deshpande and Jensen (<a href="#ref-DeshpandeJensen2016" role="doc-biblioref">2016</a>)</span>, as a result, metrics like APM &gt; “can artificially can artificially inflate the importance of performance in low-leverage situations, when the outcome of the game is essentially decided, while simultaneously deflating the importance of high-leverage performance, when the final outcome is still in question. For instance, point diﬀerential-based metrics model the home team’s lead dropping from 5 points to 0 points in the last minute of the first half in exactly the same way that they model the home team’s lead dropping from 30 points to 25 points in the last minute of the second half”.</p>
<p>To overcome this limitation, we might try to down-weight low-leverage stints and up-weight high-leverage stints. For instance, we might assign a weight <span class="math inline">\(w_{i}\)</span> to stint <span class="math inline">\(i\)</span> where * <span class="math inline">\(w_{i} = 1\)</span> if, at the start of stint <span class="math inline">\(i,\)</span> the teams are within 10 points of each other * <span class="math inline">\(w_{i} = 0\)</span> if, at the start of the stint <span class="math inline">\(i,\)</span> the difference in scores exceed 30 points * <span class="math inline">\(w_{i} = 1 - (\textrm{StartDiff} - 10)/20\)</span>: if, at the start of stint <span class="math inline">\(i,\)</span> the difference in scores is between 10 and 30 points. This weight smoothly interpolates between 0 (when the difference is 30) and 1 (when the difference is 10).</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-18"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-18-1"><a href="#annotated-cell-18-1" aria-hidden="true" tabindex="-1"></a>wapm_df <span class="ot">&lt;-</span></span>
<span id="annotated-cell-18-2"><a href="#annotated-cell-18-2" aria-hidden="true" tabindex="-1"></a>  rapm_data <span class="sc">|&gt;</span></span>
<span id="annotated-cell-18-3"><a href="#annotated-cell-18-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="1">1</button><span id="annotated-cell-18-4" class="code-annotation-target"><a href="#annotated-cell-18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_diff =</span> <span class="fu">abs</span>(start_home_score <span class="sc">-</span> start_away_score),</span>
<span id="annotated-cell-18-5"><a href="#annotated-cell-18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">w =</span> dplyr<span class="sc">::</span><span class="fu">case_when</span>(</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="2">2</button><span id="annotated-cell-18-6" class="code-annotation-target"><a href="#annotated-cell-18-6" aria-hidden="true" tabindex="-1"></a>      start_diff <span class="sc">&lt;</span> <span class="dv">10</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="3">3</button><span id="annotated-cell-18-7" class="code-annotation-target"><a href="#annotated-cell-18-7" aria-hidden="true" tabindex="-1"></a>      start_diff <span class="sc">&gt;</span> <span class="dv">30</span> <span class="sc">~</span> <span class="dv">0</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-18" data-target-annotation="4">4</button><span id="annotated-cell-18-8" class="code-annotation-target"><a href="#annotated-cell-18-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">.default =</span> <span class="dv">1</span> <span class="sc">-</span> (start_diff<span class="dv">-10</span>)<span class="sc">/</span><span class="dv">20</span>)) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-18-9"><a href="#annotated-cell-18-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(tidyr<span class="sc">::</span><span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">"margin"</span>, <span class="st">"w"</span>, nonbaseline_id)))</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-18" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="4" data-code-annotation="1">Create a variable recording the lead at the start of the shift</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="6" data-code-annotation="2">Set weight = 1 if the starting lead is less than 10 points</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="7" data-code-annotation="3">Set weight = 0 if starting lead exceeds 30 points</span>
</dd>
<dt data-target-cell="annotated-cell-18" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-18" data-code-lines="8" data-code-annotation="4">Assign a weight between 0 and 1 if the starting lead is between 10 and 30 points</span>
</dd>
</dl>
</div>
</div>
<p>Then the weighted adjusted plus/minus coefficients <span class="math inline">\(\hat{\boldsymbol{\beta}}_{w}\)</span> is the unique minimizer of <span class="math display">\[
\sum_{i = 1}^{n}{w_{i}\left(Y_{i} - \tilde{\boldsymbol{\mathbf{z}}}_{i}^{\top}\boldsymbol{\beta}\right)^{2}}
\]</span> and can be computed in closed form as <span class="math display">\[
\hat{\boldsymbol{\beta}}_{w} = \left( \tilde{\boldsymbol{\mathbf{Z}}}^{\top}\tilde{\boldsymbol{\mathbf{Z}}}\right)^{-1}\tilde{\boldsymbol{\mathbf{Z}}}^{\top}\boldsymbol{\mathbf{W}}\boldsymbol{\mathbf{Y}},
\]</span> where <span class="math inline">\(\boldsymbol{\mathbf{W}}\)</span> is a <span class="math inline">\(n \times n\)</span> diagonal matrix with the weights <span class="math inline">\(w_{i}\)</span> along the diagonal.</p>
<p>As with regular APM, in practice, we can fit a weighted APM model using <code>lm()</code>. The main difference is that we must (i) include a vector of weights in the data frame that we pass; (ii) specify the weights using the <code>weights</code> argument; and (iii) exclude the weight variable from the linear predictor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-19"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-19-1"><a href="#annotated-cell-19-1" aria-hidden="true" tabindex="-1"></a>wapm_fit <span class="ot">&lt;-</span> </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="1">1</button><span id="annotated-cell-19-2" class="code-annotation-target"><a href="#annotated-cell-19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lm</span>(<span class="at">formula =</span> margin <span class="sc">~</span> . <span class="sc">-</span> w,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="2">2</button><span id="annotated-cell-19-3" class="code-annotation-target"><a href="#annotated-cell-19-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">weights =</span> w,</span>
<span id="annotated-cell-19-4"><a href="#annotated-cell-19-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">data =</span> wapm_df) </span>
<span id="annotated-cell-19-5"><a href="#annotated-cell-19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-19-6"><a href="#annotated-cell-19-6" aria-hidden="true" tabindex="-1"></a>wbeta0 <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(wapm_fit)[<span class="dv">1</span>]</span>
<span id="annotated-cell-19-7"><a href="#annotated-cell-19-7" aria-hidden="true" tabindex="-1"></a>wbeta <span class="ot">&lt;-</span> <span class="fu">coefficients</span>(wapm_fit)[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="annotated-cell-19-8"><a href="#annotated-cell-19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-19-9"><a href="#annotated-cell-19-9" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(wbeta) <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(<span class="at">string =</span> <span class="fu">names</span>(wbeta), <span class="at">pattern =</span> <span class="st">"`"</span>)</span>
<span id="annotated-cell-19-10"><a href="#annotated-cell-19-10" aria-hidden="true" tabindex="-1"></a>wapm <span class="ot">&lt;-</span></span>
<span id="annotated-cell-19-11"><a href="#annotated-cell-19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">id =</span> <span class="fu">names</span>(wbeta), <span class="at">wapm =</span> wbeta) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-19-12"><a href="#annotated-cell-19-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">inner_join</span>(<span class="at">y =</span> player_table, <span class="at">by =</span> <span class="st">"id"</span>)</span>
<span id="annotated-cell-19-13"><a href="#annotated-cell-19-13" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(wapm) <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-19" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="2" data-code-annotation="1">The <code>-w</code> in the <code>formula</code> argument signals to R that it should <em>not</em> include the variable <code>w</code> as a linear predictor. See <a href="https://www.econometrics.blog/post/the-r-formula-cheatsheet/">this cheatseet</a> for more details about the formula interface</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="3" data-code-annotation="2">Tells <code>lm</code> that it should weight observations by whatever is in the column <code>w</code> in <code>wapm_df</code></span>
</dd>
</dl>
</div>
</div>
<p>Because we have now weight stints differently, we see that the top-10 players according to our weighted adjusted plus/minus metric is somewhat different than the original adjutsed plus/minus metric.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>wapm <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">arrange</span>(dplyr<span class="sc">::</span><span class="fu">desc</span>(wapm)) <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Name, wapm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                Name     wapm
1       Devin Carter 19.48318
2      Tobias Harris 17.11044
3    Lauri Markkanen 15.20344
4     Mouhamed Gueye 14.76474
5         Trae Young 14.52393
6       Nikola Jokic 14.14573
7     Alperen Sengun 14.03023
8         OG Anunoby 13.96219
9  Jordan McLaughlin 13.73760
10      Jericho Sims 13.27850</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-looking-ahead" class="level2">
<h2 class="anchored" data-anchor-id="sec-looking-ahead">Looking Ahead</h2>
<p>To fit our adjusted plus/minus model using the method of least squares, we specified a set of baseline-level players and <strong>assumed</strong> that all the baseline players had the exact same partial effect on their team’s average point differential per 100 possessions. This is a very strong and, frankly, unrealistic assumption! The use of baseline players and the assumed equality of their impact was motivated by a <em>numerical</em> challenge, viz.&nbsp;the inability to solve the least squares minimiziation problem when our design matrix <span class="math inline">\(\boldsymbol{\mathbf{Z}}\)</span> had constant row sums. In <a href="../lectures/lecture05.html">Lecture 5</a>, we will introduce an alternative approach to fitting adjusted plus/minus models that avoids the need to specify baseline players by solving a <em>regularized</em> version of the least squares problem. We save our player look-up table, the matrix <code>X_full</code>, and the vector of point differentials per 100 possessions so that we can load them next time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> apm_df<span class="sc">$</span>margin</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(X_full, Y, player_table, <span class="at">file =</span> <span class="st">"lecture04_05_data.RData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<ol type="1">
<li>Explore the sensitivity of APM and our weighted APM to different choices of the minutes cut-off used to define the baseline player. How much do the top- and bottom-10 player rankings change?</li>
<li>We weighted stints using only on the lead at the start of the stint. One can reasonably argue that our weights should also account for the time left in the game. Propose your own weighting scheme and see how the player rankings change.</li>
<li>We estimated APM using data from a single season. Many analysts prefer to use data from multiple season when fitting APM models. Scrape data from the 2022-23 and 2023-24 regular seasons and fit APM models using (i) data from 2023-24 and 2024-25 and (iii) data from 2022-23, 2023-34, and 2024-25.</li>
<li>One can credibly argue that data from seasons further in the past should be weighted less than data from more recent seasons. Propose a weighting scheme that down-weights historical data and fit weighted versions of the models in Exercise 4.3. How do the relative player rankings change?</li>
<li>Estimate the out-of-sample predictive mean square error of our basic APM model using 100 training/testing splits. That is, for each training and testing split, fit the APM model using the training data and then compute the average of the squared difference between the actual <span class="math inline">\(Y\)</span>’s and the model predictions in the testing split. Is APM a good predictive model? Why or why not?</li>
</ol>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-DeshpandeJensen2016" class="csl-entry" role="listitem">
Deshpande, Sameer K., and Shane T. Jensen. 2016. <span>“Estimating an <span>NBA</span> Player’s Impact on His Team’s Chances of Winning.”</span> <em>Journal of Quantitative Analysis in Sports</em> 12 (2): 51–72.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>It is the game in which Luka Dončić <del>embarassed</del> hit a step-back 3 pointer over Rudy Goert to win the game (<a href="https://www.nba.com/stats/events?CFID=&amp;CFPARAMS=&amp;GameEventID=682&amp;GameID=0042300312&amp;Season=2023-24&amp;flag=1&amp;title=Doncic%2025%27%203PT%20Step%20Back%20Jump%20Shot%20(32%20PTS)">link</a>).<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>See <a href="https://en.wikipedia.org/wiki/Index_notation#Two-dimensional_arrays">this Wikipedia entry</a> for background on on index notation for two-dimensional arrays.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>See <a href="https://en.wikipedia.org/wiki/Matrix_multiplication#Matrix_times_vector">the Wikipedia entry on matrix-vector multiplication</a> for the formula.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>As best I can tell, the name <code>margin</code> refers back to the <a href="https://www.82games.com/comm30.htm">original article</a>.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>Fire Nico.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>Multiple linear regression is a focus of STAT 333. If you have taken that class, I encourage you to go back through your notes from it. And if you have not taken that class, I <strong>highly</strong> recommend reviewing <a href="https://bookdown.org/roback/bookdown-BeyondMLR/ch-MLRreview.html#multreg">Section 1.6</a> of the book <em>Beyond Multiple Linear Regression</em> and Sections 3.1 and 3.2 of <a href="https://www.statlearning.com"><em>An Introduction to Statistical Learning</em></a>.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>Try proving this for yourself! If you find yourself getting stuck with this, ask your classmates on Piazza or come to the instructor’s Friday office hours.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>