<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Lecture 15: Markov Chains II – STAT479</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-4bfb630b09c0e164834af1bb3207dbff.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">STAT479</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../syllabus.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-lecture-notes" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Lecture Notes</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-lecture-notes">    
        <li>
    <a class="dropdown-item" href="../lectures/lecture00.html">
 <span class="dropdown-text">Lecture 0: Boxscore Metrics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture02.html">
 <span class="dropdown-text">Lecture 2: Expected Goals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture03.html">
 <span class="dropdown-text">Lecture 3: Estimating XG</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture04.html">
 <span class="dropdown-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture05.html">
 <span class="dropdown-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture06.html">
 <span class="dropdown-text">Lecture 6: Run Expectancy</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture07.html">
 <span class="dropdown-text">Lecture 7: Offensive Credit Allocation in Baseball</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture08.html">
 <span class="dropdown-text">Lecture 8: Defensive Credit Allocation in Baseball</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture09.html">
 <span class="dropdown-text">Lecture 9: Multilevel Modeling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture10.html">
 <span class="dropdown-text">Lecture 10: NFl WAR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture11.html">
 <span class="dropdown-text">Lecture 11: Pitch Framing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture12.html">
 <span class="dropdown-text">Lecture 12: Bradley-Terry Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture13.html">
 <span class="dropdown-text">Lecture 13: Tournament Simulation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture14.html">
 <span class="dropdown-text">Lecture 14: Markov Chains I</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../lectures/lecture15.html">
 <span class="dropdown-text">Lecture 15: Markov Chains II</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-lecture-slides" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Lecture Slides</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-lecture-slides">    
        <li>
    <a class="dropdown-item" href="../slides/lecture01.html">
 <span class="dropdown-text">Lecture 1</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture02.html">
 <span class="dropdown-text">Lecture 2: Expected Goals</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture03.html">
 <span class="dropdown-text">Lecture 3: Estimating XG</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture04.html">
 <span class="dropdown-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture05.html">
 <span class="dropdown-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture06.html">
 <span class="dropdown-text">Lecture 6: Expected Runs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture07.html">
 <span class="dropdown-text">Lecture 7: Offensive Credit</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture08.html">
 <span class="dropdown-text">Lecture 8: Defensive Credit Allocation &amp; WAR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture09.html">
 <span class="dropdown-text">Lecture 9: Multilevel Models</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture10.html">
 <span class="dropdown-text">Lecture 10: NFL WAR</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture11.html">
 <span class="dropdown-text">Lecture 11: Pitch Framing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture12.html">
 <span class="dropdown-text">Lecture 12: Bradley-Terry Models I</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture13.html">
 <span class="dropdown-text">Lecture 13: Bradley-Terry Models II</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../slides/lecture14.html">
 <span class="dropdown-text">Lecture 14: Markov Chains I</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../project1.html"> 
<span class="menu-text">Project 1 Information</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../project2.html"> 
<span class="menu-text">Project 2 Information</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../project3.html"> 
<span class="menu-text">Project 3 Information</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../lectures/lecture15.html">Lecture 15: Markov Chains II</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture00.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 0: Boxscore Metrics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 2: Expected Goals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 3: Estimating XG</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 4: Adjusted Plus/Minus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 5: Regularized Adjusted Plus/Minus</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 6: Run Expectancy</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 7: Offensive Credit Allocation in Baseball</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 8: Defensive Credit Allocation in Baseball</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 9: Multilevel Modeling</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 10: NFl WAR</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 11: Pitch Framing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 12: Bradley-Terry Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 13: Tournament Simulation</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lecture 14: Markov Chains I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../lectures/lecture15.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Lecture 15: Markov Chains II</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#sec-fourteam-example" id="toc-sec-fourteam-example" class="nav-link" data-scroll-target="#sec-fourteam-example">The Random Behavior of a Bandwagon Fan</a></li>
  <li><a href="#limiting-distributions-of-markov-chains" id="toc-limiting-distributions-of-markov-chains" class="nav-link" data-scroll-target="#limiting-distributions-of-markov-chains">Limiting Distributions of Markov Chains</a>
  <ul class="collapse">
  <li><a href="#sec-nstep-dist" id="toc-sec-nstep-dist" class="nav-link" data-scroll-target="#sec-nstep-dist">Distribution of <span class="math inline">\(X_{n}\)</span></a></li>
  <li><a href="#sec-invariant-dist" id="toc-sec-invariant-dist" class="nav-link" data-scroll-target="#sec-invariant-dist">Invariant Distributions</a></li>
  <li><a href="#sec-eigenvalue" id="toc-sec-eigenvalue" class="nav-link" data-scroll-target="#sec-eigenvalue">Computing Invariant Distributions</a></li>
  </ul></li>
  <li><a href="#sec-mc-ranking" id="toc-sec-mc-ranking" class="nav-link" data-scroll-target="#sec-mc-ranking">Markov chain-based Rankings</a>
  <ul class="collapse">
  <li><a href="#damping" id="toc-damping" class="nav-link" data-scroll-target="#damping">Damping</a></li>
  <li><a href="#score-based-markov-chain-rankings" id="toc-score-based-markov-chain-rankings" class="nav-link" data-scroll-target="#score-based-markov-chain-rankings">Score-based Markov Chain Rankings</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lecture 15: Markov Chains II</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>In <a href="../lectures/lecture14.html">Lecture 14</a>, we estimated the matrix of transition probabilities for 25 different game-states in baseball. 24 of these states corresponded to the combinations of outs and base runner configurations. The final state was the three-out state, representing the end of the half-inning. We simulated Markov chains that randomly walked between these states according to the estimated transition matrix</p>
<p>In this lecture, we will explore how Markov chains can be used to derive power rankings for teams from head-to-head competitions. Unlike our <a href="../lectures/lecture12.html">rankings derived from Bradley-Terry models</a>, these Markov chain-based rankings cannot immediately be used to estimate the probability of one team beating another. Instead, they are based on mathematical properties of specifically constructed Markov chain models over the state space of teams. These Markov chains model the behavior of a hypothetical”bandwagon” fan who tries to identify the “best” team by randomly switching their support from team <span class="math inline">\(s\)</span> to team <span class="math inline">\(s'\)</span> based on how often and/or by how many points team <span class="math inline">\(s'\)</span> beats team <span class="math inline">\(s.\)</span> If we simulate a Markov chain modeling the fan’s behavior, we can estimate the relative frequencies with which the fan supports each team. These relatively frequencies immediately give us a rank-ordering of the teams based on how often the bandwagon fan think that they are best.</p>
<p>We begin in <a href="#sec-fourteam-example" class="quarto-xref">Section&nbsp;2</a> by illustrating such a Markov chain inWe first</p>
</section>
<section id="sec-fourteam-example" class="level2">
<h2 class="anchored" data-anchor-id="sec-fourteam-example">The Random Behavior of a Bandwagon Fan</h2>
<p>Imagine a bandwagon fan who randomly switches their support each day between four teams (<code>W</code>, <code>O</code>, <code>M</code>, and <code>C</code>) according to the transition probabilities in <a href="#fig-fourstate-graph" class="quarto-xref">Figure&nbsp;1</a>. For instance, if they currently support <code>W</code> today, tomorrow they will support</p>
<ul>
<li>Team <code>W</code> with probability 0.05 (i.e., they stay at vertex <code>W</code>)</li>
<li>Team <code>M</code> with probability 0.05 (i.e., they move from vertex <code>W</code> to vertex <code>M</code>)</li>
<li>Team <code>O</code> with probability 0.85 (i.e., they move from vertex <code>W</code> to vertex <code>O</code>)</li>
<li>Team <code>C</code> with probability 0.05 (i.e., they move from vertex <code>W</code> to vertex <code>C</code>)</li>
</ul>
<p>Once the fan selects their new team to support, the process begins again: based on their current favorite team, they pick a new team based on the weights if the outgoing edges from the corresponding vertex in the graph.</p>
<div id="fig-fourstate-graph" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fourstate-graph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="figures/four-state-graph.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Graphical representation of the transition matrix of a fan who randomly choose which team to support"><img src="figures/four-state-graph.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:50.0%"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fourstate-graph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Graphical representation of the transition matrix of a fan who randomly choose which team to support
</figcaption>
</figure>
</div>
<p>The following code defines a <em>function</em> that simulates the Markov chain describing the fans behavior. The function takes three arguments: the starting state (i.e., the team the fan initially supports); the number of iterations to simulate; and the transition matrix <span class="math inline">\(\boldsymbol{\mathbf{P}}.\)</span> It then returns the relative proportion of times that the chain spends in each state (i.e., how often the fan supports each team).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>fan_walk <span class="ot">&lt;-</span> <span class="cf">function</span>(init_state, n_iter, P){</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  states <span class="ot">&lt;-</span> <span class="fu">colnames</span>(P)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  states_visited <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times =</span> n_iter)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  states_visited[<span class="dv">1</span>] <span class="ot">&lt;-</span> init_state</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(r <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n_iter){</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    states_visited[r] <span class="ot">&lt;-</span> </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sample</span>(states, <span class="at">size =</span> <span class="dv">1</span>, </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">prob =</span> P[states_visited[r<span class="dv">-1</span>],])</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  props <span class="ot">&lt;-</span> <span class="fu">table</span>(states_visited)[states]<span class="sc">/</span>n_iter</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(props)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we define the matrix <span class="math inline">\(\boldsymbol{\mathbf{P}}\)</span> correspond to the graph in <a href="#fig-fourstate-graph" class="quarto-xref">Figure&nbsp;1</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>teams <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"W"</span>, <span class="st">"O"</span>, <span class="st">"C"</span>, <span class="st">"M"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.85</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.425</span>, <span class="fl">0.075</span>, <span class="fl">0.075</span>, <span class="fl">0.425</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.05</span>, <span class="fl">0.85</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>              <span class="fl">0.53</span>, <span class="fl">0.32</span>, <span class="fl">0.075</span>, <span class="fl">0.075</span>), </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">byrow =</span> <span class="cn">TRUE</span>, <span class="at">nrow =</span> <span class="dv">4</span>, <span class="at">ncol =</span> <span class="dv">4</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">dimnames =</span> <span class="fu">list</span>(teams, teams))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">479</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">fan_walk</span>(<span class="at">init_state =</span> <span class="st">"W"</span>, <span class="at">n_iter =</span> <span class="fl">1e6</span>, <span class="at">P =</span> P), <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>states_visited
    W     O     C     M 
0.307 0.416 0.066 0.211 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">fan_walk</span>(<span class="at">init_state =</span> <span class="st">"O"</span>, <span class="at">n_iter =</span> <span class="fl">1e6</span>, <span class="at">P =</span> P), <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>states_visited
    W     O     C     M 
0.307 0.416 0.066 0.211 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">fan_walk</span>(<span class="at">init_state =</span> <span class="st">"C"</span>, <span class="at">n_iter =</span> <span class="fl">1e6</span>, <span class="at">P =</span> P), <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>states_visited
    W     O     C     M 
0.307 0.416 0.066 0.211 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">fan_walk</span>(<span class="at">init_state =</span> <span class="st">"M"</span>, <span class="at">n_iter =</span> <span class="fl">1e6</span>, <span class="at">P =</span> P), <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>states_visited
    W     O     C     M 
0.308 0.416 0.066 0.211 </code></pre>
</div>
</div>
<p>The long-run frequency that the chain spends in each state is remarkably stable: regardless of their initial preference, the fan spends about 30% of their time supporting <code>W</code>; 42% of the time supporting <code>O</code>; 7% of the time supporting <code>C</code>; and 21% of the time supporting <code>M</code>.</p>
</section>
<section id="limiting-distributions-of-markov-chains" class="level2">
<h2 class="anchored" data-anchor-id="limiting-distributions-of-markov-chains">Limiting Distributions of Markov Chains</h2>
<p>The stability in the long-run proportion of time spent in each state in the four-team example is not coincidental!</p>
<section id="sec-nstep-dist" class="level3">
<h3 class="anchored" data-anchor-id="sec-nstep-dist">Distribution of <span class="math inline">\(X_{n}\)</span></h3>
<p>Suppose that <span class="math inline">\(\{X_{t}\}\)</span> is a Markov chain defined on the states <span class="math inline">\(\{1, 2, \ldots, S\}\)</span> with transition matrix <span class="math inline">\(\boldsymbol{\mathbf{P}}.\)</span> Let <span class="math inline">\(\boldsymbol{\pi}_{0} = (\pi_{0,1}, \ldots, \pi_{0,S})^{\top}\)</span> be a vector of probabilities. Now suppose that we initialize the Markov chain randomly according to <span class="math inline">\(\boldsymbol{\pi}_{0}.\)</span> That is, for each state <span class="math inline">\(s \in \{1, 2, \ldots, S\},\)</span> <span class="math inline">\(\mathbb{P}(X_{0} = s) = \pi_{0,s}.\)</span> If we initialize the Markov chain according to <span class="math inline">\(\boldsymbol{\pi}_{0}\)</span> and then simulate the Markov chain for <span class="math inline">\(n\)</span> steps, what is the probability that the chain is in state <span class="math inline">\(s\)</span> after <span class="math inline">\(n\)</span> steps?</p>
<p>Before jumping into the general case for the <span class="math inline">\(n\)</span>-th visited step, we’ll start by carefully computing the distribution of the first visited state (i.e., <span class="math inline">\(X_{1}\)</span>). To this end, observe that <span class="math display">\[
\mathbb{P}(X_{1} = s') = \sum_{s}{\mathbb{P}(X_{1} = s' \textrm{ and } X_{0} = s)},
\]</span> where the sum is taken over the entire state space <span class="math inline">\(\{1, 2, \ldots, S\}.\)</span> We can further compute each summand in as the product of atransition probability and an initial probability: <span class="math display">\[
\mathbb{P}(X_{1} = s' \textrm{ and } X_{0} = s) = \mathbb{P}(X_{1} = s' \vert X_{0} = s)\mathbb{P}(X_{0} = s).
\]</span> Since we know <span class="math inline">\(\mathbb{P}(X_{0} = s) \pi_{0,s}\)</span> and <span class="math inline">\(\mathbb{P}(X_{1} = s' \vert X_{0} = s) = p_{s,s'},\)</span> we conclude that <span class="math display">\[
\mathbb{P}(X_{1} = s') = \sum_{s}{\pi_{0,s}p_{s,s'}}
\]</span> If we let if <span class="math inline">\(\boldsymbol{\pi}_{1} = (\pi_{1,1}, \ldots, \pi_{1,S})^{\top}\)</span> where <span class="math inline">\(\pi_{1,s} = \mathbb{P}(X_{1} = s)\)</span> be the probability distribution of <span class="math inline">\(X_{1},\)</span> we can re-write the above equation in matrix form as <span class="math display">\[
\boldsymbol{\pi}_{1}^{\top} = \boldsymbol{\pi}_{0}^{\top}\boldsymbol{\mathbf{P}}
\]</span> Using essentially the same calculation, we conclude that for each <span class="math inline">\(n\)</span>, <span class="math display">\[
\boldsymbol{\pi}_{n}^{\top} = \boldsymbol{\pi}_{n-1}^{\top}\boldsymbol{\mathbf{P}},
\]</span> where <span class="math inline">\(\boldsymbol{\pi}_{n} = (\pi_{n,1}, \ldots, \pi_{n,S})^{\top}\)</span> and <span class="math inline">\(\pi_{n,s} = \mathbb{P}(X_{n} = s).\)</span> Recalling the definition of the <span class="math inline">\(n\)</span>-step transition probability matrix <span class="math inline">\(\boldsymbol{\mathbf{P}}^{(n)}\)</span> from <a href="../lectures/lecture14.html#sec-nstep">Lecture 14</a>, we have <span class="math display">\[
\boldsymbol{\pi}_{n}^{\top} = \boldsymbol{\pi}_{0}^{\top}\boldsymbol{\mathbf{P}}^{n},
\]</span></p>
</section>
<section id="sec-invariant-dist" class="level3">
<h3 class="anchored" data-anchor-id="sec-invariant-dist">Invariant Distributions</h3>
<p>Returning to the 4 team example from <a href="#fig-fourstate-graph" class="quarto-xref">Figure&nbsp;1</a>, suppose that the bandwagon fan choose the initial team to support uniformly at random. The following code computes <span class="math inline">\(\boldsymbol{\pi}_{1}, \ldots, \boldsymbol{\pi}_{10}\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-6"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a>pi0 <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fl">0.25</span>, <span class="at">times =</span> <span class="dv">4</span>)</span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a>state_probs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">10</span>, <span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">c</span>(), teams))</span>
<span id="annotated-cell-6-3"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a>state_probs[<span class="dv">1</span>,] <span class="ot">&lt;-</span> pi0</span>
<span id="annotated-cell-6-4"><a href="#annotated-cell-6-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>){</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1">1</button><span id="annotated-cell-6-5" class="code-annotation-target"><a href="#annotated-cell-6-5" aria-hidden="true" tabindex="-1"></a>  state_probs[i,] <span class="ot">&lt;-</span> state_probs[i<span class="dv">-1</span>,] <span class="sc">%*%</span> P</span>
<span id="annotated-cell-6-6"><a href="#annotated-cell-6-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-6-7"><a href="#annotated-cell-6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(state_probs, <span class="at">digits =</span> <span class="dv">2</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="5" data-code-annotation="1">The <span class="math inline">\(i\)</span>-th row of <code>state_probs</code> holds the entries in the vector <span class="math inline">\(\boldsymbol{\pi}_{i-1}\)</span> (i.e., the distribution of <span class="math inline">\(X_{i-1}\)</span>).</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         W    O    C    M
 [1,] 0.25 0.25 0.25 0.25
 [2,] 0.26 0.52 0.06 0.15
 [3,] 0.32 0.36 0.07 0.25
 [4,] 0.31 0.43 0.07 0.19
 [5,] 0.31 0.41 0.07 0.22
 [6,] 0.31 0.42 0.07 0.21
 [7,] 0.31 0.42 0.07 0.21
 [8,] 0.31 0.42 0.07 0.21
 [9,] 0.31 0.42 0.07 0.21
[10,] 0.31 0.42 0.07 0.21</code></pre>
</div>
</div>
<p>We notice that after about four or five iterations, it appears that the vectors <span class="math inline">\(\boldsymbol{\pi}_{n-1}\)</span> and <span class="math inline">\(\boldsymbol{\pi}_{n}\)</span> are essentially identical. We observe the same phenomenon using a very different initial distribution</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-7"><pre class="sourceCode r code-annotation-code code-with-copy"><code class="sourceCode r"><span id="annotated-cell-7-1"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a>pi0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.9</span>, <span class="fl">0.05</span>, <span class="fl">0.025</span>, <span class="fl">0.025</span>)</span>
<span id="annotated-cell-7-2"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a>state_probs <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="dv">10</span>, <span class="at">ncol =</span> <span class="dv">4</span>, <span class="at">dimnames =</span> <span class="fu">list</span>(<span class="fu">c</span>(), teams))</span>
<span id="annotated-cell-7-3"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a>state_probs[<span class="dv">1</span>,] <span class="ot">&lt;-</span> pi0</span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">10</span>){</span>
<span id="annotated-cell-7-5"><a href="#annotated-cell-7-5" aria-hidden="true" tabindex="-1"></a>  state_probs[i,] <span class="ot">&lt;-</span> state_probs[i<span class="dv">-1</span>,] <span class="sc">%*%</span> P</span>
<span id="annotated-cell-7-6"><a href="#annotated-cell-7-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="annotated-cell-7-7"><a href="#annotated-cell-7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(state_probs, <span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         W    O    C    M
 [1,] 0.90 0.05 0.03 0.03
 [2,] 0.08 0.80 0.05 0.07
 [3,] 0.38 0.19 0.07 0.35
 [4,] 0.29 0.51 0.06 0.13
 [5,] 0.31 0.38 0.07 0.25
 [6,] 0.31 0.42 0.07 0.20
 [7,] 0.30 0.42 0.07 0.21
 [8,] 0.31 0.41 0.07 0.21
 [9,] 0.31 0.42 0.07 0.21
[10,] 0.31 0.42 0.07 0.21</code></pre>
</div>
</div>
<p>It would appear that if every <span class="math inline">\(\boldsymbol{\pi}_{n} \approx (0.31, 0.42, 0.07, 0.21)^{\top},\)</span> then <span class="math inline">\(\boldsymbol{\pi}_{n+1} \approx \boldsymbol{\pi}_{n}.\)</span> In other words, after a while, the uncertainty about what state the Markov chain is in appears to be <em>invariant</em>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Definition: Invariant Distribution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Suppose <span class="math inline">\(\{X_{t}\}\)</span> is a Markov chain over state space <span class="math inline">\(\{1, 2, \ldots, S\}\)</span> with transition probability matrix <span class="math inline">\(\boldsymbol{\mathbf{P}}.\)</span> The probability distribution <span class="math inline">\(\boldsymbol{\pi} = (\pi_{1}, \ldots, \pi_{S})^{\top}\)</span> is <strong>invariant</strong> to <span class="math inline">\(\boldsymbol{\mathbf{P}}\)</span> if <span class="math display">\[
\boldsymbol{\pi}^{\top}\boldsymbol{\mathbf{P}} = \boldsymbol{\pi}.
\]</span> Notice that if <span class="math inline">\(\boldsymbol{\pi}\)</span> is invariant, if the chain is initialized according to <span class="math inline">\(\boldsymbol{\pi}\)</span> then <span class="math inline">\(\mathbb{P}(X_{t} = s) = \pi_{s}\)</span> for all time steps <span class="math inline">\(t.\)</span></p>
</div>
</div>
<p>It turns out that for a broad class of Markov chains — specifically, those that are positive recurrent<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, aperiodic<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, and irreducible<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> — then</p>
<ol type="1">
<li>There is a unique invariant distribution <span class="math inline">\(\boldsymbol{\pi}\)</span> satisfying <span class="math inline">\(\boldsymbol{\pi}^{\top}\boldsymbol{\mathbf{P}} = \boldsymbol{\pi}.\)</span></li>
<li>As <span class="math inline">\(n \rightarrow \infty,\)</span> $_{n} .</li>
</ol>
</section>
<section id="sec-eigenvalue" class="level3">
<h3 class="anchored" data-anchor-id="sec-eigenvalue">Computing Invariant Distributions</h3>
<p>That is, under suitable conditions, the limiting distribution of the states visited by the Markov chain converges to the invariant distribution. This means that in order to determine the long-run frequency of the chain being in state <span class="math inline">\(s,\)</span> we do not actualy have to simulate the Markov chain. Instead, we need find a probability vector <span class="math inline">\(\boldsymbol{\pi}\)</span> such that <span class="math inline">\(\boldsymbol{\pi}^{\top}\boldsymbol{\mathbf{P}} = \boldsymbol{\pi}^{\top}.\)</span> This relation implies that in fact, the invariant probability vector is a <strong>left</strong> eigenvector of the matrix <span class="math inline">\(\boldsymbol{\mathbf{P}}\)</span> with eigenvalue 1. The following code defines a function that return the invariant distribution given a transition matrix <span class="math inline">\(\boldsymbol{\mathbf{P}}.\)</span></p>
<div class="cell">
<details class="code-fold">
<summary>Function to compute leading left eigenvector of transition matrix</summary>
<div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1">1</button><span id="annotated-cell-8-1" class="code-annotation-target"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a>get_invariant <span class="ot">&lt;-</span> <span class="cf">function</span>(P, <span class="at">tol =</span> <span class="fl">1e-12</span>){</span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a>  states <span class="ot">&lt;-</span> <span class="fu">colnames</span>(P)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="2">2</button><span id="annotated-cell-8-3" class="code-annotation-target"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">all</span>( <span class="fu">abs</span>(<span class="fu">rowSums</span>(P) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">&lt;</span> tol) ){</span>
<span id="annotated-cell-8-4"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Rows sums of P are not all 1. P may not be a valid transition matrix"</span>) <span class="co">#&lt;2</span></span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="annotated-cell-8-6"><a href="#annotated-cell-8-6" aria-hidden="true" tabindex="-1"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="3">3</button><span id="annotated-cell-8-7" class="code-annotation-target"><a href="#annotated-cell-8-7" aria-hidden="true" tabindex="-1"></a>  decomp <span class="ot">&lt;-</span> <span class="fu">eigen</span>(<span class="fu">t</span>(P))</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="4">4</button><span id="annotated-cell-8-8" class="code-annotation-target"><a href="#annotated-cell-8-8" aria-hidden="true" tabindex="-1"></a>  pi_raw <span class="ot">&lt;-</span> decomp<span class="sc">$</span>vectors[,<span class="dv">1</span>]</span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-8-10"><a href="#annotated-cell-8-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">all</span>(<span class="fu">Re</span>(pi_raw) <span class="sc">&lt;</span> tol)){</span>
<span id="annotated-cell-8-11"><a href="#annotated-cell-8-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Leading eigenvalue of P appears to be complex and not real-valued"</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="5">5</button><span id="annotated-cell-8-12" class="code-annotation-target"><a href="#annotated-cell-8-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="annotated-cell-8-13"><a href="#annotated-cell-8-13" aria-hidden="true" tabindex="-1"></a>  pi <span class="ot">&lt;-</span> <span class="fu">Re</span>(pi_raw)</span>
<span id="annotated-cell-8-14"><a href="#annotated-cell-8-14" aria-hidden="true" tabindex="-1"></a>  pi <span class="ot">&lt;-</span> pi<span class="sc">/</span><span class="fu">sum</span>(pi)</span>
<span id="annotated-cell-8-15"><a href="#annotated-cell-8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(pi) <span class="ot">&lt;-</span> states</span>
<span id="annotated-cell-8-16"><a href="#annotated-cell-8-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-8-17"><a href="#annotated-cell-8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pi)</span>
<span id="annotated-cell-8-18"><a href="#annotated-cell-8-18" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="1" data-code-annotation="1">When doing linear algebra in R, it’s helpful to work up to some degree of numerical precision. For most of our calculations, it’ll be enough to use <code>1e-12</code> or <code>1e-9</code></span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="3,5" data-code-annotation="2">Transition matrices have row sums of 1. This checks that the row sums of the provided matrix <code>P</code> are sufficiently close to 1. If they are not, the function throws an error</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="7" data-code-annotation="3">By default <code>eigen()</code> returns right eigenvectors. The left eigenvectors of a matrix <span class="math inline">\(M\)</span> are the right eigenvector of its transpose <span class="math inline">\(M^{\top}\)</span></span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="8" data-code-annotation="4"><code>eigen()</code> scales eigenvectors to have squared norm 1 and not a sum of 1. We need to re-scale this vector.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="12" data-code-annotation="5">Generally speaking, the eigenvalues and eigenvectors of a transition matrix are complex-valued and not real-valued. For a Markov chain with a limiting, invariant distribution the leading eigenvector should only have real values. This code checks that the imaginary parts are 0 (or at least smaller than than our small tolerance <code>tol</code>)</span>
</dd>
</dl>
</div>
</div>
<p>As an illustration, in the code below we first compute the invariant distribution for our 4-team Markov chain. Then, we look at the different <span class="math inline">\(\boldsymbol{\pi}^{\top} - \boldsymbol{\pi}^{\top}\boldsymbol{\mathbf{P}}.\)</span> We find that that differences are all of the other <span class="math inline">\(10^{-16},\)</span> which for our purposes are small enough to be considered zero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>pi <span class="ot">&lt;-</span> <span class="fu">get_invariant</span>(P)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"pi:"</span>, <span class="fu">round</span>(pi, <span class="at">digits =</span> <span class="dv">6</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>pi: 0.307308 0.415808 0.065675 0.211208 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"pi %*% P:"</span>, <span class="fu">round</span>(pi <span class="sc">%*%</span> P, <span class="at">digits =</span> <span class="dv">6</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>pi %*% P: 0.307308 0.415808 0.065675 0.211208 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Difference: "</span>, pi <span class="sc">-</span> pi <span class="sc">%*%</span> P, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Difference:  -5.551115e-17 -2.220446e-16 1.387779e-17 2.220446e-16 </code></pre>
</div>
</div>
<p>If we interpret the bandwagon fans’ transitions from team <span class="math inline">\(s\)</span> to <span class="math inline">\(s'\)</span> to signify that team is <span class="math inline">\(s'\)</span> is, in some sense, better than <span class="math inline">\(s,\)</span> then we can rank teams by the amount of time the fan spends support thing. In our 4-team example, the bandwagon fan supports:</p>
<ul>
<li><code>W</code> about 30% of the time</li>
<li><code>O</code> about 42% of the time</li>
<li><code>C</code> about 7% of the time</li>
<li><code>M</code> about 21% of the time.</li>
</ul>
<p>So, we would obtain the ranking <code>O</code>, <code>W</code>, <code>M,</code> and <code>C</code> based on this specific Markov chain.</p>
</section>
</section>
<section id="sec-mc-ranking" class="level2">
<h2 class="anchored" data-anchor-id="sec-mc-ranking">Markov chain-based Rankings</h2>
<p>We’re now in a position to apply this general procedure to our D1 hockey data. The main steps involve:</p>
<ol type="1">
<li>Construct a Markov chain model describing how a bandwagon fan could randomly switch their support from team to team</li>
<li>Compute the invariant distribution of the Markov chain</li>
</ol>
<p>There are <strong>many</strong> ways to carry out the first step and there is no objective or normative <em>best</em> way to do so. By convention, we usually set up the Markov chain model so that <span class="math inline">\(p_{s,s'}\)</span>, the probability that the fan switches their support from <span class="math inline">\(s\)</span> to <span class="math inline">\(s'\)</span>, quantifies how much better <span class="math inline">\(s'\)</span> is than <span class="math inline">\(s.\)</span> Most often, <span class="math inline">\(p_{s,s'}\)</span> is selected to depend on the number of times <span class="math inline">\(s'\)</span> beats <span class="math inline">\(s\)</span> and/or the number of points <span class="math inline">\(s'\)</span> scores against <span class="math inline">\(s.\)</span></p>
<p>Before proceeding, we will load in the data table constructed in <a href="../lectures/lecture12.html">Lecture 12</a> containing match-by-match results from the 2024-25 D1 Women’s Ice Hockey Season</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-12"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-12-1"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"wd1hockey_regseason_2024_2025.RData"</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="1">1</button><span id="annotated-cell-12-2" class="code-annotation-target"><a href="#annotated-cell-12-2" aria-hidden="true" tabindex="-1"></a>teams <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(<span class="fu">c</span>(no_ties<span class="sc">$</span>Home, no_ties<span class="sc">$</span>Opponent)))</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="2">2</button><span id="annotated-cell-12-3" class="code-annotation-target"><a href="#annotated-cell-12-3" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">length</span>(teams)</span>
<span id="annotated-cell-12-4"><a href="#annotated-cell-12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-12-5"><a href="#annotated-cell-12-5" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="3">3</button><span id="annotated-cell-12-6" class="code-annotation-target"><a href="#annotated-cell-12-6" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span></span>
<span id="annotated-cell-12-7"><a href="#annotated-cell-12-7" aria-hidden="true" tabindex="-1"></a>  no_ties <span class="sc">|&gt;</span></span>
<span id="annotated-cell-12-8"><a href="#annotated-cell-12-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(</span>
<span id="annotated-cell-12-9"><a href="#annotated-cell-12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">home.team =</span> Home, <span class="at">home.score =</span> HomeScore,<span class="at">home.winner =</span> Home_Winner,</span>
<span id="annotated-cell-12-10"><a href="#annotated-cell-12-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">away.team =</span> Opponent, <span class="at">away.score =</span> OppScore, <span class="at">away.winner =</span> Opp_Winner) <span class="sc">|&gt;</span></span>
<span id="annotated-cell-12-11"><a href="#annotated-cell-12-11" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(home.team, away.team, home.winner, away.winner, home.score, away.score)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="2" data-code-annotation="1">Vector containing the list of all teams</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="3" data-code-annotation="2">Number of teams</span>
</dd>
<dt data-target-cell="annotated-cell-12" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="6,7,8,9,10,11" data-code-annotation="3">Rename columns in original table and extract home and away team identities, scores, and indicators for winning</span>
</dd>
</dl>
</div>
</div>
<section id="damping" class="level3">
<h3 class="anchored" data-anchor-id="damping">Damping</h3>
<p>Suppose that our bandwagon fan currently supports team <span class="math inline">\(s\)</span> and must now (randomly) select another team <span class="math inline">\(s'\)</span> to support. Since we’d like for our fan to more often move to “better” teams, it makes sense to send the fan from <span class="math inline">\(s\)</span> to <span class="math inline">\(s'\)</span> than to another team <span class="math inline">\(t\)</span> if more frequently if <span class="math inline">\(s'\)</span> has beaten <span class="math inline">\(s\)</span> more often than <span class="math inline">\(t\)</span> has beaten <span class="math inline">\(s.\)</span> To formalize this intuition, we begin by creating a matrix <span class="math inline">\(\boldsymbol{\mathbf{V}}\)</span> whose <span class="math inline">\((s,s')\)</span> element <span class="math inline">\(v_{s,s'}\)</span> counts the number of times <span class="math inline">\(s'\)</span> beats <span class="math inline">\(s.\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-13"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="1">1</button><span id="annotated-cell-13-1" class="code-annotation-target"><a href="#annotated-cell-13-1" aria-hidden="true" tabindex="-1"></a>V <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> S, <span class="at">ncol =</span> S, <span class="at">dimnames =</span> <span class="fu">list</span>(teams, teams))</span>
<span id="annotated-cell-13-2"><a href="#annotated-cell-13-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(results)){</span>
<span id="annotated-cell-13-3"><a href="#annotated-cell-13-3" aria-hidden="true" tabindex="-1"></a>  home <span class="ot">&lt;-</span> results<span class="sc">$</span>home.team[i]</span>
<span id="annotated-cell-13-4"><a href="#annotated-cell-13-4" aria-hidden="true" tabindex="-1"></a>  away <span class="ot">&lt;-</span> results<span class="sc">$</span>away.team[i]</span>
<span id="annotated-cell-13-5"><a href="#annotated-cell-13-5" aria-hidden="true" tabindex="-1"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="2">2</button><span id="annotated-cell-13-6" class="code-annotation-target"><a href="#annotated-cell-13-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(results<span class="sc">$</span>home.winner[i] <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="annotated-cell-13-7"><a href="#annotated-cell-13-7" aria-hidden="true" tabindex="-1"></a>    V[away,home] <span class="ot">&lt;-</span> V[away,home] <span class="sc">+</span> <span class="dv">1</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="3">3</button><span id="annotated-cell-13-8" class="code-annotation-target"><a href="#annotated-cell-13-8" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(results<span class="sc">$</span>away.winner[i] <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="annotated-cell-13-9"><a href="#annotated-cell-13-9" aria-hidden="true" tabindex="-1"></a>    V[home,away] <span class="ot">&lt;-</span> V[home,away] <span class="sc">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-13-10"><a href="#annotated-cell-13-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-13" data-target-annotation="4">4</button><span id="annotated-cell-13-11" class="code-annotation-target"><a href="#annotated-cell-13-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Problem with game"</span>, i, <span class="st">": neither team won"</span>)</span>
<span id="annotated-cell-13-12"><a href="#annotated-cell-13-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="annotated-cell-13-13"><a href="#annotated-cell-13-13" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-13" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="1" data-code-annotation="1">Initialize <span class="math inline">\(\boldsymbol{\mathbf{V}}\)</span> to have all zero entries</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="6,7" data-code-annotation="2">The <code>V[away,home]</code> counts how many times <code>home</code> beat <code>away</code>. So, every time the home team wins a game, we must increment <code>V[away,home]</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="8,9" data-code-annotation="3">The <code>V[home,away]</code> counts how many times <code>away</code> beat <code>home</code>. So, every time the away team wins a game, we must increment <code>V[home,away]</code>.</span>
</dd>
<dt data-target-cell="annotated-cell-13" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-13" data-code-lines="11" data-code-annotation="4">This condition should never be reached, since we removed ties from the data back in <a href="../lectures/lecture12.html">Lecture 12</a></span>
</dd>
</dl>
</div>
</div>
<p>Each row of a transition probability matrices must sum to 1<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. In its present form, <span class="math inline">\(\boldsymbol{\mathbf{V}}\)</span> does not satisfy this property: in fact, the row and columns sums of <span class="math inline">\(\boldsymbol{\mathbf{V}}\)</span> respectively count the number of losses and wins for each team. To turn <span class="math inline">\(\boldsymbol{\mathbf{V}}\)</span> into a valid transition probability matrix, we need to normalize the <strong>rows</strong>.</p>
<p>Mathematically, let <span class="math inline">\(\mathbf{\boldsymbol{A}}\)</span> be the <span class="math inline">\(S \times S\)</span> diagonal matrix whose <span class="math inline">\((s,s')\)</span> entry is zero for all <span class="math inline">\(s \neq s\)</span> and whose <span class="math inline">\((s,s)\)</span> entry, <span class="math inline">\(a_{s,s}\)</span>, is sum of the elements along the <span class="math inline">\(s\)</span>-th row of <span class="math inline">\(\boldsymbol{\mathbf{V}}\)</span>: <span class="math display">\[a_{s,s} = \sum_{s'}{v_{s,s'}}\]</span> Then, the matrix <span class="math inline">\(\boldsymbol{\mathbf{W}} = \boldsymbol{\mathbf{A}}^{-1}\boldsymbol{\mathbf{V}}\)</span> is the row-normalized version of <span class="math inline">\(\boldsymbol{\mathbf{V}}.\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-14"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-14-1"><a href="#annotated-cell-14-1" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(V)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="1">1</button><span id="annotated-cell-14-2" class="code-annotation-target"><a href="#annotated-cell-14-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">any</span>(r <span class="sc">==</span> <span class="dv">0</span>)) r[r<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="2">2</button><span id="annotated-cell-14-3" class="code-annotation-target"><a href="#annotated-cell-14-3" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="at">x =</span> r)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-14" data-target-annotation="3">3</button><span id="annotated-cell-14-4" class="code-annotation-target"><a href="#annotated-cell-14-4" aria-hidden="true" tabindex="-1"></a>W <span class="ot">&lt;-</span> <span class="fu">solve</span>(A) <span class="sc">%*%</span> V</span>
<span id="annotated-cell-14-5"><a href="#annotated-cell-14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dimnames</span>(W) <span class="ot">&lt;-</span> <span class="fu">dimnames</span>(V)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-14" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="2" data-code-annotation="1">If any rows of <code>V</code> have a sum of zero (e.g., for an undefeated team), we will set the corresponding element of <code>A</code> to be 1 so that the corresponding row of <code>W</code> contains only zeros.</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="3" data-code-annotation="2"><code>diag()</code> creates a diagonal matrix with diagonal entries given by</span>
</dd>
<dt data-target-cell="annotated-cell-14" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-14" data-code-lines="4" data-code-annotation="3"><code>solve()</code> returns the inverse of a matrix.</span>
</dd>
</dl>
</div>
</div>
<p>Since the rows of <span class="math inline">\(\boldsymbol{\mathbf{W}}\)</span> sum to one, it is tempting to use it as the transition matrix for our Markov chain. There are a few issues with that, however. To illustrate them, we first look at the rows and columns of <span class="math inline">\(\boldsymbol{\mathbf{W}}\)</span> corresponding to the teams who qualified for the 2024-25 Frozen 4</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>W[<span class="fu">c</span>(<span class="st">"Wisconsin"</span>, <span class="st">"Ohio State"</span>, <span class="st">"Cornell"</span>, <span class="st">"Minnesota"</span>), <span class="fu">c</span>(<span class="st">"Wisconsin"</span>, <span class="st">"Ohio State"</span>, <span class="st">"Cornell"</span>, <span class="st">"Minnesota"</span>)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Wisconsin Ohio State Cornell Minnesota
Wisconsin  0.0000000       1.00       0      0.00
Ohio State 0.2500000       0.00       0      0.25
Cornell    0.0000000       0.20       0      0.00
Minnesota  0.4166667       0.25       0      0.00</code></pre>
</div>
</div>
<p>If we simulated a Markov chain using transitions in <span class="math inline">\(\boldsymbol{\mathbf{W}},\)</span> then the chain would <strong>always</strong> move from Wisconsin to Ohio State (since Ohio State was the only team to beat Wisconsin last season). While this is subjectively bad, the more serious issue is that it turns out the Markov chain so defined is not necessarily aperiodic, positive recurrent, and irreducible. So, it may not always have A somewhat less abstract issue is that all diagonal elements of <span class="math inline">\(\boldsymbol{\mathbf{W}}\)</span> are zero. This means that the bandwagon fan who switches their support sequentially according to <span class="math inline">\(\boldsybmol{\mathbf{W}}\)</span> never has the option to stick with the same team across multiple rounds.</p>
<p>To overcome this issue, it is common to introduce a <em>damping</em> factor as follows. First, one fixes a number <span class="math inline">\(0 &lt; \beta &lt; 1\)</span> (e.g., <span class="math inline">\(\beta = 0.5\)</span> or <span class="math inline">\(\beta = 0.85\)</span>) and then creates a transition matrix <span class="math display">\[
\boldsymbol{\mathbf{P}} = \beta \times \boldsymbol{\mathbf{W}} + \frac{(1 - \beta)}{S} \times \mathbf{\boldsymbol{1}}_{S}^{\top}\mathbf{\boldsymbol{1}}_{S}
\]</span> by</p>
<ol type="1">
<li>Scaling all the elements of <span class="math inline">\(\boldsymbol{\mathbf{W}}\)</span> by <span class="math inline">\(\beta\)</span></li>
<li>Adding <span class="math inline">\((1-\beta)/S\)</span> to every element of the re-scaled matrix (both off-diagonal and diagonal elements)</li>
</ol>
<p>Doing so ensures that the matrix is irreducible, aperiodic, and positive recurrent, which means that <span class="math inline">\(\boldsymbol{\mathbf{P}}\)</span> has a unique limiting, invariant distribution. So, if we simulate a bandwagon fan switching their support between teams according to <span class="math inline">\(\boldsymbol{\mathbf{P}},\)</span> we can derive a rank ordering of teams from the long-run proportion of time they spend supporting each team.</p>
<p>In the following code, we define a function that takes a matrix <span class="math inline">\(\boldsymbol{\mathbf{V}}\)</span> and damping factor <span class="math inline">\(\beta\)</span> and outputs the resulting transition matrix <span class="math inline">\(\boldsymbol{\mathbf{P}}.\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>get_dampened_transition <span class="ot">&lt;-</span> <span class="cf">function</span>(V, beta){</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  states <span class="ot">&lt;-</span> <span class="fu">rownames</span>(V)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  n_states <span class="ot">&lt;-</span> <span class="fu">nrow</span>(V)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(V)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">any</span>(r <span class="sc">==</span> <span class="dv">0</span>)) r[r<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> <span class="fu">diag</span>(r)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  W <span class="ot">&lt;-</span> <span class="fu">solve</span>(A) <span class="sc">%*%</span> V</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  P <span class="ot">&lt;-</span> beta <span class="sc">*</span> W <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>beta)<span class="sc">/</span>n_states</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dimnames</span>(P) <span class="ot">&lt;-</span> <span class="fu">dimnames</span>(V)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(P)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Simulating the random walk behavior of our bandwagon fan beginning at Wisconsin, we find that the fan spends about 11% of the time supporting Ohio State, 8% of the time supporting Wisconsin, and 6% of the time supporting Minnesota.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> <span class="fu">get_dampened_transition</span>(V, <span class="at">beta =</span> <span class="fl">0.85</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>sim1 <span class="ot">&lt;-</span> <span class="fu">fan_walk</span>(<span class="at">init_state =</span> <span class="st">"Wisconsin"</span>, <span class="at">n_iter =</span> <span class="fl">1e6</span>, <span class="at">P =</span> P)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">sort</span>(sim1, <span class="at">decreasing =</span> <span class="cn">TRUE</span>), <span class="at">digits =</span> <span class="dv">3</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>states_visited
      Ohio State        Wisconsin        Minnesota Minnesota Duluth 
           0.114            0.080            0.059            0.046 
         Cornell          Colgate     Northeastern  St. Cloud State 
           0.040            0.039            0.032            0.031 
    St. Lawrence       Penn State 
           0.028            0.026 </code></pre>
</div>
</div>
<p>Reassuringly, these long-run frequency estimates are very close to the invariant distribution of <span class="math inline">\(\boldsymbol{\mathbf{P}}\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>pi <span class="ot">&lt;-</span> <span class="fu">get_invariant</span>(P)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">sort</span>(pi, <span class="at">decreasing =</span> <span class="cn">TRUE</span>), <span class="at">digits =</span> <span class="dv">3</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Ohio State        Wisconsin        Minnesota Minnesota Duluth 
           0.115            0.080            0.059            0.046 
         Cornell          Colgate     Northeastern  St. Cloud State 
           0.040            0.039            0.032            0.032 
    St. Lawrence      Connecticut 
           0.028            0.026 </code></pre>
</div>
</div>
</section>
<section id="score-based-markov-chain-rankings" class="level3">
<h3 class="anchored" data-anchor-id="score-based-markov-chain-rankings">Score-based Markov Chain Rankings</h3>
<p>Based on the particular model of bandwagon fan behavior from the previous section, we obtain a power ranking in which Ohio State is first and Wisconsin is second. This is despite the fact that (i) Wisconsin beat most of its opponents in the 2024-25 regular season and (ii) Wisconsin won more games than Ohio State. Remember, we constructed the Markov chain so that the fan would move from team <span class="math inline">\(s\)</span> to team <span class="math inline">\(s'\)</span> more often the more times <span class="math inline">\(s'\)</span> beat <span class="math inline">\(s.\)</span> Since Wisconsin only lost to Ohio State and to nobody else, our Markov chain model specifies a rather large transition probability from Wisconsin to Ohio State.</p>
<p>Another, somewhat less subjective objection to the model, lies in the fact that transitions only depend on match results and not on the scoring margin or the number of goals scored. As a refinement, let’s try to build a different <span class="math inline">\(\boldsymbol{\mathbf{V}}\)</span> that takes scoring into account. Specifically, we will set <span class="math inline">\(v_{s,s'}\)</span> equal to the total number of points scored by <span class="math inline">\(s'\)</span> when it plays <span class="math inline">\(s.\)</span> In our hockey context, the row and column sums of this new <span class="math inline">\(\boldsymbol{\mathbf{V}}\)</span> are, respectively, the number of goals conceded and number of goals scored by each team.</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-19"><pre class="sourceCode r code-annotation-code code-with-copy code-annotated"><code class="sourceCode r"><button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="1">1</button><span id="annotated-cell-19-1" class="code-annotation-target"><a href="#annotated-cell-19-1" aria-hidden="true" tabindex="-1"></a>V_score <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> S, <span class="at">ncol =</span> S, <span class="at">dimnames =</span> <span class="fu">list</span>(teams, teams))</span>
<span id="annotated-cell-19-2"><a href="#annotated-cell-19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(results)){</span>
<span id="annotated-cell-19-3"><a href="#annotated-cell-19-3" aria-hidden="true" tabindex="-1"></a>  home <span class="ot">&lt;-</span> results<span class="sc">$</span>home.team[i]</span>
<span id="annotated-cell-19-4"><a href="#annotated-cell-19-4" aria-hidden="true" tabindex="-1"></a>  away <span class="ot">&lt;-</span> results<span class="sc">$</span>away.team[i]</span>
<span id="annotated-cell-19-5"><a href="#annotated-cell-19-5" aria-hidden="true" tabindex="-1"></a>  </span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="2">2</button><span id="annotated-cell-19-6" class="code-annotation-target"><a href="#annotated-cell-19-6" aria-hidden="true" tabindex="-1"></a>  V_score[away, home] <span class="ot">&lt;-</span> V_score[away,home] <span class="sc">+</span> results<span class="sc">$</span>home.score[i]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-19" data-target-annotation="3">3</button><span id="annotated-cell-19-7" class="code-annotation-target"><a href="#annotated-cell-19-7" aria-hidden="true" tabindex="-1"></a>  V_score[home,away] <span class="ot">&lt;-</span> V_score[home,away] <span class="sc">+</span> results<span class="sc">$</span>away.score[i]</span>
<span id="annotated-cell-19-8"><a href="#annotated-cell-19-8" aria-hidden="true" tabindex="-1"></a>}</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-19" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="1,2" data-code-annotation="1">Re-initialize <code>V</code> to have all entries equal to 0</span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="6" data-code-annotation="2">Add the number of goals scored by the home team when playing the away team to <code>V[away,home]</code></span>
</dd>
<dt data-target-cell="annotated-cell-19" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-19" data-code-lines="7" data-code-annotation="3">Add the number of goals scored by the away team when playing the home team to <code>V[home,away]</code>.</span>
</dd>
</dl>
</div>
</div>
<p>We now convert our score-based <span class="math inline">\(\boldsymbol{\mathbf{V}}\)</span> into a dampened transition matrix with <span class="math inline">\(\beta = 0.8\)</span> and then compute the resulting invariant distribution. Now, it appears that Wisconsin is at the top of the power rankings, closely followed by Minnesota and Ohio State.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>P_score <span class="ot">&lt;-</span> <span class="fu">get_dampened_transition</span>(V_score, <span class="at">beta =</span> <span class="fl">0.8</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>pi_score <span class="ot">&lt;-</span> <span class="fu">get_invariant</span>(P_score)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">sort</span>(pi_score, <span class="at">decreasing =</span> <span class="cn">TRUE</span>), <span class="at">digits =</span> <span class="dv">3</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       Wisconsin        Minnesota       Ohio State          Colgate 
           0.053            0.048            0.045            0.039 
         Cornell Minnesota Duluth  Minnesota State         Clarkson 
           0.034            0.033            0.030            0.029 
    St. Lawrence        Princeton 
           0.029            0.028 </code></pre>
</div>
</div>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>A chain is said to be positive recurrent if for all states <span class="math inline">\(s,\)</span> a chain begun in <span class="math inline">\(s\)</span> is guaranteed to return to <span class="math inline">\(s\)</span> in a <strong>finite</strong> number of steps with probability 1. A sufficient (but not necessary) condition is for <span class="math inline">\(p_{s,s} &gt; 0\)</span> for all states <span class="math inline">\(s.\)</span><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The <em>period</em> of state <span class="math inline">\(s\)</span> is the greatest common divisor of all <span class="math inline">\(n\)</span> such that <span class="math inline">\((\boldsymbol{P}^{n})_{s,s} &gt; 0.\)</span> If state <span class="math inline">\(s\)</span> has period <span class="math inline">\(d,\)</span> this means that the chain has non-zero probability of returning to <span class="math inline">\(s\)</span> every <span class="math inline">\(d\)</span> steps. An <strong>aperiodic</strong> chain is one in which the period of every state is 1. That is, in an aperiodic chain, there is always a chance of returning to the same state in one step.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Informally, irreducible Markov chains are those in which there is a any state <span class="math inline">\(s'\)</span> can be reached from any other state in a <strong>finite</strong> number of steps. A sufficient (but not necessary) condition is that <span class="math inline">\(p_{s,s'} &gt; 0\)</span> for all pairs of state <span class="math inline">\(s\)</span> and <span class="math inline">\(s'\)</span><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Remember, the <span class="math inline">\(s\)</span>-th row of <span class="math inline">\(\boldsymbol{\mathbf{P}}\)</span> specifies a distribution of the state the Markov chain visits immediately being in state <span class="math inline">\(s.\)</span> Since the chain must move (or remain in <span class="math inline">\(S\)</span>), the sum of the probabilities along the rows has to be 1.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>