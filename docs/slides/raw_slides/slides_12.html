<!DOCTYPE html>
<html lang="en"><head>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/tabby.min.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.7.32">

  <title>STAT479 – STAT 479 Lecture 12</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/theme/quarto-9a1a2c3d5c7ea7f04258c8f180195b78.css">
  <link href="../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">STAT 479 Lecture 12</h1>
  <p class="subtitle">Bradley-Terry Models I</p>

<div class="quarto-title-authors">
</div>

</section>
<section>
<section id="motivation" class="title-slide slide level1 center">
<h1>Motivation</h1>

</section>
<section id="ncaa-d1-womens-hockey-2024-25" class="slide level2 smaller">
<h2>NCAA D1 Women’s Hockey (2024-25)</h2>
<ul>
<li>WIS went 38-1-2 &amp; won the National Championship</li>
<li>OSU went 29-8-0 &amp; lost against WIS</li>
<li>Head-to-Head: 2-1-1</li>
</ul>
<div class="fragment">
<ul>
<li>How much better was WIS than OSU?</li>
</ul>
</div>
<div class="fragment">
<p><span class="math display">\[
\mathbb{P}(\textrm{WIS beats OSU}) = \textrm{???}
\]</span></p>
<!--
# Match Result Data

## Raw Data{.smaller}

- Results from all D1 hockey games from www.uscho.org

- Simple but not scalable: copy & paste directly into spreadsheet

## HTML Basics I {.smaller}

- Most websites content specified in **H**yper**T**ext **M**arkup **L**anguage
- Hierarchical structure involving 
  - Elements: delimited by starting and ending tags (e.g. `<tag>` and `</tag>`)
  - Content: everything between tags
  - Attributes: optional, specified inside tag brackets `<` and `>`

```
<html>
<head>
  <title>Page title</title>
</head>
<body>
  <h1 id='first'>A heading</h1>
  <p>Some text &amp; <b>some bold text.</b></p>
  <img src='myimg.png' width='100' height='100'>
</body>
```

- We generally want to extract contents 
- `id` & `class` attributes used by **C**ascading **S**tyle **S**heets (CSS) to control visual appearance

## HTML Basics II {.smaller}

- Common HTML elements include
  - `<head>`: machine-readable meta-data like title, style sheet specification, etc.
  - `<body>`: main content (only one per document)
  - Section headings: `<h1>` (highest), `<h2>`, ... `<h6>` (lowest)
  - Lists (`<ol>` & `<ul>`) and list elements (`<li>`)
  - `<p>`: paragraph, often (but not always) for blocks of text
  - In-line tags affecting formatting: `<i>` (italics) `<b>` (bold)
  
- See [MDN Web Docs](https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements) for large list

## Reading HTML w/ **rvest** {.smaller}

- **rvest**: R package for scraping data from websites
- Basic function `read_html`

::: {.cell}

```{.r .cell-code}
html <- rvest::read_html("https://skdeshpande91.github.io/stat479_fall2025/lectures/lecture12.html")
html
```

::: {.cell-output .cell-output-stdout}

```
{html_document}
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
[1] <head>\n<meta http-equiv="Content-Type" content="text/html; charset=UTF-8 ...
[2] <body class="nav-sidebar docked nav-fixed quarto-light">\n\n<div id="quar ...
```


:::
:::






## CSS Selectors

- CSS help define the visual styling of HTML documents
- Define patterns for locating HTML elements w/in document
- This property makes them especially useful for scraping

- `html_elements()`: selects all HTML elements matching a particular CSS selector

:::{.panel-tabset}

## Level 1 Headings

::: {.cell}

```{.r .cell-code}
html |> rvest::html_elements(css = "h1")
```

::: {.cell-output .cell-output-stdout}

```
{xml_nodeset (1)}
[1] <h1 class="title">Lecture 12: Bradley-Terry Models</h1>
```


:::
:::


## Level 2 Headings

::: {.cell}

```{.r .cell-code}
html |> rvest::html_elements(css = "h2")
```

::: {.cell-output .cell-output-stdout}

```
{xml_nodeset (7)}
[1] <h2 id="toc-title">On this page</h2>
[2] <h2 class="anchored" data-anchor-id="motivation-the-2025-ncaa-womens-ice- ...
[3] <h2 class="anchored" data-anchor-id="sec-bt-def">The Bradley-Terry Model< ...
[4] <h2 class="anchored" data-anchor-id="sec-scraping">Scraping D1 Women’s Ho ...
[5] <h2 class="anchored" data-anchor-id="sec-bt-est">Fitting Bradley-Terry Mo ...
[6] <h2 class="anchored" data-anchor-id="looking-ahead">Looking Ahead</h2>
[7] <h2 class="anchored quarto-appendix-heading">Footnotes</h2>
```


:::
:::

:::

## Paragraphs

::: {.cell}

```{.r .cell-code}
html |> rvest::html_elements(css = "p")
```

::: {.cell-output .cell-output-stdout}

```
{xml_nodeset (58)}
 [1] <p>The Wisconsin Badgers defeated the Ohio State Buckeyes women in the c ...
 [2] <p>To motivate our developments, let’s consider two slightly different — ...
 [3] <p>To answer these questions, we introduce a model for estimating latent ...
 [4] <p>Suppose we observe the outcome of <span class="math inline">\\(n\\)</ ...
 [5] <p>Consider a round-robin tournament between 4 teams (numbered 1, 2, 3,  ...
 [6] <p>Manually computing the probability that each team beats every other t ...
 [7] <p>Once we have these differences, which are on the log-odds scale, we c ...
 [8] <p>Armed with the probabilities of each team beating every other team, w ...
 [9] <p>We can also compute the probability that Team 2 wins exactly 2 of its ...
[10] <p>In our 4-team round-robin tournament, what is the probability that Te ...
[11] <p>A much more elegant solution is to estimate this probability via simu ...
[12] <p>To perform this simulation, we begin by enumerating each pair of team ...
[13] <p>The function <code>combn()</code> returns an array with two rows (one ...
[14] <p>Since match outcomes are binary, simulating the outcomes of the 6 mat ...
[15] <p>The first three entries in <code>outcomes</code> correspond to the ga ...
[16] <p>To tabulate each teams’ wins, we create a temporary data frame contai ...
[17] <p>We can now repeat this simulation many times, each time recording the ...
[18] <p>Out of the 5000 simulations, Team 1 won all 3 of its games in 1534 si ...
[19] <p>To estimate the probability that Team 3 finishes in the top-2, we wil ...
[20] <p>We compute the team rankings for each simulation replication using th ...
...
```


:::
:::


## Selector Gadget

- For more complex selections, [Selector Gadget](https://rvest.tidyverse.org/articles/selectorgadget.html) is really helpful
  - Interactive way to determine the appropriate CSS selector
  - Save it to your Bookmarks
  
-->
</div>
</section></section>
<section>
<section id="bradley-terry-models" class="title-slide slide level1 center">
<h1>Bradley-Terry Models</h1>

</section>
<section id="the-basic-model" class="slide level2">
<h2>The Basic Model</h2>
<ul>
<li><p>Suppose there are <span class="math inline">\(n\)</span> games played between <span class="math inline">\(p\)</span> teams</p></li>
<li><p>For each team <span class="math inline">\(j\)</span>, there is a <strong>latent</strong> strength <span class="math inline">\(\lambda_{j}\)</span> <span class="math display">\[
\mathbb{P}(\textrm{team i beats team j}) = \frac{e^{\lambda_{i}}}{e^{\lambda_{i}} + e^{\lambda_{j}}} = \frac{1}{1 + e^{-1 \times (\lambda_{i} - \lambda_{j})}}
\]</span></p></li>
<li><p>Log-odds of <span class="math inline">\(i\)</span> beating <span class="math inline">\(j\)</span>: <span class="math inline">\(\lambda_{i} - \lambda_{j}.\)</span></p></li>
</ul>
</section>
<section id="example-4-team-round-robin" class="slide level2">
<h2>Example: 4 Team Round-Robin</h2>
<ul>
<li>Suppose <span class="math inline">\(\lambda_{1} = 1, \lambda_{2} = 0.5, \lambda_{3} = 0.3\)</span> and <span class="math inline">\(\lambda_{4} = 0.\)</span> <span class="math display">\[
\mathbb{P}(\textrm{team 1 beats team 2}) = \frac{e^{1}}{e^{1} + e^{0.5}} \approx 62\%
\]</span></li>
</ul>
<div class="panel-tabset">
<ul id="tabset-1" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-1-1">Single Prob.</a></li><li><a href="#tabset-1-2"><code>outer</code></a></li><li><a href="#tabset-1-3">Pairwise Probs.</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1">
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-6"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy"><code class="sourceCode r"><span id="annotated-cell-6-1"><a href="#annotated-cell-6-1"></a>lambda <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="dv">0</span>)</span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2"></a><span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> (lambda[<span class="dv">1</span>] <span class="sc">-</span> lambda[<span class="dv">2</span>])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.6224593</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2">
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy"><code class="sourceCode r"><span id="annotated-cell-8-1"><a href="#annotated-cell-8-1"></a><span class="fu">outer</span>(<span class="at">X =</span> lambda, <span class="at">Y =</span> lambda, <span class="at">FUN =</span> <span class="st">"-"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3] [,4]
[1,]  0.0  0.5  0.7  1.0
[2,] -0.5  0.0  0.2  0.5
[3,] -0.7 -0.2  0.0  0.3
[4,] -1.0 -0.5 -0.3  0.0</code></pre>
</div>
</div>
</div>
<div id="tabset-1-3">
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a></a>probs <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> <span class="fu">outer</span>(<span class="at">X =</span> lambda, <span class="at">Y =</span> lambda, <span class="at">FUN =</span> <span class="st">"-"</span>)))</span>
<span id="cb3-2"><a></a><span class="fu">diag</span>(probs) <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb3-3"><a></a><span class="fu">round</span>(probs, <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]  [,2]  [,3]  [,4]
[1,]    NA 0.622 0.668 0.731
[2,] 0.378    NA 0.550 0.622
[3,] 0.332 0.450    NA 0.574
[4,] 0.269 0.378 0.426    NA</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="example-tournament-simulation-i" class="slide level2 smaller">
<h2>Example: Tournament Simulation I</h2>
<ul>
<li><p>Consider tournament w/ 4 teams and <span class="math inline">\(\lambda_{1} = 1, \lambda_{2} = 0.5, \lambda_{3} = 0.3\)</span> and <span class="math inline">\(\lambda_{4} = 0.\)</span></p></li>
<li><p>What is prob. that Team 3 finishes in top-2 in terms of wins?</p></li>
<li><p>Enumerate all pairwise probabilities</p></li>
</ul>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  player1 player2  prob
    &lt;int&gt;   &lt;int&gt; &lt;dbl&gt;
1       1       2 0.622
2       1       3 0.668
3       1       4 0.731
4       2       3 0.550
5       2       4 0.622
6       3       4 0.574</code></pre>
</div>
</div>
</section>
<section id="example-tournament-simulation-ii" class="slide level2 smaller">
<h2>Example: Tournament Simulation II</h2>
<ul>
<li>Flip 6 coins, one per match
<ul>
<li>Heads: <code>player1</code> wins; Tails: <code>player2</code> wins</li>
</ul></li>
<li><code>rbinom(n, size, prob)</code>: simulate from a <strong>Binomial</strong> distribution</li>
<li>Coin flips are special case with <code>size = 1</code>
<ul>
<li><code>n</code>: number of coins to flip</li>
<li><code>prob</code>: prob. of each coin landing heads</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a></a><span class="fu">set.seed</span>(<span class="dv">479</span>)</span>
<span id="cb6-2"><a></a>outcomes <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">6</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> design<span class="sc">$</span>prob)</span>
<span id="cb6-3"><a></a><span class="fu">cbind</span>(design, outcomes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  player1 player2      prob outcomes
1       1       2 0.6224593        0
2       1       3 0.6681878        1
3       1       4 0.7310586        1
4       2       3 0.5498340        0
5       2       4 0.6224593        1
6       3       4 0.5744425        1</code></pre>
</div>
</div>
</section>
<section id="example-tournament-simulation-iii" class="slide level2 smaller">
<h2>Example: Tournament Simulation III</h2>
<div class="panel-tabset">
<ul id="tabset-2" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-2-1">Temporary Table</a></li><li><a href="#tabset-2-2">Count Wins</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1">
<ul>
<li>List players &amp; winner of each match</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a></a>tmp_df <span class="ot">&lt;-</span></span>
<span id="cb8-2"><a></a>  design <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(player1, player2) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb8-5"><a></a>    <span class="at">outcome =</span> outcomes,</span>
<span id="cb8-6"><a></a>    <span class="at">winner =</span> <span class="fu">ifelse</span>(outcome <span class="sc">==</span> <span class="dv">1</span>, player1, player2),</span>
<span id="cb8-7"><a></a>    <span class="at">player1 =</span> <span class="fu">factor</span>(player1, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>),</span>
<span id="cb8-8"><a></a>    <span class="at">player2 =</span> <span class="fu">factor</span>(player2, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>),</span>
<span id="cb8-9"><a></a>    <span class="at">winner =</span> <span class="fu">factor</span>(winner, <span class="at">levels =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>))</span>
<span id="cb8-10"><a></a>tmp_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  player1 player2 outcome winner
  &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt; &lt;fct&gt; 
1 1       2             0 2     
2 1       3             1 1     
3 1       4             1 1     
4 2       3             0 3     
5 2       4             1 2     
6 3       4             1 3     </code></pre>
</div>
</div>
</div>
<div id="tabset-2-2">
<ul>
<li>Count wins by grouping on <code>winner</code> &amp; counting occurrences</li>
<li>If one team loses all games, they won’t appear in grouped summary</li>
<li><code>complete</code>: fills in missing combinations</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a></a>wins <span class="ot">&lt;-</span></span>
<span id="cb10-2"><a></a>  tmp_df <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(winner) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">Wins =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb10-5"><a></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Team =</span> winner) <span class="sc">|&gt;</span></span>
<span id="cb10-6"><a></a>  tidyr<span class="sc">::</span><span class="fu">complete</span>(Team, <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">Wins =</span> <span class="dv">0</span>))</span>
<span id="cb10-7"><a></a>wins</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  Team   Wins
  &lt;fct&gt; &lt;int&gt;
1 1         2
2 2         2
3 3         2
4 4         0</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="example-tournament-simulation-iv" class="slide level2 smaller">
<h2>Example: Tournament Simulation IV</h2>
<div class="panel-tabset">
<ul id="tabset-3" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-3-1">Code</a></li><li><a href="#tabset-3-2">Team 1’s Performance</a></li><li><a href="#tabset-3-3">Ranking w/ Ties</a></li><li><a href="#tabset-3-4">Team Rankings</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1">
<ul>
<li>Replay tournament 5000 times</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a></a>n_sims <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb12-2"><a></a>simulated_wins <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data =</span> <span class="cn">NA</span>, <span class="at">nrow =</span> n_sims, <span class="at">ncol =</span> <span class="dv">4</span>)</span>
<span id="cb12-3"><a></a><span class="cf">for</span>(r <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_sims){</span>
<span id="cb12-4"><a></a>  <span class="fu">set.seed</span>(<span class="dv">479</span><span class="sc">+</span>r)</span>
<span id="cb12-5"><a></a>  outcomes <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">6</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> design<span class="sc">$</span>prob)</span>
<span id="cb12-6"><a></a>  wins <span class="ot">&lt;-</span></span>
<span id="cb12-7"><a></a>    design <span class="sc">|&gt;</span></span>
<span id="cb12-8"><a></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(player1, player2) <span class="sc">|&gt;</span></span>
<span id="cb12-9"><a></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb12-10"><a></a>      <span class="at">outcome =</span> outcomes,</span>
<span id="cb12-11"><a></a>      <span class="at">winner =</span> <span class="fu">ifelse</span>(outcome <span class="sc">==</span> <span class="dv">1</span>, player1, player2),</span>
<span id="cb12-12"><a></a>      <span class="at">winner =</span> <span class="fu">factor</span>(winner, <span class="at">levels =</span> <span class="fu">unique</span>(<span class="fu">c</span>(design<span class="sc">$</span>player1, design<span class="sc">$</span>player2)))) <span class="sc">|&gt;</span></span>
<span id="cb12-13"><a></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(winner) <span class="sc">|&gt;</span></span>
<span id="cb12-14"><a></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(<span class="at">Wins =</span> dplyr<span class="sc">::</span><span class="fu">n</span>()) <span class="sc">|&gt;</span></span>
<span id="cb12-15"><a></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="at">Team =</span> winner) <span class="sc">|&gt;</span></span>
<span id="cb12-16"><a></a>  tidyr<span class="sc">::</span><span class="fu">complete</span>(Team, <span class="at">fill =</span> <span class="fu">list</span>(<span class="at">Wins =</span> <span class="dv">0</span>))</span>
<span id="cb12-17"><a></a>  simulated_wins[r,] <span class="ot">&lt;-</span> wins <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">pull</span>(Wins)</span>
<span id="cb12-18"><a></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-2">
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a></a><span class="fu">table</span>(simulated_wins[,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   0    1    2    3 
 163 1105 2198 1534 </code></pre>
</div>
</div>
</div>
<div id="tabset-3-3">
<ul>
<li>We will rank teams by <em>negative</em> number of wins</li>
<li>In case of ties: assign <strong>minimum</strong> possible rank</li>
<li>E.g.: say Teams 1 &amp; 2 won 2 games each and 3 &amp; 4 won 1 game each
<ul>
<li>Teams 1 &amp; 2 tied for 1st and Teams 3 &amp; 4 ties for 3rd</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a></a><span class="fu">rank</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">*</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>,<span class="dv">1</span>), <span class="at">ties.method =</span> <span class="st">"min"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 1 3 3</code></pre>
</div>
</div>
</div>
<div id="tabset-3-4">
<ul>
<li><span class="math inline">\(\mathbb{P}(\textrm{Team 3 is in top-2}) \approx 53.1%\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a></a>simulated_ranks <span class="ot">&lt;-</span></span>
<span id="cb17-2"><a></a>  <span class="fu">t</span>(</span>
<span id="cb17-3"><a></a>    <span class="fu">apply</span>(<span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>simulated_wins, <span class="at">MARGIN =</span> <span class="dv">1</span>,  </span>
<span id="cb17-4"><a></a>        <span class="at">FUN =</span> rank, <span class="at">ties.method =</span> <span class="st">"min"</span>)) </span>
<span id="cb17-5"><a></a> <span class="fu">table</span>(simulated_ranks[,<span class="dv">3</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   1    2    3    4 
1565 1092 1547  796 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a></a> <span class="fu">round</span>(<span class="fu">mean</span>(simulated_ranks[,<span class="dv">3</span>] <span class="sc">&lt;=</span> <span class="dv">2</span>), <span class="at">digits =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.531</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="identifiability" class="slide level2 smaller">
<h2>Identifiability</h2>
<ul>
<li>Basic BT model: <span class="math inline">\(\textrm{P}(i \textrm{beats} j)\)</span> depends only on <strong>difference</strong> <span class="math inline">\(\lambda_{i} - \lambda_{j}\)</span></li>
<li>Probabilities unchanged after constant shift. E.g.: <span class="math inline">\(\lambda_{j} \rightarrow \lambda_{j} + 5\)</span> for all <span class="math inline">\(j\)</span></li>
<li>Practically: we can only estiamtes latent strengths <strong>up to an additive constant</strong></li>
<li>Often we fix one <span class="math inline">\(\lambda_{j} = 0\)</span> (a “reference team”)</li>
</ul>
</section></section>
<section>
<section id="fitting-bt-models" class="title-slide slide level1 center">
<h1>Fitting BT Models</h1>

</section>
<section id="overview" class="slide level2 smaller">
<h2>Overview</h2>
<ul>
<li>Goal: Estimate <span class="math inline">\(\lambda_{j}\)</span>’s for all D1 Women’s Hockey Teams</li>
<li>Requirement: a data table (one row per match) recording
<ul>
<li>Identities of the two teams</li>
<li>Identity of the winner</li>
</ul></li>
<li>Scrape from USCHO website
<ul>
<li>Before 10/6: code on course website worked</li>
<li>After 10/6: USCHO changed their backend (so scraping code won’t work…)</li>
</ul></li>
<li>Will post a complete data table on Canvas</li>
</ul>
</section>
<section id="preview-of-data" class="slide level2">
<h2>Preview of Data</h2>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 10
   Day   Date       Time     Opponent OppScore Home  HomeScore OT    Notes Type 
   &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
 1 Sat.  1/4/2025   1:00 CT  Minneso… 4        Lind… 1         &lt;NA&gt;  &lt;NA&gt;  NC   
 2 Fri.  12/6/2024  6:00 ET  Connect… 2        New … 1         &lt;NA&gt;  &lt;NA&gt;  HE   
 3 Fri.  12/6/2024  6:00 ET  Dartmou… 3        Clar… 5         &lt;NA&gt;  &lt;NA&gt;  EC   
 4 Fri.  11/29/2024 6:00 ET  Colgate  3        Syra… 1         &lt;NA&gt;  &lt;NA&gt;  NC   
 5 Sat.  1/18/2025  3:00 ET  Renssel… 0        Dart… 0         OT    DAR … EC   
 6 Sat.  3/1/2025   4:30 ET  Maine    3        Bost… 4         &lt;NA&gt;  HEA … NC   
 7 Fri.  1/3/2025   7:00 ET  Yale     8        Robe… 1         &lt;NA&gt;  &lt;NA&gt;  NC   
 8 Fri.  11/1/2024  3:00 CT  Minneso… 2        Bemi… 1         &lt;NA&gt;  &lt;NA&gt;  WC   
 9 Fri.  1/10/2025  6:00 ET  St. Law… 4        Union 2         &lt;NA&gt;  &lt;NA&gt;  EC   
10 Sat.  11/16/2024 12:00 ET Vermont  0        Prov… 0         OT    VER … HE   </code></pre>
</div>
</div>
</section>
<section id="data-preparation" class="slide level2 smaller">
<h2>Data Preparation</h2>
<ul>
<li>Appending a column for the winner
<ul>
<li>Most games, <code>HomeScore</code> differs from <code>OppScore</code></li>
<li>Often when <code>HomeScore==OppScore</code>, game decided in shoot out</li>
</ul></li>
<li>To determine winner of shootouts, must parse team name &amp; abbreviation
<ul>
<li>E.g. “WIS” for Wisconsin; “OSU” for Ohio State; etc.</li>
</ul></li>
<li>Add column recording whether home team or away team won</li>
<li>Extract exhibition &amp; tournament games
<ul>
<li>Mostly by parsing the <code>Notes</code> column</li>
</ul></li>
<li>See <a href="../../lectures/lecture12.html#sec-scraping">lecture notes</a> for details</li>
</ul>
</section>
<section id="the-bradleyterry2-package" class="slide level2 smaller">
<h2>The <strong>BradleyTerry2</strong> Package</h2>
<ul>
<li>We will use the <a href="https://github.com/hturner/BradleyTerry2"><strong>BradleyTerry2</strong></a> package</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"hturner/BradleyTerry2"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Package has rather specific syntax, so it’s important to read <a href="https://cran.r-project.org/web/packages/BradleyTerry2/vignettes/BradleyTerry.html">documentation</a></li>
</ul>
<ul>
<li><strong>BradleyTerry2</strong> expects a data table w/
<ul>
<li>Separate row for each home team - away team pair</li>
<li>Two columns recording the number of home &amp; away team wins</li>
</ul></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb23-2"><a></a>results <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(home.team <span class="sc">==</span> <span class="st">"Wisconsin"</span>) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 4
  home.team away.team       home.win away.win
  &lt;fct&gt;     &lt;fct&gt;              &lt;dbl&gt;    &lt;dbl&gt;
1 Wisconsin St. Cloud State        2        0
2 Wisconsin St. Thomas             2        0
3 Wisconsin Minnesota              3        0
4 Wisconsin Ohio State             1        1
5 Wisconsin Lindenwood             2        0</code></pre>
</div>
</div>
</section>
<section id="model-fitting" class="slide level2 smaller">
<h2>Model Fitting</h2>
<div class="panel-tabset">
<ul id="tabset-4" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-4-1">Code</a></li><li><a href="#tabset-4-2">Summary</a></li><li><a href="#tabset-4-3">Extracting <span class="math inline">\(\hat{\lambda}_{j}\)</span>’s</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1">
<ul>
<li><code>BTm</code> allows us to manually specify reference team (w/ <span class="math inline">\(\lambda_{j} = 0\)</span>)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a></a>fit <span class="ot">&lt;-</span></span>
<span id="cb25-2"><a></a>  BradleyTerry2<span class="sc">::</span><span class="fu">BTm</span>(</span>
<span id="cb25-3"><a></a>    <span class="at">outcome =</span> <span class="fu">cbind</span>(home.win, away.win),  </span>
<span id="cb25-4"><a></a>    <span class="at">player1 =</span> home.team, <span class="at">player2 =</span> away.team, </span>
<span id="cb25-5"><a></a>    <span class="at">refcat =</span> <span class="st">"Assumption"</span>, </span>
<span id="cb25-6"><a></a>    <span class="at">data =</span> results) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-4-2">
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
BradleyTerry2::BTm(outcome = cbind(home.win, away.win), player1 = home.team, 
    player2 = away.team, refcat = "Assumption", data = results)

Coefficients:
                    Estimate Std. Error z value Pr(&gt;|z|)    
..Bemidji State       3.8615     1.2828   3.010 0.002610 ** 
..Boston College      5.5371     1.2307   4.499 6.82e-06 ***
..Boston University   5.7866     1.2267   4.717 2.39e-06 ***
..Brown               4.7983     1.2178   3.940 8.14e-05 ***
..Clarkson            5.8522     1.2137   4.822 1.42e-06 ***
..Colgate             6.6950     1.2248   5.466 4.59e-08 ***
..Connecticut         5.7772     1.2293   4.700 2.61e-06 ***
..Cornell             7.2421     1.2586   5.754 8.72e-09 ***
..Dartmouth           3.8239     1.2433   3.076 0.002100 ** 
..Franklin Pierce     0.8259     0.5436   1.519 0.128701    
..Harvard             2.5128     1.3690   1.835 0.066441 .  
..Holy Cross          4.1094     1.2214   3.364 0.000767 ***
..Lindenwood          3.0888     1.2317   2.508 0.012150 *  
..LIU                 1.6854     0.5869   2.872 0.004085 ** 
..Maine               4.2996     1.2360   3.479 0.000504 ***
..Mercyhurst          5.1540     1.2094   4.262 2.03e-05 ***
..Merrimack           3.8888     1.2264   3.171 0.001520 ** 
..Minnesota           7.3462     1.2685   5.791 6.98e-09 ***
..Minnesota Duluth    6.7823     1.2722   5.331 9.75e-08 ***
..Minnesota State     5.2957     1.2725   4.162 3.16e-05 ***
..New Hampshire       4.6625     1.2191   3.824 0.000131 ***
..Northeastern        5.6740     1.2210   4.647 3.37e-06 ***
..Ohio State          7.8472     1.2946   6.061 1.35e-09 ***
..Penn State          6.6326     1.2569   5.277 1.31e-07 ***
..Post                0.3263     0.5404   0.604 0.545921    
..Princeton           5.4717     1.2229   4.474 7.66e-06 ***
..Providence          5.3356     1.2281   4.345 1.40e-05 ***
..Quinnipiac          5.6338     1.2010   4.691 2.72e-06 ***
..Rensselaer          4.3425     1.1913   3.645 0.000267 ***
..RIT                 4.4201     1.2043   3.670 0.000242 ***
..Robert Morris       3.0838     1.1764   2.621 0.008755 ** 
..Sacred Heart        1.3976     0.5531   2.527 0.011504 *  
..St. Anselm          0.7039     0.5387   1.307 0.191287    
..St. Cloud State     5.8507     1.2647   4.626 3.73e-06 ***
..St. Lawrence        5.9259     1.2094   4.900 9.58e-07 ***
..St. Michael's      -1.1317     0.6421  -1.762 0.077987 .  
..St. Thomas          4.6868     1.2861   3.644 0.000268 ***
..Stonehill           0.6387     0.5612   1.138 0.255106    
..Syracuse            4.2144     1.1961   3.523 0.000426 ***
..Union               4.5583     1.2002   3.798 0.000146 ***
..Vermont             4.0937     1.2304   3.327 0.000877 ***
..Wisconsin           9.3418     1.4304   6.531 6.53e-11 ***
..Yale                5.4095     1.2138   4.457 8.32e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 815.15  on 474  degrees of freedom
Residual deviance: 463.44  on 431  degrees of freedom
AIC: 668.78

Number of Fisher Scoring iterations: 6</code></pre>
</div>
</div>
</div>
<div id="tabset-4-3">
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a></a>lambda_hat <span class="ot">&lt;-</span> BradleyTerry2<span class="sc">::</span><span class="fu">BTabilities</span>(fit)</span>
<span id="cb28-2"><a></a>lambda_hat[<span class="fu">c</span>(<span class="st">"Wisconsin"</span>, <span class="st">"Ohio State"</span>, <span class="st">"Cornell"</span>, <span class="st">"Minnesota"</span>),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            ability     s.e.
Wisconsin  9.341843 1.430356
Ohio State 7.847175 1.294598
Cornell    7.242125 1.258623
Minnesota  7.346209 1.268487</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="estimated-team-strengths" class="slide level2">
<h2>Estimated Team Strengths</h2>
<div class="cell">
<div class="cell-output-display">
<div id="fig-lambda-hat-raw" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig">
<div aria-describedby="fig-lambda-hat-raw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="slides_12_files/figure-revealjs/fig-lambda-hat-raw-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Most teams are favored against the reference team (Assumption College)"><img data-src="slides_12_files/figure-revealjs/fig-lambda-hat-raw-1.png" width="768"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lambda-hat-raw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Most teams are favored against the reference team (Assumption College)
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="changing-reference-team" class="slide level2">
<h2>Changing Reference Team</h2>
<div class="panel-tabset">
<ul id="tabset-5" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-5-1">Code</a></li><li><a href="#tabset-5-2">Visualization</a></li></ul>
<div class="tab-content">
<div id="tabset-5-1">
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a></a>fit_nh <span class="ot">&lt;-</span> <span class="fu">update</span>(fit, <span class="at">refcat =</span> <span class="st">"New Hampshire"</span>)</span>
<span id="cb30-2"><a></a>lambda_hat_nh <span class="ot">&lt;-</span> BradleyTerry2<span class="sc">::</span><span class="fu">BTabilities</span>(fit_nh)</span>
<span id="cb30-3"><a></a>lambda_hat_nh[<span class="fu">c</span>(<span class="st">"Assumption"</span>, <span class="st">"New Hampshire"</span>, <span class="st">"Wisconsin"</span>, <span class="st">"Ohio State"</span>),]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                ability      s.e.
Assumption    -4.662547 1.2191462
New Hampshire  0.000000 0.0000000
Wisconsin      4.679297 0.9932217
Ohio State     3.184629 0.7887300</code></pre>
</div>
</div>
</div>
<div id="tabset-5-2">
<div class="cell">
<div class="cell-output-display">
<div id="fig-lambda-hat-nh" class="quarto-float quarto-figure quarto-figure-center">
<figure class="quarto-float quarto-float-fig">
<div aria-describedby="fig-lambda-hat-nh-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="slides_12_files/figure-revealjs/fig-lambda-hat-nh-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;2: Some teams are significantly stronger and some teams are significantly weaker than New Hampshire"><img data-src="slides_12_files/figure-revealjs/fig-lambda-hat-nh-1.png" width="768"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lambda-hat-nh-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Some teams are significantly stronger and some teams are significantly weaker than New Hampshire
</figcaption>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
</section></section>
<section>
<section id="best-of-5" class="title-slide slide level1 center">
<h1>Best-of-5?</h1>

</section>
<section id="ncaa-d1-championship" class="slide level2">
<h2>NCAA D1 Championship</h2>
<ul>
<li>Currently, championship decided w/ a single game
<ul>
<li>2024-25: WIS defeated OSU in overtime</li>
</ul></li>
<li>According to our model, WIS would win 81% of the time</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a></a><span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> (lambda_hat[<span class="st">"Wisconsin"</span>, <span class="st">"ability"</span>] <span class="sc">-</span> lambda_hat[<span class="st">"Ohio State"</span>, <span class="st">"ability"</span>])))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8167779</code></pre>
</div>
</div>
<ul>
<li>What if NCAA moved to a best-of-5 series?</li>
</ul>
</section>
<section id="simulating-series-once" class="slide level2 smaller">
<h2>Simulating Series Once</h2>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-5"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy"><code class="sourceCode r"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1"></a>wi_wins <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2"></a>osu_wins <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3"></a></span>
<span id="annotated-cell-5-4"><a href="#annotated-cell-5-4"></a>wi_prob <span class="ot">&lt;-</span> </span>
<span id="annotated-cell-5-5"><a href="#annotated-cell-5-5"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> (lambda_hat[<span class="st">"Wisconsin"</span>, <span class="st">"ability"</span>] <span class="sc">-</span> lambda_hat[<span class="st">"Ohio State"</span>, <span class="st">"ability"</span>])))</span>
<span id="annotated-cell-5-6"><a href="#annotated-cell-5-6"></a></span>
<span id="annotated-cell-5-7"><a href="#annotated-cell-5-7"></a>game_counter <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="annotated-cell-5-8"><a href="#annotated-cell-5-8"></a>outcomes <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="at">times=</span> <span class="dv">5</span>)</span>
<span id="annotated-cell-5-9"><a href="#annotated-cell-5-9"></a><span class="fu">set.seed</span>(<span class="dv">481</span>)</span>
<span id="annotated-cell-5-10"><a href="#annotated-cell-5-10"></a><span class="cf">while</span>( wi_wins  <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> osu_wins <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> game_counter <span class="sc">&lt;</span> <span class="dv">5</span>){ </span>
<span id="annotated-cell-5-11"><a href="#annotated-cell-5-11"></a>  game_counter <span class="ot">&lt;-</span> game_counter <span class="sc">+</span> <span class="dv">1</span></span>
<span id="annotated-cell-5-12"><a href="#annotated-cell-5-12"></a>  outcomes[game_counter] <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> wi_prob) </span>
<span id="annotated-cell-5-13"><a href="#annotated-cell-5-13"></a>  </span>
<span id="annotated-cell-5-14"><a href="#annotated-cell-5-14"></a>  <span class="cf">if</span>(outcomes[game_counter] <span class="sc">==</span> <span class="dv">1</span>) wi_wins <span class="ot">&lt;-</span> wi_wins <span class="sc">+</span> <span class="dv">1</span> </span>
<span id="annotated-cell-5-15"><a href="#annotated-cell-5-15"></a>  <span class="cf">else</span> <span class="cf">if</span>(outcomes[game_counter] <span class="sc">==</span> <span class="dv">0</span>) osu_wins <span class="ot">&lt;-</span> osu_wins <span class="sc">+</span> <span class="dv">1</span> </span>
<span id="annotated-cell-5-16"><a href="#annotated-cell-5-16"></a></span>
<span id="annotated-cell-5-17"><a href="#annotated-cell-5-17"></a>}</span>
<span id="annotated-cell-5-18"><a href="#annotated-cell-5-18"></a><span class="cf">if</span>(wi_wins <span class="sc">==</span> <span class="dv">3</span>){ </span>
<span id="annotated-cell-5-19"><a href="#annotated-cell-5-19"></a>  winner <span class="ot">&lt;-</span> <span class="st">"Wisconsin"</span></span>
<span id="annotated-cell-5-20"><a href="#annotated-cell-5-20"></a>} <span class="cf">else</span> <span class="cf">if</span>(osu_wins <span class="sc">==</span> <span class="dv">3</span>){</span>
<span id="annotated-cell-5-21"><a href="#annotated-cell-5-21"></a>  winner <span class="ot">&lt;-</span> <span class="st">"Ohio State"</span></span>
<span id="annotated-cell-5-22"><a href="#annotated-cell-5-22"></a>} <span class="cf">else</span>{</span>
<span id="annotated-cell-5-23"><a href="#annotated-cell-5-23"></a>  winner <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="annotated-cell-5-24"><a href="#annotated-cell-5-24"></a>}</span>
<span id="annotated-cell-5-25"><a href="#annotated-cell-5-25"></a> </span>
<span id="annotated-cell-5-26"><a href="#annotated-cell-5-26"></a><span class="fu">cat</span>(<span class="st">"Series ended after"</span>, game_counter, <span class="st">" games. Winner = "</span>, winner, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="annotated-cell-5-27"><a href="#annotated-cell-5-27"></a><span class="fu">cat</span>(<span class="st">"Wisconsin: "</span>, wi_wins, <span class="st">" Ohio State: "</span>, osu_wins, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="annotated-cell-5-28"><a href="#annotated-cell-5-28"></a><span class="fu">cat</span>(<span class="st">"Game results:"</span>, outcomes, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Series ended after 4  games. Winner =  Wisconsin 
Wisconsin:  3  Ohio State:  1 
Game results: 1 1 0 1 NA </code></pre>
</div>
</div>
</section>
<section id="repeated-simulations" class="slide level2 smaller">
<h2>Repeated Simulations</h2>
<ul>
<li>Repeating the simulation 5,000 times (each time w/ different seed)
<ul>
<li>WIS won series ~95% of the time</li>
<li>Series ended in 3 games about 55% of the time</li>
<li>Series went to 5 games about 13% of the time</li>
</ul></li>
</ul>
</section>
<section id="looking-ahead" class="slide level2">
<h2>Looking Ahead</h2>
<ul>
<li>Basic BT model does not account for home-team advantage</li>
<li><a href="../../lectures/lecture13.html">Lecture 13</a>: simulate entire Frozen 4</li>
</ul>


</section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
            const codeEl = trigger.previousElementSibling.cloneNode(true);
            for (const childEl of codeEl.children) {
              if (isCodeAnnotation(childEl)) {
                childEl.remove();
              }
            }
            return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
            let selectedAnnoteEl;
            const selectorForAnnotation = ( cell, annotation) => {
              let cellAttr = 'data-code-cell="' + cell + '"';
              let lineAttr = 'data-code-annotation="' +  annotation + '"';
              const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
              return selector;
            }
            const selectCodeLines = (annoteEl) => {
              const doc = window.document;
              const targetCell = annoteEl.getAttribute("data-target-cell");
              const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
              const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
              const lines = annoteSpan.getAttribute("data-code-lines").split(",");
              const lineIds = lines.map((line) => {
                return targetCell + "-" + line;
              })
              let top = null;
              let height = null;
              let parent = null;
              if (lineIds.length > 0) {
                  //compute the position of the single el (top and bottom and make a div)
                  const el = window.document.getElementById(lineIds[0]);
                  top = el.offsetTop;
                  height = el.offsetHeight;
                  parent = el.parentElement.parentElement;
                if (lineIds.length > 1) {
                  const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
                  const bottom = lastEl.offsetTop + lastEl.offsetHeight;
                  height = bottom - top;
                }
                if (top !== null && height !== null && parent !== null) {
                  // cook up a div (if necessary) and position it 
                  let div = window.document.getElementById("code-annotation-line-highlight");
                  if (div === null) {
                    div = window.document.createElement("div");
                    div.setAttribute("id", "code-annotation-line-highlight");
                    div.style.position = 'absolute';
                    parent.appendChild(div);
                  }
                  div.style.top = top - 2 + "px";
                  div.style.height = height + 4 + "px";
                  div.style.left = 0;
                  let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
                  if (gutterDiv === null) {
                    gutterDiv = window.document.createElement("div");
                    gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                    gutterDiv.style.position = 'absolute';
                    const codeCell = window.document.getElementById(targetCell);
                    const gutter = codeCell.querySelector('.code-annotation-gutter');
                    gutter.appendChild(gutterDiv);
                  }
                  gutterDiv.style.top = top - 2 + "px";
                  gutterDiv.style.height = height + 4 + "px";
                }
                selectedAnnoteEl = annoteEl;
              }
            };
            const unselectCodeLines = () => {
              const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
              elementsIds.forEach((elId) => {
                const div = window.document.getElementById(elId);
                if (div) {
                  div.remove();
                }
              });
              selectedAnnoteEl = undefined;
            };
              // Handle positioning of the toggle
          window.addEventListener(
            "resize",
            throttle(() => {
              elRect = undefined;
              if (selectedAnnoteEl) {
                selectCodeLines(selectedAnnoteEl);
              }
            }, 10)
          );
          function throttle(fn, ms) {
          let throttle = false;
          let timer;
            return (...args) => {
              if(!throttle) { // first call gets through
                  fn.apply(this, args);
                  throttle = true;
              } else { // all the others get throttled
                  if(timer) clearTimeout(timer); // cancel #2
                  timer = setTimeout(() => {
                    fn.apply(this, args);
                    timer = throttle = false;
                  }, ms);
              }
            };
          }
            const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
            for (let i=0; i<annoteTargets.length; i++) {
              const annoteTarget = annoteTargets[i];
              const targetCell = annoteTarget.getAttribute("data-target-cell");
              const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
              const contentFn = () => {
                const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
                if (content) {
                  const tipContent = content.cloneNode(true);
                  tipContent.classList.add("code-annotation-tip-content");
                  return tipContent.outerHTML;
                }
              }
              const config = {
                allowHTML: true,
                content: contentFn,
                onShow: (instance) => {
                  selectCodeLines(instance.reference);
                  instance.reference.classList.add('code-annotation-active');
                  window.tippy.hideAll();
                },
                onHide: (instance) => {
                  unselectCodeLines();
                  instance.reference.classList.remove('code-annotation-active');
                },
                maxWidth: 300,
                delay: [50, 0],
                duration: [200, 0],
                offset: [5, 10],
                arrow: true,
                appendTo: function(el) {
                  return el.parentElement.parentElement.parentElement;
                },
                interactive: true,
                interactiveBorder: 10,
                theme: 'light-border',
                placement: 'right',
                popperOptions: {
                  modifiers: [
                  {
                    name: 'flip',
                    options: {
                      flipVariations: false, // true by default
                      allowedAutoPlacements: ['right'],
                      fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                    },
                  },
                  {
                    name: 'preventOverflow',
                    options: {
                      mainAxis: false,
                      altAxis: false
                    }
                  }
                  ]        
                }      
              };
              window.tippy(annoteTarget, config); 
            }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    <script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
    (function() {
      let previousOnload = window.onload;
      window.onload = () => {
        if (previousOnload) {
          previousOnload();
        }
        lightboxQuarto.on('slide_before_load', (data) => {
          const { slideIndex, slideNode, slideConfig, player, trigger } = data;
          const href = trigger.getAttribute('href');
          if (href !== null) {
            const imgEl = window.document.querySelector(`a[href="${href}"] img`);
            if (imgEl !== null) {
              const srcAttr = imgEl.getAttribute("src");
              if (srcAttr && srcAttr.startsWith("data:")) {
                slideConfig.href = srcAttr;
              }
            }
          } 
        });
      
        lightboxQuarto.on('slide_after_load', (data) => {
          const { slideIndex, slideNode, slideConfig, player, trigger } = data;
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(slideNode);
          }
        });
      
      };
      
    })();
              </script>
    

</body></html>